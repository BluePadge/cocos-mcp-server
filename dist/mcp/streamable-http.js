"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.StreamableHttpManager = void 0;
const crypto_1 = require("crypto");
const DEFAULT_OPTIONS = {
    heartbeatMs: 15000
};
class StreamableHttpManager {
    constructor(options) {
        this.sessionConnections = new Map();
        this.options = Object.assign(Object.assign({}, DEFAULT_OPTIONS), options);
    }
    openSseStream(sessionId, req, res) {
        var _a;
        const connectionId = (0, crypto_1.randomUUID)();
        res.statusCode = 200;
        res.setHeader('Content-Type', 'text/event-stream; charset=utf-8');
        res.setHeader('Cache-Control', 'no-cache, no-transform');
        res.setHeader('Connection', 'keep-alive');
        res.setHeader('X-Accel-Buffering', 'no');
        (_a = res.flushHeaders) === null || _a === void 0 ? void 0 : _a.call(res);
        const heartbeatTimer = setInterval(() => {
            if (!res.writableEnded) {
                res.write(': heartbeat\n\n');
            }
        }, this.options.heartbeatMs);
        const connection = {
            connectionId,
            res,
            heartbeatTimer
        };
        const connections = this.getOrCreateConnections(sessionId);
        connections.set(connectionId, connection);
        res.write(`event: ready\ndata: ${JSON.stringify({ sessionId, connectionId })}\n\n`);
        const closeHandler = () => {
            this.closeConnection(sessionId, connectionId);
        };
        req.on('close', closeHandler);
        res.on('close', closeHandler);
        res.on('finish', closeHandler);
        res.on('error', closeHandler);
        return connectionId;
    }
    sendJsonRpcMessage(sessionId, payload) {
        const connections = this.sessionConnections.get(sessionId);
        if (!connections || connections.size === 0) {
            return;
        }
        const data = JSON.stringify(payload);
        const packet = this.buildSsePacket('message', data);
        for (const connection of connections.values()) {
            if (connection.res.writableEnded) {
                this.closeConnection(sessionId, connection.connectionId);
                continue;
            }
            connection.res.write(packet);
        }
    }
    getSessionConnectionCount(sessionId) {
        var _a, _b;
        return (_b = (_a = this.sessionConnections.get(sessionId)) === null || _a === void 0 ? void 0 : _a.size) !== null && _b !== void 0 ? _b : 0;
    }
    closeSession(sessionId) {
        const connections = this.sessionConnections.get(sessionId);
        if (!connections) {
            return;
        }
        for (const connection of connections.values()) {
            clearInterval(connection.heartbeatTimer);
            if (!connection.res.writableEnded) {
                connection.res.end();
            }
        }
        this.sessionConnections.delete(sessionId);
    }
    dispose() {
        for (const sessionId of this.sessionConnections.keys()) {
            this.closeSession(sessionId);
        }
    }
    closeConnection(sessionId, connectionId) {
        const connections = this.sessionConnections.get(sessionId);
        if (!connections) {
            return;
        }
        const connection = connections.get(connectionId);
        if (!connection) {
            return;
        }
        clearInterval(connection.heartbeatTimer);
        connections.delete(connectionId);
        if (connections.size === 0) {
            this.sessionConnections.delete(sessionId);
        }
    }
    getOrCreateConnections(sessionId) {
        const existing = this.sessionConnections.get(sessionId);
        if (existing) {
            return existing;
        }
        const created = new Map();
        this.sessionConnections.set(sessionId, created);
        return created;
    }
    buildSsePacket(eventName, data) {
        const lines = data.split('\n');
        const dataLines = lines.map((line) => `data: ${line}`).join('\n');
        return `event: ${eventName}\n${dataLines}\n\n`;
    }
}
exports.StreamableHttpManager = StreamableHttpManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyZWFtYWJsZS1odHRwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc291cmNlL21jcC9zdHJlYW1hYmxlLWh0dHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsbUNBQW9DO0FBWXBDLE1BQU0sZUFBZSxHQUEwQjtJQUMzQyxXQUFXLEVBQUUsS0FBSztDQUNyQixDQUFDO0FBRUYsTUFBYSxxQkFBcUI7SUFJOUIsWUFBWSxPQUF3QztRQUZuQyx1QkFBa0IsR0FBRyxJQUFJLEdBQUcsRUFBeUMsQ0FBQztRQUduRixJQUFJLENBQUMsT0FBTyxtQ0FDTCxlQUFlLEdBQ2YsT0FBTyxDQUNiLENBQUM7SUFDTixDQUFDO0lBRU0sYUFBYSxDQUFDLFNBQWlCLEVBQUUsR0FBeUIsRUFBRSxHQUF3Qjs7UUFDdkYsTUFBTSxZQUFZLEdBQUcsSUFBQSxtQkFBVSxHQUFFLENBQUM7UUFFbEMsR0FBRyxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUM7UUFDckIsR0FBRyxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsa0NBQWtDLENBQUMsQ0FBQztRQUNsRSxHQUFHLENBQUMsU0FBUyxDQUFDLGVBQWUsRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO1FBQ3pELEdBQUcsQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQzFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDekMsTUFBQSxHQUFHLENBQUMsWUFBWSxtREFBSSxDQUFDO1FBRXJCLE1BQU0sY0FBYyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUU7WUFDcEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQztnQkFDckIsR0FBRyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1lBQ2pDLENBQUM7UUFDTCxDQUFDLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUU3QixNQUFN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QyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNsRSxPQUFPLFVBQVUsU0FBUyxLQUFLLFNBQVMsTUFBTSxDQUFDO0lBQ25ELENBQUM7Q0FDSjtBQWxJRCxzREFrSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBodHRwIGZyb20gJ2h0dHAnO1xuaW1wb3J0IHsgcmFuZG9tVVVJRCB9IGZyb20gJ2NyeXB0byc7XG5cbmludGVyZmFjZSBTdHJlYW1Db25uZWN0aW9uIHtcbiAgICBjb25uZWN0aW9uSWQ6IHN0cmluZztcbiAgICByZXM6IGh0dHAuU2VydmVyUmVzcG9uc2U7XG4gICAgaGVhcnRiZWF0VGltZXI6IE5vZGVKUy5UaW1lb3V0O1xufVxuXG5pbnRlcmZhY2UgU3RyZWFtYWJsZUh0dHBPcHRpb25zIHtcbiAgICBoZWFydGJlYXRNczogbnVtYmVyO1xufVxuXG5jb25zdCBERUZBVUxUX09QVElPTlM6IFN0cmVhbWFibGVIdHRwT3B0aW9ucyA9IHtcbiAgICBoZWFydGJlYXRNczogMTUwMDBcbn07XG5cbmV4cG9ydCBjbGFzcyBTdHJlYW1hYmxlSHR0cE1hbmFnZXIge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgb3B0aW9uczogU3RyZWFtYWJsZUh0dHBPcHRpb25zO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgc2Vzc2lvbkNvbm5lY3Rpb25zID0gbmV3IE1hcDxzdHJpbmcsIE1hcDxzdHJpbmcsIFN0cmVhbUNvbm5lY3Rpb24+PigpO1xuXG4gICAgY29uc3RydWN0b3Iob3B0aW9ucz86IFBhcnRpYWw8U3RyZWFtYWJsZUh0dHBPcHRpb25zPikge1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSB7XG4gICAgICAgICAgICAuLi5ERUZBVUxUX09QVElPTlMsXG4gICAgICAgICAgICAuLi5vcHRpb25zXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHVibGljIG9wZW5Tc2VTdHJlYW0oc2Vzc2lvbklkOiBzdHJpbmcsIHJlcTogaHR0cC5JbmNvbWluZ01lc3NhZ2UsIHJlczogaHR0cC5TZXJ2ZXJSZXNwb25zZSk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25JZCA9IHJhbmRvbVVVSUQoKTtcblxuICAgICAgICByZXMuc3RhdHVzQ29kZSA9IDIwMDtcbiAgICAgICAgcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ3RleHQvZXZlbnQtc3RyZWFtOyBjaGFyc2V0PXV0Zi04Jyk7XG4gICAgICAgIHJlcy5zZXRIZWFkZXIoJ0NhY2hlLUNvbnRyb2wnLCAnbm8tY2FjaGUsIG5vLXRyYW5zZm9ybScpO1xuICAgICAgICByZXMuc2V0SGVhZGVyKCdDb25uZWN0aW9uJywgJ2tlZXAtYWxpdmUnKTtcbiAgICAgICAgcmVzLnNldEhlYWRlcignWC1BY2NlbC1CdWZmZXJpbmcnLCAnbm8nKTtcbiAgICAgICAgcmVzLmZsdXNoSGVhZGVycz8uKCk7XG5cbiAgICAgICAgY29uc3QgaGVhcnRiZWF0VGltZXIgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXJlcy53cml0YWJsZUVuZGVkKSB7XG4gICAgICAgICAgICAgICAgcmVzLndyaXRlKCc6IGhlYXJ0YmVhdFxcblxcbicpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LCB0aGlzLm9wdGlvbnMuaGVhcnRiZWF0TXMpO1xuXG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb246IFN0cmVhbUNvbm5lY3Rpb24gPSB7XG4gICAgICAgICAgICBjb25uZWN0aW9uSWQsXG4gICAgICAgICAgICByZXMsXG4gICAgICAgICAgICBoZWFydGJlYXRUaW1lclxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25zID0gdGhpcy5nZXRPckNyZWF0ZUNvbm5lY3Rpb25zKHNlc3Npb25JZCk7XG4gICAgICAgIGNvbm5lY3Rpb25zLnNldChjb25uZWN0aW9uSWQsIGNvbm5lY3Rpb24pO1xuXG4gICAgICAgIHJlcy53cml0ZShgZXZlbnQ6IHJlYWR5XFxuZGF0YTogJHtKU09OLnN0cmluZ2lmeSh7IHNlc3Npb25JZCwgY29ubmVjdGlvbklkIH0pfVxcblxcbmApO1xuXG4gICAgICAgIGNvbnN0IGNsb3NlSGFuZGxlciA9ICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuY2xvc2VDb25uZWN0aW9uKHNlc3Npb25JZCwgY29ubmVjdGlvbklkKTtcbiAgICAgICAgfTtcblxuICAgICAgICByZXEub24oJ2Nsb3NlJywgY2xvc2VIYW5kbGVyKTtcbiAgICAgICAgcmVzLm9uKCdjbG9zZScsIGNsb3NlSGFuZGxlcik7XG4gICAgICAgIHJlcy5vbignZmluaXNoJywgY2xvc2VIYW5kbGVyKTtcbiAgICAgICAgcmVzLm9uKCdlcnJvcicsIGNsb3NlSGFuZGxlcik7XG5cbiAgICAgICAgcmV0dXJuIGNvbm5lY3Rpb25JZDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2VuZEpzb25ScGNNZXNzYWdlKHNlc3Npb25JZDogc3RyaW5nLCBwYXlsb2FkOiB1bmtub3duKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25zID0gdGhpcy5zZXNzaW9uQ29ubmVjdGlvbnMuZ2V0KHNlc3Npb25JZCk7XG4gICAgICAgIGlmICghY29ubmVjdGlvbnMgfHwgY29ubmVjdGlvbnMuc2l6ZSA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGF0YSA9IEpTT04uc3RyaW5naWZ5KHBheWxvYWQpO1xuICAgICAgICBjb25zdCBwYWNrZXQgPSB0aGlzLmJ1aWxkU3NlUGFja2V0KCdtZXNzYWdlJywgZGF0YSk7XG5cbiAgICAgICAgZm9yIChjb25zdCBjb25uZWN0aW9uIG9mIGNvbm5lY3Rpb25zLnZhbHVlcygpKSB7XG4gICAgICAgICAgICBpZiAoY29ubmVjdGlvbi5yZXMud3JpdGFibGVFbmRlZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VDb25uZWN0aW9uKHNlc3Npb25JZCwgY29ubmVjdGlvbi5jb25uZWN0aW9uSWQpO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25uZWN0aW9uLnJlcy53cml0ZShwYWNrZXQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldFNlc3Npb25Db25uZWN0aW9uQ291bnQoc2Vzc2lvbklkOiBzdHJpbmcpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5zZXNzaW9uQ29ubmVjdGlvbnMuZ2V0KHNlc3Npb25JZCk/LnNpemUgPz8gMDtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2xvc2VTZXNzaW9uKHNlc3Npb25JZDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25zID0gdGhpcy5zZXNzaW9uQ29ubmVjdGlvbnMuZ2V0KHNlc3Npb25JZCk7XG4gICAgICAgIGlmICghY29ubmVjdGlvbnMpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAoY29uc3QgY29ubmVjdGlvbiBvZiBjb25uZWN0aW9ucy52YWx1ZXMoKSkge1xuICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChjb25uZWN0aW9uLmhlYXJ0YmVhdFRpbWVyKTtcbiAgICAgICAgICAgIGlmICghY29ubmVjdGlvbi5yZXMud3JpdGFibGVFbmRlZCkge1xuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24ucmVzLmVuZCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXNzaW9uQ29ubmVjdGlvbnMuZGVsZXRlKHNlc3Npb25JZCk7XG4gICAgfVxuXG4gICAgcHVibGljIGRpc3Bvc2UoKTogdm9pZCB7XG4gICAgICAgIGZvciAoY29uc3Qgc2Vzc2lvbklkIG9mIHRoaXMuc2Vzc2lvbkNvbm5lY3Rpb25zLmtleXMoKSkge1xuICAgICAgICAgICAgdGhpcy5jbG9zZVNlc3Npb24oc2Vzc2lvbklkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgY2xvc2VDb25uZWN0aW9uKHNlc3Npb25JZDogc3RyaW5nLCBjb25uZWN0aW9uSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb25uZWN0aW9ucyA9IHRoaXMuc2Vzc2lvbkNvbm5lY3Rpb25zLmdldChzZXNzaW9uSWQpO1xuICAgICAgICBpZiAoIWNvbm5lY3Rpb25zKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjb25uZWN0aW9uID0gY29ubmVjdGlvbnMuZ2V0KGNvbm5lY3Rpb25JZCk7XG4gICAgICAgIGlmICghY29ubmVjdGlvbikge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY2xlYXJJbnRlcnZhbChjb25uZWN0aW9uLmhlYXJ0YmVhdFRpbWVyKTtcbiAgICAgICAgY29ubmVjdGlvbnMuZGVsZXRlKGNvbm5lY3Rpb25JZCk7XG5cbiAgICAgICAgaWYgKGNvbm5lY3Rpb25zLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMuc2Vzc2lvbkNvbm5lY3Rpb25zLmRlbGV0ZShzZXNzaW9uSWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRPckNyZWF0ZUNvbm5lY3Rpb25zKHNlc3Npb25JZDogc3RyaW5nKTogTWFwPHN0cmluZywgU3RyZWFtQ29ubmVjdGlvbj4ge1xuICAgICAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuc2Vzc2lvbkNvbm5lY3Rpb25zLmdldChzZXNzaW9uSWQpO1xuICAgICAgICBpZiAoZXhpc3RpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiBleGlzdGluZztcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNyZWF0ZWQgPSBuZXcgTWFwPHN0cmluZywgU3RyZWFtQ29ubmVjdGlvbj4oKTtcbiAgICAgICAgdGhpcy5zZXNzaW9uQ29ubmVjdGlvbnMuc2V0KHNlc3Npb25JZCwgY3JlYXRlZCk7XG4gICAgICAgIHJldHVybiBjcmVhdGVkO1xuICAgIH1cblxuICAgIHByaXZhdGUgYnVpbGRTc2VQYWNrZXQoZXZlbnROYW1lOiBzdHJpbmcsIGRhdGE6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IGxpbmVzID0gZGF0YS5zcGxpdCgnXFxuJyk7XG4gICAgICAgIGNvbnN0IGRhdGFMaW5lcyA9IGxpbmVzLm1hcCgobGluZSkgPT4gYGRhdGE6ICR7bGluZX1gKS5qb2luKCdcXG4nKTtcbiAgICAgICAgcmV0dXJuIGBldmVudDogJHtldmVudE5hbWV9XFxuJHtkYXRhTGluZXN9XFxuXFxuYDtcbiAgICB9XG59XG4iXX0=