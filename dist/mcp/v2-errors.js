"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.V2BusinessErrorException = exports.V2_ERROR_CODES = void 0;
exports.createBusinessError = createBusinessError;
exports.toBusinessError = toBusinessError;
exports.V2_ERROR_CODES = {
    INVALID_ARGUMENT: 'E_INVALID_ARGUMENT',
    NOT_FOUND: 'E_NOT_FOUND',
    CONFLICT: 'E_CONFLICT',
    PRECONDITION_FAILED: 'E_PRECONDITION_FAILED',
    TIMEOUT: 'E_TIMEOUT',
    INTERNAL: 'E_INTERNAL',
    UNAVAILABLE: 'E_UNAVAILABLE'
};
class V2BusinessErrorException extends Error {
    constructor(error) {
        super(error.message);
        this.businessError = error;
        this.name = 'V2BusinessErrorException';
    }
}
exports.V2BusinessErrorException = V2BusinessErrorException;
function createBusinessError(code, message, options = {}) {
    var _a;
    return {
        code,
        message,
        details: options.details,
        suggestion: options.suggestion,
        retryable: (_a = options.retryable) !== null && _a !== void 0 ? _a : false,
        stage: options.stage
    };
}
function toBusinessError(error) {
    var _a, _b;
    if (error instanceof V2BusinessErrorException) {
        return error.businessError;
    }
    const message = String((_b = (_a = error === null || error === void 0 ? void 0 : error.message) !== null && _a !== void 0 ? _a : error) !== null && _b !== void 0 ? _b : 'Unknown error');
    const normalized = message.toLowerCase();
    if (normalized.includes('timeout') || normalized.includes('超时')) {
        return createBusinessError(exports.V2_ERROR_CODES.TIMEOUT, message, { retryable: true });
    }
    if (normalized.includes('not found')
        || normalized.includes('不存在')
        || normalized.includes('invalid mcp-session-id')) {
        return createBusinessError(exports.V2_ERROR_CODES.NOT_FOUND, message, { retryable: false });
    }
    if (normalized.includes('conflict') || normalized.includes('冲突') || normalized.includes('already exists')) {
        return createBusinessError(exports.V2_ERROR_CODES.CONFLICT, message, { retryable: false });
    }
    if (normalized.includes('precondition')
        || normalized.includes('session is not ready')
        || normalized.includes('前置')) {
        return createBusinessError(exports.V2_ERROR_CODES.PRECONDITION_FAILED, message, { retryable: false });
    }
    if (normalized.includes('unavailable') || normalized.includes('不可用') || normalized.includes('not running')) {
        return createBusinessError(exports.V2_ERROR_CODES.UNAVAILABLE, message, { retryable: true });
    }
    return createBusinessError(exports.V2_ERROR_CODES.INTERNAL, message, { retryable: false });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidjItZXJyb3JzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc291cmNlL21jcC92Mi1lcnJvcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBc0JBLGtEQWtCQztBQUVELDBDQXFDQztBQTdFWSxRQUFBLGNBQWMsR0FBRztJQUMxQixnQkFBZ0IsRUFBRSxvQkFBb0I7SUFDdEMsU0FBUyxFQUFFLGFBQWE7SUFDeEIsUUFBUSxFQUFFLFlBQVk7SUFDdEIsbUJBQW1CLEVBQUUsdUJBQXVCO0lBQzVDLE9BQU8sRUFBRSxXQUFXO0lBQ3BCLFFBQVEsRUFBRSxZQUFZO0lBQ3RCLFdBQVcsRUFBRSxlQUFlO0NBQ3RCLENBQUM7QUFFWCxNQUFhLHdCQUF5QixTQUFRLEtBQUs7SUFHL0MsWUFBWSxLQUFzQjtRQUM5QixLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDO1FBQzNCLElBQUksQ0FBQyxJQUFJLEdBQUcsMEJBQTBCLENBQUM7SUFDM0MsQ0FBQztDQUNKO0FBUkQsNERBUUM7QUFFRCxTQUFnQixtQkFBbUIsQ0FDL0IsSUFBWSxFQUNaLE9BQWUsRUFDZixVQUtJLEVBQUU7O0lBRU4sT0FBTztRQUNILElBQUk7UUFDSixPQUFPO1FBQ1AsT0FBTyxFQUFFLE9BQU8sQ0FBQyxPQUFPO1FBQ3hCLFVBQVUsRUFBRSxPQUFPLENBQUMsVUFBVTtRQUM5QixTQUFTLEVBQUUsTUFBQSxPQUFPLENBQUMsU0FBUyxtQ0FBSSxLQUFLO1FBQ3JDLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSztLQUN2QixDQUFDO0FBQ04sQ0FBQztBQUVELFNBQWdCLGVBQWUsQ0FBQyxLQUFjOztJQUMxQyxJQUFJLEtBQUssWUFBWSx3QkFBd0IsRUFBRSxDQUFDO1FBQzVDLE9BQU8sS0FBSyxDQUFDLGFBQWEsQ0FBQztJQUMvQixDQUFDO0lBRUQsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLE1BQUEsTUFBQyxLQUFhLGFBQWIsS0FBSyx1QkFBTCxLQUFLLENBQVUsT0FBTyxtQ0FBSSxLQUFLLG1DQUFJLGVBQWUsQ0FBQyxDQUFDO0lBQzVFLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUV6QyxJQUFJLFVBQVUsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLElBQUksVUFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1FBQzlELE9BQU8sbUJBQW1CLENBQUMsc0JBQWMsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7SUFDckYsQ0FBQztJQUVELElBQ0ksVUFBVSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUM7V0FDN0IsVUFBVSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUM7V0FDMUIsVUFBVSxDQUFDLFFBQVEsQ0FBQyx3QkFBd0IsQ0FBQyxFQUNsRCxDQUFDO1FBQ0MsT0FBTyxtQkFBbUIsQ0FBQyxzQkFBYyxDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUN4RixDQUFDO0lBRUQsSUFBSSxVQUFVLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksVUFBVSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLENBQUM7UUFDeEcsT0FBTyxtQkFBbUIsQ0FBQyxzQkFBYyxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUN2RixDQUFDO0lBRUQsSUFDSSxVQUFVLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQztXQUNoQyxVQUFVLENBQUMsUUFBUSxDQUFDLHNCQUFzQixDQUFDO1dBQzNDLFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQzlCLENBQUM7UUFDQyxPQUFPLG1CQUFtQixDQUFDLHNCQUFjLENBQUMsbUJBQW1CLEVBQUUsT0FBTyxFQUFFLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDbEcsQ0FBQztJQUVELElBQUksVUFBVSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsSUFBSSxVQUFVLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLFVBQVUsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQztRQUN6RyxPQUFPLG1CQUFtQixDQUFDLHNCQUFjLENBQUMsV0FBVyxFQUFFLE9BQU8sRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ3pGLENBQUM7SUFFRCxPQUFPLG1CQUFtQixDQUFDLHNCQUFjLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0FBQ3ZGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBWMkJ1c2luZXNzRXJyb3IgfSBmcm9tICcuL3YyLW1vZGVscyc7XG5cbmV4cG9ydCBjb25zdCBWMl9FUlJPUl9DT0RFUyA9IHtcbiAgICBJTlZBTElEX0FSR1VNRU5UOiAnRV9JTlZBTElEX0FSR1VNRU5UJyxcbiAgICBOT1RfRk9VTkQ6ICdFX05PVF9GT1VORCcsXG4gICAgQ09ORkxJQ1Q6ICdFX0NPTkZMSUNUJyxcbiAgICBQUkVDT05ESVRJT05fRkFJTEVEOiAnRV9QUkVDT05ESVRJT05fRkFJTEVEJyxcbiAgICBUSU1FT1VUOiAnRV9USU1FT1VUJyxcbiAgICBJTlRFUk5BTDogJ0VfSU5URVJOQUwnLFxuICAgIFVOQVZBSUxBQkxFOiAnRV9VTkFWQUlMQUJMRSdcbn0gYXMgY29uc3Q7XG5cbmV4cG9ydCBjbGFzcyBWMkJ1c2luZXNzRXJyb3JFeGNlcHRpb24gZXh0ZW5kcyBFcnJvciB7XG4gICAgcHVibGljIHJlYWRvbmx5IGJ1c2luZXNzRXJyb3I6IFYyQnVzaW5lc3NFcnJvcjtcblxuICAgIGNvbnN0cnVjdG9yKGVycm9yOiBWMkJ1c2luZXNzRXJyb3IpIHtcbiAgICAgICAgc3VwZXIoZXJyb3IubWVzc2FnZSk7XG4gICAgICAgIHRoaXMuYnVzaW5lc3NFcnJvciA9IGVycm9yO1xuICAgICAgICB0aGlzLm5hbWUgPSAnVjJCdXNpbmVzc0Vycm9yRXhjZXB0aW9uJztcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVCdXNpbmVzc0Vycm9yKFxuICAgIGNvZGU6IHN0cmluZyxcbiAgICBtZXNzYWdlOiBzdHJpbmcsXG4gICAgb3B0aW9uczoge1xuICAgICAgICBkZXRhaWxzPzogdW5rbm93bjtcbiAgICAgICAgc3VnZ2VzdGlvbj86IHN0cmluZztcbiAgICAgICAgcmV0cnlhYmxlPzogYm9vbGVhbjtcbiAgICAgICAgc3RhZ2U/OiBzdHJpbmc7XG4gICAgfSA9IHt9XG4pOiBWMkJ1c2luZXNzRXJyb3Ige1xuICAgIHJldHVybiB7XG4gICAgICAgIGNvZGUsXG4gICAgICAgIG1lc3NhZ2UsXG4gICAgICAgIGRldGFpbHM6IG9wdGlvbnMuZGV0YWlscyxcbiAgICAgICAgc3VnZ2VzdGlvbjogb3B0aW9ucy5zdWdnZXN0aW9uLFxuICAgICAgICByZXRyeWFibGU6IG9wdGlvbnMucmV0cnlhYmxlID8/IGZhbHNlLFxuICAgICAgICBzdGFnZTogb3B0aW9ucy5zdGFnZVxuICAgIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0b0J1c2luZXNzRXJyb3IoZXJyb3I6IHVua25vd24pOiBWMkJ1c2luZXNzRXJyb3Ige1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIFYyQnVzaW5lc3NFcnJvckV4Y2VwdGlvbikge1xuICAgICAgICByZXR1cm4gZXJyb3IuYnVzaW5lc3NFcnJvcjtcbiAgICB9XG5cbiAgICBjb25zdCBtZXNzYWdlID0gU3RyaW5nKChlcnJvciBhcyBhbnkpPy5tZXNzYWdlID8/IGVycm9yID8/ICdVbmtub3duIGVycm9yJyk7XG4gICAgY29uc3Qgbm9ybWFsaXplZCA9IG1lc3NhZ2UudG9Mb3dlckNhc2UoKTtcblxuICAgIGlmIChub3JtYWxpemVkLmluY2x1ZGVzKCd0aW1lb3V0JykgfHwgbm9ybWFsaXplZC5pbmNsdWRlcygn6LaF5pe2JykpIHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZUJ1c2luZXNzRXJyb3IoVjJfRVJST1JfQ09ERVMuVElNRU9VVCwgbWVzc2FnZSwgeyByZXRyeWFibGU6IHRydWUgfSk7XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgICBub3JtYWxpemVkLmluY2x1ZGVzKCdub3QgZm91bmQnKVxuICAgICAgICB8fCBub3JtYWxpemVkLmluY2x1ZGVzKCfkuI3lrZjlnKgnKVxuICAgICAgICB8fCBub3JtYWxpemVkLmluY2x1ZGVzKCdpbnZhbGlkIG1jcC1zZXNzaW9uLWlkJylcbiAgICApIHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZUJ1c2luZXNzRXJyb3IoVjJfRVJST1JfQ09ERVMuTk9UX0ZPVU5ELCBtZXNzYWdlLCB7IHJldHJ5YWJsZTogZmFsc2UgfSk7XG4gICAgfVxuXG4gICAgaWYgKG5vcm1hbGl6ZWQuaW5jbHVkZXMoJ2NvbmZsaWN0JykgfHwgbm9ybWFsaXplZC5pbmNsdWRlcygn5Yay56qBJykgfHwgbm9ybWFsaXplZC5pbmNsdWRlcygnYWxyZWFkeSBleGlzdHMnKSkge1xuICAgICAgICByZXR1cm4gY3JlYXRlQnVzaW5lc3NFcnJvcihWMl9FUlJPUl9DT0RFUy5DT05GTElDVCwgbWVzc2FnZSwgeyByZXRyeWFibGU6IGZhbHNlIH0pO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgICAgbm9ybWFsaXplZC5pbmNsdWRlcygncHJlY29uZGl0aW9uJylcbiAgICAgICAgfHwgbm9ybWFsaXplZC5pbmNsdWRlcygnc2Vzc2lvbiBpcyBub3QgcmVhZHknKVxuICAgICAgICB8fCBub3JtYWxpemVkLmluY2x1ZGVzKCfliY3nva4nKVxuICAgICkge1xuICAgICAgICByZXR1cm4gY3JlYXRlQnVzaW5lc3NFcnJvcihWMl9FUlJPUl9DT0RFUy5QUkVDT05ESVRJT05fRkFJTEVELCBtZXNzYWdlLCB7IHJldHJ5YWJsZTogZmFsc2UgfSk7XG4gICAgfVxuXG4gICAgaWYgKG5vcm1hbGl6ZWQuaW5jbHVkZXMoJ3VuYXZhaWxhYmxlJykgfHwgbm9ybWFsaXplZC5pbmNsdWRlcygn5LiN5Y+v55SoJykgfHwgbm9ybWFsaXplZC5pbmNsdWRlcygnbm90IHJ1bm5pbmcnKSkge1xuICAgICAgICByZXR1cm4gY3JlYXRlQnVzaW5lc3NFcnJvcihWMl9FUlJPUl9DT0RFUy5VTkFWQUlMQUJMRSwgbWVzc2FnZSwgeyByZXRyeWFibGU6IHRydWUgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNyZWF0ZUJ1c2luZXNzRXJyb3IoVjJfRVJST1JfQ09ERVMuSU5URVJOQUwsIG1lc3NhZ2UsIHsgcmV0cnlhYmxlOiBmYWxzZSB9KTtcbn1cbiJdfQ==