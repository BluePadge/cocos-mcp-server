"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CapabilityProbe = void 0;
const method_catalog_1 = require("./method-catalog");
const editor_requester_1 = require("../editor-requester");
const CREATE_NODE_CHECK_KEY = 'scene.create-node';
function isMethodMissingError(errorMessage) {
    return /message does not exist|unknown method|cannot find|not exist|not found/i.test(errorMessage);
}
function normalizeError(error) {
    if (error && typeof error === 'object' && typeof error.message === 'string') {
        return error.message;
    }
    return String(error);
}
class CapabilityProbe {
    constructor(requester = editor_requester_1.defaultEditorRequester) {
        this.requester = requester;
    }
    async run(options = {}) {
        var _a, _b, _c;
        const checks = (_a = options.checks) !== null && _a !== void 0 ? _a : method_catalog_1.DEFAULT_CAPABILITY_CHECKS;
        const includeWriteChecks = options.includeWriteChecks === true;
        const requester = (_b = options.requester) !== null && _b !== void 0 ? _b : this.requester;
        const filteredChecks = checks.filter((item) => includeWriteChecks || item.readonly);
        const byKey = {};
        for (const check of filteredChecks) {
            const checkedAt = new Date().toISOString();
            if (check.probeStrategy === 'assume_available') {
                byKey[check.key] = {
                    key: check.key,
                    channel: check.channel,
                    method: check.method,
                    layer: check.layer,
                    readonly: check.readonly,
                    description: check.description,
                    available: true,
                    checkedAt,
                    detail: 'skip invoke (assume_available)'
                };
                continue;
            }
            try {
                const result = await requester(check.channel, check.method, ...((_c = check.args) !== null && _c !== void 0 ? _c : []));
                const detail = await this.cleanupProbeSideEffects(check, result, requester);
                byKey[check.key] = {
                    key: check.key,
                    channel: check.channel,
                    method: check.method,
                    layer: check.layer,
                    readonly: check.readonly,
                    description: check.description,
                    available: true,
                    checkedAt,
                    detail
                };
            }
            catch (error) {
                const message = normalizeError(error);
                const methodMissing = isMethodMissingError(message);
                byKey[check.key] = {
                    key: check.key,
                    channel: check.channel,
                    method: check.method,
                    layer: check.layer,
                    readonly: check.readonly,
                    description: check.description,
                    // 运行时报错但非“方法不存在”时，仍视为方法可见（通常是参数或上下文限制）
                    available: !methodMissing,
                    checkedAt,
                    detail: message
                };
            }
        }
        const records = Object.values(byKey);
        const summary = {
            total: records.length,
            available: records.filter((item) => item.available).length,
            unavailable: records.filter((item) => !item.available).length,
            byLayer: {
                official: this.buildLayerSummary(records, 'official'),
                extended: this.buildLayerSummary(records, 'extended'),
                experimental: this.buildLayerSummary(records, 'experimental')
            }
        };
        return {
            generatedAt: new Date().toISOString(),
            byKey,
            summary
        };
    }
    buildLayerSummary(records, layer) {
        const sameLayer = records.filter((item) => item.layer === layer);
        return {
            total: sameLayer.length,
            available: sameLayer.filter((item) => item.available).length
        };
    }
    async cleanupProbeSideEffects(check, result, requester) {
        if (check.key !== CREATE_NODE_CHECK_KEY) {
            return 'ok';
        }
        const uuids = this.extractCreatedNodeUuids(result);
        if (uuids.length === 0) {
            return 'ok (create-node probe: no created node detected)';
        }
        const cleanupError = await this.removeProbeNodes(uuids, requester);
        if (!cleanupError) {
            return `ok (create-node probe rollback: removed ${uuids.length} node(s))`;
        }
        return `ok (create-node probe rollback failed: ${cleanupError})`;
    }
    extractCreatedNodeUuids(result) {
        var _a, _b;
        if (typeof result === 'string' && result.trim() !== '') {
            return [result.trim()];
        }
        if (Array.isArray(result)) {
            return result
                .filter((item) => typeof item === 'string' && item.trim() !== '')
                .map((item) => item.trim());
        }
        if (result && typeof result === 'object') {
            const candidates = [
                result.uuid,
                result.nodeUuid,
                result.id,
                result.value,
                (_a = result === null || result === void 0 ? void 0 : result.node) === null || _a === void 0 ? void 0 : _a.uuid,
                (_b = result === null || result === void 0 ? void 0 : result.node) === null || _b === void 0 ? void 0 : _b.nodeUuid
            ];
            for (const candidate of candidates) {
                if (typeof candidate === 'string' && candidate.trim() !== '') {
                    return [candidate.trim()];
                }
                if (candidate && typeof candidate === 'object' && typeof candidate.value === 'string' && candidate.value.trim() !== '') {
                    return [candidate.value.trim()];
                }
            }
        }
        return [];
    }
    async removeProbeNodes(uuids, requester) {
        try {
            await requester('scene', 'remove-node', {
                uuid: uuids.length === 1 ? uuids[0] : uuids
            });
            return null;
        }
        catch (batchError) {
            const failed = [];
            for (const uuid of uuids) {
                try {
                    await requester('scene', 'remove-node', { uuid });
                }
                catch (_a) {
                    failed.push(uuid);
                }
            }
            if (failed.length === 0) {
                return null;
            }
            return `${normalizeError(batchError)}; still failed uuids: ${failed.join(', ')}`;
        }
    }
}
exports.CapabilityProbe = CapabilityProbe;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvYmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zb3VyY2UvbmV4dC9jYXBhYmlsaXR5L3Byb2JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLHFEQUE2RDtBQUM3RCwwREFBNkQ7QUFRN0QsTUFBTSxxQkFBcUIsR0FBRyxtQkFBbUIsQ0FBQztBQUVsRCxTQUFTLG9CQUFvQixDQUFDLFlBQW9CO0lBQzlDLE9BQU8sd0VBQXdFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3ZHLENBQUM7QUFFRCxTQUFTLGNBQWMsQ0FBQyxLQUFVO0lBQzlCLElBQUksS0FBSyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsSUFBSSxPQUFPLEtBQUssQ0FBQyxPQUFPLEtBQUssUUFBUSxFQUFFLENBQUM7UUFDMUUsT0FBTyxLQUFLLENBQUMsT0FBTyxDQUFDO0lBQ3pCLENBQUM7SUFDRCxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN6QixDQUFDO0FBRUQsTUFBYSxlQUFlO0lBR3hCLFlBQVksWUFBNkIseUNBQXNCO1FBQzNELElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQy9CLENBQUM7SUFFTSxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQXdCLEVBQUU7O1FBQ3ZDLE1BQU0sTUFBTSxHQUFHLE1BQUEsT0FBTyxDQUFDLE1BQU0sbUNBQUksMENBQXlCLENBQUM7UUFDM0QsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsa0JBQWtCLEtBQUssSUFBSSxDQUFDO1FBQy9ELE1BQU0sU0FBUyxHQUFHLE1BQUEsT0FBTyxDQUFDLFNBQVMsbUNBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUV0RCxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDcEYsTUFBTSxLQUFLLEdB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QkFDdEIsT0FBTyxJQUFJLENBQUM7WUFDaEIsQ0FBQztZQUNELE9BQU8sR0FBRyxjQUFjLENBQUMsVUFBVSxDQUFDLHlCQUF5QixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDckYsQ0FBQztJQUNMLENBQUM7Q0FDSjtBQXhLRCwwQ0F3S0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDYXBhYmlsaXR5Q2hlY2ssIENhcGFiaWxpdHlNYXRyaXgsIENhcGFiaWxpdHlSZWNvcmQsIEVkaXRvclJlcXVlc3RlciB9IGZyb20gJy4uL21vZGVscyc7XG5pbXBvcnQgeyBERUZBVUxUX0NBUEFCSUxJVFlfQ0hFQ0tTIH0gZnJvbSAnLi9tZXRob2QtY2F0YWxvZyc7XG5pbXBvcnQgeyBkZWZhdWx0RWRpdG9yUmVxdWVzdGVyIH0gZnJvbSAnLi4vZWRpdG9yLXJlcXVlc3Rlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJvYmVPcHRpb25zIHtcbiAgICBjaGVja3M/OiBDYXBhYmlsaXR5Q2hlY2tbXTtcbiAgICBpbmNsdWRlV3JpdGVDaGVja3M/OiBib29sZWFuO1xuICAgIHJlcXVlc3Rlcj86IEVkaXRvclJlcXVlc3Rlcjtcbn1cblxuY29uc3QgQ1JFQVRFX05PREVfQ0hFQ0tfS0VZID0gJ3NjZW5lLmNyZWF0ZS1ub2RlJztcblxuZnVuY3Rpb24gaXNNZXRob2RNaXNzaW5nRXJyb3IoZXJyb3JNZXNzYWdlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gL21lc3NhZ2UgZG9lcyBub3QgZXhpc3R8dW5rbm93biBtZXRob2R8Y2Fubm90IGZpbmR8bm90IGV4aXN0fG5vdCBmb3VuZC9pLnRlc3QoZXJyb3JNZXNzYWdlKTtcbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplRXJyb3IoZXJyb3I6IGFueSk6IHN0cmluZyB7XG4gICAgaWYgKGVycm9yICYmIHR5cGVvZiBlcnJvciA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIGVycm9yLm1lc3NhZ2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJldHVybiBlcnJvci5tZXNzYWdlO1xuICAgIH1cbiAgICByZXR1cm4gU3RyaW5nKGVycm9yKTtcbn1cblxuZXhwb3J0IGNsYXNzIENhcGFiaWxpdHlQcm9iZSB7XG4gICAgcHJpdmF0ZSByZWFkb25seSByZXF1ZXN0ZXI6IEVkaXRvclJlcXVlc3RlcjtcblxuICAgIGNvbnN0cnVjdG9yKHJlcXVlc3RlcjogRWRpdG9yUmVxdWVzdGVyID0gZGVmYXVsdEVkaXRvclJlcXVlc3Rlcikge1xuICAgICAgICB0aGlzLnJlcXVlc3RlciA9IHJlcXVlc3RlcjtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgcnVuKG9wdGlvbnM6IFByb2JlT3B0aW9ucyA9IHt9KTogUHJvbWlzZTxDYXBhYmlsaXR5TWF0cml4PiB7XG4gICAgICAgIGNvbnN0IGNoZWNrcyA9IG9wdGlvbnMuY2hlY2tzID8/IERFRkFVTFRfQ0FQQUJJTElUWV9DSEVDS1M7XG4gICAgICAgIGNvbnN0IGluY2x1ZGVXcml0ZUNoZWNrcyA9IG9wdGlvbnMuaW5jbHVkZVdyaXRlQ2hlY2tzID09PSB0cnVlO1xuICAgICAgICBjb25zdCByZXF1ZXN0ZXIgPSBvcHRpb25zLnJlcXVlc3RlciA/PyB0aGlzLnJlcXVlc3RlcjtcblxuICAgICAgICBjb25zdCBmaWx0ZXJlZENoZWNrcyA9IGNoZWNrcy5maWx0ZXIoKGl0ZW0pID0+IGluY2x1ZGVXcml0ZUNoZWNrcyB8fCBpdGVtLnJlYWRvbmx5KTtcbiAgICAgICAgY29uc3QgYnlLZXk6IFJlY29yZDxzdHJpbmcsIENhcGFiaWxpdHlSZWNvcmQ+ID0ge307XG5cbiAgICAgICAgZm9yIChjb25zdCBjaGVjayBvZiBmaWx0ZXJlZENoZWNrcykge1xuICAgICAgICAgICAgY29uc3QgY2hlY2tlZEF0ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgICAgICAgICAgaWYgKGNoZWNrLnByb2JlU3RyYXRlZ3kgPT09ICdhc3N1bWVfYXZhaWxhYmxlJykge1xuICAgICAgICAgICAgICAgIGJ5S2V5W2NoZWNrLmtleV0gPSB7XG4gICAgICAgICAgICAgICAgICAgIGtleTogY2hlY2sua2V5LFxuICAgICAgICAgICAgICAgICAgICBjaGFubmVsOiBjaGVjay5jaGFubmVsLFxuICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IGNoZWNrLm1ldGhvZCxcbiAgICAgICAgICAgICAgICAgICAgbGF5ZXI6IGNoZWNrLmxheWVyLFxuICAgICAgICAgICAgICAgICAgICByZWFkb25seTogY2hlY2sucmVhZG9ubHksXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBjaGVjay5kZXNjcmlwdGlvbixcbiAgICAgICAgICAgICAgICAgICAgYXZhaWxhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBjaGVja2VkQXQsXG4gICAgICAgICAgICAgICAgICAgIGRldGFpbDogJ3NraXAgaW52b2tlIChhc3N1bWVfYXZhaWxhYmxlKSdcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcXVlc3RlcihjaGVjay5jaGFubmVsLCBjaGVjay5tZXRob2QsIC4uLihjaGVjay5hcmdzID8/IFtdKSk7XG4gICAgICAgICAgICAgICAgY29uc3QgZGV0YWlsID0gYXdhaXQgdGhpcy5jbGVhbnVwUHJvYmVTaWRlRWZmZWN0cyhjaGVjaywgcmVzdWx0LCByZXF1ZXN0ZXIpO1xuICAgICAgICAgICAgICAgIGJ5S2V5W2NoZWNrLmtleV0gPSB7XG4gICAgICAgICAgICAgICAgICAgIGtleTogY2hlY2sua2V5LFxuICAgICAgICAgICAgICAgICAgICBjaGFubmVsOiBjaGVjay5jaGFubmVsLFxuICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IGNoZWNrLm1ldGhvZCxcbiAgICAgICAgICAgICAgICAgICAgbGF5ZXI6IGNoZWNrLmxheWVyLFxuICAgICAgICAgICAgICAgICAgICByZWFkb25seTogY2hlY2sucmVhZG9ubHksXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBjaGVjay5kZXNjcmlwdGlvbixcbiAgICAgICAgICAgICAgICAgICAgYXZhaWxhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBjaGVja2VkQXQsXG4gICAgICAgICAgICAgICAgICAgIGRldGFpbFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IG5vcm1hbGl6ZUVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICBjb25zdCBtZXRob2RNaXNzaW5nID0gaXNNZXRob2RNaXNzaW5nRXJyb3IobWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgYnlLZXlbY2hlY2sua2V5XSA9IHtcbiAgICAgICAgICAgICAgICAgICAga2V5OiBjaGVjay5rZXksXG4gICAgICAgICAgICAgICAgICAgIGNoYW5uZWw6IGNoZWNrLmNoYW5uZWwsXG4gICAgICAgICAgICAgICAgICAgIG1ldGhvZDogY2hlY2subWV0aG9kLFxuICAgICAgICAgICAgICAgICAgICBsYXllcjogY2hlY2subGF5ZXIsXG4gICAgICAgICAgICAgICAgICAgIHJlYWRvbmx5OiBjaGVjay5yZWFkb25seSxcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGNoZWNrLmRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgICAgICAgICAvLyDov5DooYzml7bmiqXplJnkvYbpnZ7igJzmlrnms5XkuI3lrZjlnKjigJ3ml7bvvIzku43op4bkuLrmlrnms5Xlj6/op4HvvIjpgJrluLjmmK/lj4LmlbDmiJbkuIrkuIvmlofpmZDliLbvvIlcbiAgICAgICAgICAgICAgICAgICAgYXZhaWxhYmxlOiAhbWV0aG9kTWlzc2luZyxcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tlZEF0LFxuICAgICAgICAgICAgICAgICAgICBkZXRhaWw6IG1lc3NhZ2VcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVjb3JkcyA9IE9iamVjdC52YWx1ZXMoYnlLZXkpO1xuICAgICAgICBjb25zdCBzdW1tYXJ5ID0ge1xuICAgICAgICAgICAgdG90YWw6IHJlY29yZHMubGVuZ3RoLFxuICAgICAgICAgICAgYXZhaWxhYmxlOiByZWNvcmRzLmZpbHRlcigoaXRlbSkgPT4gaXRlbS5hdmFpbGFibGUpLmxlbmd0aCxcbiAgICAgICAgICAgIHVuYXZhaWxhYmxlOiByZWNvcmRzLmZpbHRlcigoaXRlbSkgPT4gIWl0ZW0uYXZhaWxhYmxlKS5sZW5ndGgsXG4gICAgICAgICAgICBieUxheWVyOiB7XG4gICAgICAgICAgICAgICAgb2ZmaWNpYWw6IHRoaXMuYnVpbGRMYXllclN1bW1hcnkocmVjb3JkcywgJ29mZmljaWFsJyksXG4gICAgICAgICAgICAgICAgZXh0ZW5kZWQ6IHRoaXMuYnVpbGRMYXllclN1bW1hcnkocmVjb3JkcywgJ2V4dGVuZGVkJyksXG4gICAgICAgICAgICAgICAgZXhwZXJpbWVudGFsOiB0aGlzLmJ1aWxkTGF5ZXJTdW1tYXJ5KHJlY29yZHMsICdleHBlcmltZW50YWwnKVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBnZW5lcmF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgYnlLZXksXG4gICAgICAgICAgICBzdW1tYXJ5XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBidWlsZExheWVyU3VtbWFyeShyZWNvcmRzOiBDYXBhYmlsaXR5UmVjb3JkW10sIGxheWVyOiAnb2ZmaWNpYWwnIHwgJ2V4dGVuZGVkJyB8ICdleHBlcmltZW50YWwnKTogeyB0b3RhbDogbnVtYmVyOyBhdmFpbGFibGU6IG51bWJlciB9IHtcbiAgICAgICAgY29uc3Qgc2FtZUxheWVyID0gcmVjb3Jkcy5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0ubGF5ZXIgPT09IGxheWVyKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRvdGFsOiBzYW1lTGF5ZXIubGVuZ3RoLFxuICAgICAgICAgICAgYXZhaWxhYmxlOiBzYW1lTGF5ZXIuZmlsdGVyKChpdGVtKSA9PiBpdGVtLmF2YWlsYWJsZSkubGVuZ3RoXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBjbGVhbnVwUHJvYmVTaWRlRWZmZWN0cyhcbiAgICAgICAgY2hlY2s6IENhcGFiaWxpdHlDaGVjayxcbiAgICAgICAgcmVzdWx0OiBhbnksXG4gICAgICAgIHJlcXVlc3RlcjogRWRpdG9yUmVxdWVzdGVyXG4gICAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgaWYgKGNoZWNrLmtleSAhPT0gQ1JFQVRFX05PREVfQ0hFQ0tfS0VZKSB7XG4gICAgICAgICAgICByZXR1cm4gJ29rJztcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHV1aWRzID0gdGhpcy5leHRyYWN0Q3JlYXRlZE5vZGVVdWlkcyhyZXN1bHQpO1xuICAgICAgICBpZiAodXVpZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gJ29rIChjcmVhdGUtbm9kZSBwcm9iZTogbm8gY3JlYXRlZCBub2RlIGRldGVjdGVkKSc7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjbGVhbnVwRXJyb3IgPSBhd2FpdCB0aGlzLnJlbW92ZVByb2JlTm9kZXModXVpZHMsIHJlcXVlc3Rlcik7XG4gICAgICAgIGlmICghY2xlYW51cEVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gYG9rIChjcmVhdGUtbm9kZSBwcm9iZSByb2xsYmFjazogcmVtb3ZlZCAke3V1aWRzLmxlbmd0aH0gbm9kZShzKSlgO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGBvayAoY3JlYXRlLW5vZGUgcHJvYmUgcm9sbGJhY2sgZmFpbGVkOiAke2NsZWFudXBFcnJvcn0pYDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGV4dHJhY3RDcmVhdGVkTm9kZVV1aWRzKHJlc3VsdDogYW55KTogc3RyaW5nW10ge1xuICAgICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PT0gJ3N0cmluZycgJiYgcmVzdWx0LnRyaW0oKSAhPT0gJycpIHtcbiAgICAgICAgICAgIHJldHVybiBbcmVzdWx0LnRyaW0oKV07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0XG4gICAgICAgICAgICAgICAgLmZpbHRlcigoaXRlbSkgPT4gdHlwZW9mIGl0ZW0gPT09ICdzdHJpbmcnICYmIGl0ZW0udHJpbSgpICE9PSAnJylcbiAgICAgICAgICAgICAgICAubWFwKChpdGVtKSA9PiBpdGVtLnRyaW0oKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmVzdWx0ICYmIHR5cGVvZiByZXN1bHQgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICBjb25zdCBjYW5kaWRhdGVzID0gW1xuICAgICAgICAgICAgICAgIHJlc3VsdC51dWlkLFxuICAgICAgICAgICAgICAgIHJlc3VsdC5ub2RlVXVpZCxcbiAgICAgICAgICAgICAgICByZXN1bHQuaWQsXG4gICAgICAgICAgICAgICAgcmVzdWx0LnZhbHVlLFxuICAgICAgICAgICAgICAgIHJlc3VsdD8ubm9kZT8udXVpZCxcbiAgICAgICAgICAgICAgICByZXN1bHQ/Lm5vZGU/Lm5vZGVVdWlkXG4gICAgICAgICAgICBdO1xuICAgICAgICAgICAgZm9yIChjb25zdCBjYW5kaWRhdGUgb2YgY2FuZGlkYXRlcykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY2FuZGlkYXRlID09PSAnc3RyaW5nJyAmJiBjYW5kaWRhdGUudHJpbSgpICE9PSAnJykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gW2NhbmRpZGF0ZS50cmltKCldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoY2FuZGlkYXRlICYmIHR5cGVvZiBjYW5kaWRhdGUgPT09ICdvYmplY3QnICYmIHR5cGVvZiBjYW5kaWRhdGUudmFsdWUgPT09ICdzdHJpbmcnICYmIGNhbmRpZGF0ZS52YWx1ZS50cmltKCkgIT09ICcnKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBbY2FuZGlkYXRlLnZhbHVlLnRyaW0oKV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgcmVtb3ZlUHJvYmVOb2Rlcyh1dWlkczogc3RyaW5nW10sIHJlcXVlc3RlcjogRWRpdG9yUmVxdWVzdGVyKTogUHJvbWlzZTxzdHJpbmcgfCBudWxsPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCByZXF1ZXN0ZXIoJ3NjZW5lJywgJ3JlbW92ZS1ub2RlJywge1xuICAgICAgICAgICAgICAgIHV1aWQ6IHV1aWRzLmxlbmd0aCA9PT0gMSA/IHV1aWRzWzBdIDogdXVpZHNcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH0gY2F0Y2ggKGJhdGNoRXJyb3I6IGFueSkge1xuICAgICAgICAgICAgY29uc3QgZmFpbGVkOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICAgICAgZm9yIChjb25zdCB1dWlkIG9mIHV1aWRzKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgcmVxdWVzdGVyKCdzY2VuZScsICdyZW1vdmUtbm9kZScsIHsgdXVpZCB9KTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICAgICAgICAgICAgZmFpbGVkLnB1c2godXVpZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoZmFpbGVkLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGAke25vcm1hbGl6ZUVycm9yKGJhdGNoRXJyb3IpfTsgc3RpbGwgZmFpbGVkIHV1aWRzOiAke2ZhaWxlZC5qb2luKCcsICcpfWA7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=