"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CapabilityProbe = void 0;
const method_catalog_1 = require("./method-catalog");
const editor_requester_1 = require("../editor-requester");
const CREATE_NODE_CHECK_KEY = 'scene.create-node';
function isMethodMissingError(errorMessage) {
    return /message does not exist|unknown method|cannot find|not exist|not found/i.test(errorMessage);
}
function normalizeError(error) {
    if (error && typeof error === 'object' && typeof error.message === 'string') {
        return error.message;
    }
    return String(error);
}
class CapabilityProbe {
    constructor(requester = editor_requester_1.defaultEditorRequester) {
        this.requester = requester;
    }
    async run(options = {}) {
        var _a, _b, _c;
        const checks = (_a = options.checks) !== null && _a !== void 0 ? _a : method_catalog_1.DEFAULT_CAPABILITY_CHECKS;
        const includeWriteChecks = options.includeWriteChecks === true;
        const requester = (_b = options.requester) !== null && _b !== void 0 ? _b : this.requester;
        const filteredChecks = checks.filter((item) => includeWriteChecks || item.readonly);
        const byKey = {};
        for (const check of filteredChecks) {
            const checkedAt = new Date().toISOString();
            try {
                const result = await requester(check.channel, check.method, ...((_c = check.args) !== null && _c !== void 0 ? _c : []));
                const detail = await this.cleanupProbeSideEffects(check, result, requester);
                byKey[check.key] = {
                    key: check.key,
                    channel: check.channel,
                    method: check.method,
                    layer: check.layer,
                    readonly: check.readonly,
                    description: check.description,
                    available: true,
                    checkedAt,
                    detail
                };
            }
            catch (error) {
                const message = normalizeError(error);
                const methodMissing = isMethodMissingError(message);
                byKey[check.key] = {
                    key: check.key,
                    channel: check.channel,
                    method: check.method,
                    layer: check.layer,
                    readonly: check.readonly,
                    description: check.description,
                    // 运行时报错但非“方法不存在”时，仍视为方法可见（通常是参数或上下文限制）
                    available: !methodMissing,
                    checkedAt,
                    detail: message
                };
            }
        }
        const records = Object.values(byKey);
        const summary = {
            total: records.length,
            available: records.filter((item) => item.available).length,
            unavailable: records.filter((item) => !item.available).length,
            byLayer: {
                official: this.buildLayerSummary(records, 'official'),
                extended: this.buildLayerSummary(records, 'extended'),
                experimental: this.buildLayerSummary(records, 'experimental')
            }
        };
        return {
            generatedAt: new Date().toISOString(),
            byKey,
            summary
        };
    }
    buildLayerSummary(records, layer) {
        const sameLayer = records.filter((item) => item.layer === layer);
        return {
            total: sameLayer.length,
            available: sameLayer.filter((item) => item.available).length
        };
    }
    async cleanupProbeSideEffects(check, result, requester) {
        if (check.key !== CREATE_NODE_CHECK_KEY) {
            return 'ok';
        }
        const uuids = this.extractCreatedNodeUuids(result);
        if (uuids.length === 0) {
            return 'ok (create-node probe: no created node detected)';
        }
        const cleanupError = await this.removeProbeNodes(uuids, requester);
        if (!cleanupError) {
            return `ok (create-node probe rollback: removed ${uuids.length} node(s))`;
        }
        return `ok (create-node probe rollback failed: ${cleanupError})`;
    }
    extractCreatedNodeUuids(result) {
        if (typeof result === 'string' && result.trim() !== '') {
            return [result.trim()];
        }
        if (Array.isArray(result)) {
            return result
                .filter((item) => typeof item === 'string' && item.trim() !== '')
                .map((item) => item.trim());
        }
        return [];
    }
    async removeProbeNodes(uuids, requester) {
        try {
            await requester('scene', 'remove-node', {
                uuid: uuids.length === 1 ? uuids[0] : uuids
            });
            return null;
        }
        catch (batchError) {
            const failed = [];
            for (const uuid of uuids) {
                try {
                    await requester('scene', 'remove-node', { uuid });
                }
                catch (_a) {
                    failed.push(uuid);
                }
            }
            if (failed.length === 0) {
                return null;
            }
            return `${normalizeError(batchError)}; still failed uuids: ${failed.join(', ')}`;
        }
    }
}
exports.CapabilityProbe = CapabilityProbe;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvYmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zb3VyY2UvbmV4dC9jYXBhYmlsaXR5L3Byb2JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLHFEQUE2RDtBQUM3RCwwREFBNkQ7QUFRN0QsTUFBTSxxQkFBcUIsR0FBRyxtQkFBbUIsQ0FBQztBQUVsRCxTQUFTLG9CQUFvQixDQUFDLFlBQW9CO0lBQzlDLE9BQU8sd0VBQXdFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3ZHLENBQUM7QUFFRCxTQUFTLGNBQWMsQ0FBQyxLQUFVO0lBQzlCLElBQUksS0FBSyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsSUFBSSxPQUFPLEtBQUssQ0FBQyxPQUFPLEtBQUssUUFBUSxFQUFFLENBQUM7UUFDMUUsT0FBTyxLQUFLLENBQUMsT0FBTyxDQUFDO0lBQ3pCLENBQUM7SUFDRCxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN6QixDQUFDO0FBRUQsTUFBYSxlQUFlO0lBR3hCLFlBQVksWUFBNkIseUNBQXNCO1FBQzNELElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQy9CLENBQUM7SUFFTSxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQXdCLEVBQUU7O1FBQ3ZDLE1BQU0sTUFBTSxHQUFHLE1BQUEsT0FBTyxDQUFDLE1BQU0sbUNBQUksMENBQXlCLENBQUM7UUFDM0QsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsa0JBQWtCLEtBQUssSUFBSSxDQUFDO1FBQy9ELE1BQU0sU0FBUyxHQUFHLE1BQUEsT0FBTyxDQUFDLFNBQVMsbUNBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUV0RCxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDcEYsTUFBTSxLQUFLLEdB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QXNJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENhcGFiaWxpdHlDaGVjaywgQ2FwYWJpbGl0eU1hdHJpeCwgQ2FwYWJpbGl0eVJlY29yZCwgRWRpdG9yUmVxdWVzdGVyIH0gZnJvbSAnLi4vbW9kZWxzJztcbmltcG9ydCB7IERFRkFVTFRfQ0FQQUJJTElUWV9DSEVDS1MgfSBmcm9tICcuL21ldGhvZC1jYXRhbG9nJztcbmltcG9ydCB7IGRlZmF1bHRFZGl0b3JSZXF1ZXN0ZXIgfSBmcm9tICcuLi9lZGl0b3ItcmVxdWVzdGVyJztcblxuZXhwb3J0IGludGVyZmFjZSBQcm9iZU9wdGlvbnMge1xuICAgIGNoZWNrcz86IENhcGFiaWxpdHlDaGVja1tdO1xuICAgIGluY2x1ZGVXcml0ZUNoZWNrcz86IGJvb2xlYW47XG4gICAgcmVxdWVzdGVyPzogRWRpdG9yUmVxdWVzdGVyO1xufVxuXG5jb25zdCBDUkVBVEVfTk9ERV9DSEVDS19LRVkgPSAnc2NlbmUuY3JlYXRlLW5vZGUnO1xuXG5mdW5jdGlvbiBpc01ldGhvZE1pc3NpbmdFcnJvcihlcnJvck1lc3NhZ2U6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAvbWVzc2FnZSBkb2VzIG5vdCBleGlzdHx1bmtub3duIG1ldGhvZHxjYW5ub3QgZmluZHxub3QgZXhpc3R8bm90IGZvdW5kL2kudGVzdChlcnJvck1lc3NhZ2UpO1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVFcnJvcihlcnJvcjogYW55KTogc3RyaW5nIHtcbiAgICBpZiAoZXJyb3IgJiYgdHlwZW9mIGVycm9yID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgZXJyb3IubWVzc2FnZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIGVycm9yLm1lc3NhZ2U7XG4gICAgfVxuICAgIHJldHVybiBTdHJpbmcoZXJyb3IpO1xufVxuXG5leHBvcnQgY2xhc3MgQ2FwYWJpbGl0eVByb2JlIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJlcXVlc3RlcjogRWRpdG9yUmVxdWVzdGVyO1xuXG4gICAgY29uc3RydWN0b3IocmVxdWVzdGVyOiBFZGl0b3JSZXF1ZXN0ZXIgPSBkZWZhdWx0RWRpdG9yUmVxdWVzdGVyKSB7XG4gICAgICAgIHRoaXMucmVxdWVzdGVyID0gcmVxdWVzdGVyO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBydW4ob3B0aW9uczogUHJvYmVPcHRpb25zID0ge30pOiBQcm9taXNlPENhcGFiaWxpdHlNYXRyaXg+IHtcbiAgICAgICAgY29uc3QgY2hlY2tzID0gb3B0aW9ucy5jaGVja3MgPz8gREVGQVVMVF9DQVBBQklMSVRZX0NIRUNLUztcbiAgICAgICAgY29uc3QgaW5jbHVkZVdyaXRlQ2hlY2tzID0gb3B0aW9ucy5pbmNsdWRlV3JpdGVDaGVja3MgPT09IHRydWU7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RlciA9IG9wdGlvbnMucmVxdWVzdGVyID8/IHRoaXMucmVxdWVzdGVyO1xuXG4gICAgICAgIGNvbnN0IGZpbHRlcmVkQ2hlY2tzID0gY2hlY2tzLmZpbHRlcigoaXRlbSkgPT4gaW5jbHVkZVdyaXRlQ2hlY2tzIHx8IGl0ZW0ucmVhZG9ubHkpO1xuICAgICAgICBjb25zdCBieUtleTogUmVjb3JkPHN0cmluZywgQ2FwYWJpbGl0eVJlY29yZD4gPSB7fTtcblxuICAgICAgICBmb3IgKGNvbnN0IGNoZWNrIG9mIGZpbHRlcmVkQ2hlY2tzKSB7XG4gICAgICAgICAgICBjb25zdCBjaGVja2VkQXQgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcXVlc3RlcihjaGVjay5jaGFubmVsLCBjaGVjay5tZXRob2QsIC4uLihjaGVjay5hcmdzID8/IFtdKSk7XG4gICAgICAgICAgICAgICAgY29uc3QgZGV0YWlsID0gYXdhaXQgdGhpcy5jbGVhbnVwUHJvYmVTaWRlRWZmZWN0cyhjaGVjaywgcmVzdWx0LCByZXF1ZXN0ZXIpO1xuICAgICAgICAgICAgICAgIGJ5S2V5W2NoZWNrLmtleV0gPSB7XG4gICAgICAgICAgICAgICAgICAgIGtleTogY2hlY2sua2V5LFxuICAgICAgICAgICAgICAgICAgICBjaGFubmVsOiBjaGVjay5jaGFubmVsLFxuICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IGNoZWNrLm1ldGhvZCxcbiAgICAgICAgICAgICAgICAgICAgbGF5ZXI6IGNoZWNrLmxheWVyLFxuICAgICAgICAgICAgICAgICAgICByZWFkb25seTogY2hlY2sucmVhZG9ubHksXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBjaGVjay5kZXNjcmlwdGlvbixcbiAgICAgICAgICAgICAgICAgICAgYXZhaWxhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBjaGVja2VkQXQsXG4gICAgICAgICAgICAgICAgICAgIGRldGFpbFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IG5vcm1hbGl6ZUVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICBjb25zdCBtZXRob2RNaXNzaW5nID0gaXNNZXRob2RNaXNzaW5nRXJyb3IobWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgYnlLZXlbY2hlY2sua2V5XSA9IHtcbiAgICAgICAgICAgICAgICAgICAga2V5OiBjaGVjay5rZXksXG4gICAgICAgICAgICAgICAgICAgIGNoYW5uZWw6IGNoZWNrLmNoYW5uZWwsXG4gICAgICAgICAgICAgICAgICAgIG1ldGhvZDogY2hlY2subWV0aG9kLFxuICAgICAgICAgICAgICAgICAgICBsYXllcjogY2hlY2subGF5ZXIsXG4gICAgICAgICAgICAgICAgICAgIHJlYWRvbmx5OiBjaGVjay5yZWFkb25seSxcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGNoZWNrLmRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgICAgICAgICAvLyDov5DooYzml7bmiqXplJnkvYbpnZ7igJzmlrnms5XkuI3lrZjlnKjigJ3ml7bvvIzku43op4bkuLrmlrnms5Xlj6/op4HvvIjpgJrluLjmmK/lj4LmlbDmiJbkuIrkuIvmlofpmZDliLbvvIlcbiAgICAgICAgICAgICAgICAgICAgYXZhaWxhYmxlOiAhbWV0aG9kTWlzc2luZyxcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tlZEF0LFxuICAgICAgICAgICAgICAgICAgICBkZXRhaWw6IG1lc3NhZ2VcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVjb3JkcyA9IE9iamVjdC52YWx1ZXMoYnlLZXkpO1xuICAgICAgICBjb25zdCBzdW1tYXJ5ID0ge1xuICAgICAgICAgICAgdG90YWw6IHJlY29yZHMubGVuZ3RoLFxuICAgICAgICAgICAgYXZhaWxhYmxlOiByZWNvcmRzLmZpbHRlcigoaXRlbSkgPT4gaXRlbS5hdmFpbGFibGUpLmxlbmd0aCxcbiAgICAgICAgICAgIHVuYXZhaWxhYmxlOiByZWNvcmRzLmZpbHRlcigoaXRlbSkgPT4gIWl0ZW0uYXZhaWxhYmxlKS5sZW5ndGgsXG4gICAgICAgICAgICBieUxheWVyOiB7XG4gICAgICAgICAgICAgICAgb2ZmaWNpYWw6IHRoaXMuYnVpbGRMYXllclN1bW1hcnkocmVjb3JkcywgJ29mZmljaWFsJyksXG4gICAgICAgICAgICAgICAgZXh0ZW5kZWQ6IHRoaXMuYnVpbGRMYXllclN1bW1hcnkocmVjb3JkcywgJ2V4dGVuZGVkJyksXG4gICAgICAgICAgICAgICAgZXhwZXJpbWVudGFsOiB0aGlzLmJ1aWxkTGF5ZXJTdW1tYXJ5KHJlY29yZHMsICdleHBlcmltZW50YWwnKVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBnZW5lcmF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgYnlLZXksXG4gICAgICAgICAgICBzdW1tYXJ5XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBidWlsZExheWVyU3VtbWFyeShyZWNvcmRzOiBDYXBhYmlsaXR5UmVjb3JkW10sIGxheWVyOiAnb2ZmaWNpYWwnIHwgJ2V4dGVuZGVkJyB8ICdleHBlcmltZW50YWwnKTogeyB0b3RhbDogbnVtYmVyOyBhdmFpbGFibGU6IG51bWJlciB9IHtcbiAgICAgICAgY29uc3Qgc2FtZUxheWVyID0gcmVjb3Jkcy5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0ubGF5ZXIgPT09IGxheWVyKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRvdGFsOiBzYW1lTGF5ZXIubGVuZ3RoLFxuICAgICAgICAgICAgYXZhaWxhYmxlOiBzYW1lTGF5ZXIuZmlsdGVyKChpdGVtKSA9PiBpdGVtLmF2YWlsYWJsZSkubGVuZ3RoXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBjbGVhbnVwUHJvYmVTaWRlRWZmZWN0cyhcbiAgICAgICAgY2hlY2s6IENhcGFiaWxpdHlDaGVjayxcbiAgICAgICAgcmVzdWx0OiBhbnksXG4gICAgICAgIHJlcXVlc3RlcjogRWRpdG9yUmVxdWVzdGVyXG4gICAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgaWYgKGNoZWNrLmtleSAhPT0gQ1JFQVRFX05PREVfQ0hFQ0tfS0VZKSB7XG4gICAgICAgICAgICByZXR1cm4gJ29rJztcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHV1aWRzID0gdGhpcy5leHRyYWN0Q3JlYXRlZE5vZGVVdWlkcyhyZXN1bHQpO1xuICAgICAgICBpZiAodXVpZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gJ29rIChjcmVhdGUtbm9kZSBwcm9iZTogbm8gY3JlYXRlZCBub2RlIGRldGVjdGVkKSc7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjbGVhbnVwRXJyb3IgPSBhd2FpdCB0aGlzLnJlbW92ZVByb2JlTm9kZXModXVpZHMsIHJlcXVlc3Rlcik7XG4gICAgICAgIGlmICghY2xlYW51cEVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gYG9rIChjcmVhdGUtbm9kZSBwcm9iZSByb2xsYmFjazogcmVtb3ZlZCAke3V1aWRzLmxlbmd0aH0gbm9kZShzKSlgO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGBvayAoY3JlYXRlLW5vZGUgcHJvYmUgcm9sbGJhY2sgZmFpbGVkOiAke2NsZWFudXBFcnJvcn0pYDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGV4dHJhY3RDcmVhdGVkTm9kZVV1aWRzKHJlc3VsdDogYW55KTogc3RyaW5nW10ge1xuICAgICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PT0gJ3N0cmluZycgJiYgcmVzdWx0LnRyaW0oKSAhPT0gJycpIHtcbiAgICAgICAgICAgIHJldHVybiBbcmVzdWx0LnRyaW0oKV07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0XG4gICAgICAgICAgICAgICAgLmZpbHRlcigoaXRlbSkgPT4gdHlwZW9mIGl0ZW0gPT09ICdzdHJpbmcnICYmIGl0ZW0udHJpbSgpICE9PSAnJylcbiAgICAgICAgICAgICAgICAubWFwKChpdGVtKSA9PiBpdGVtLnRyaW0oKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyByZW1vdmVQcm9iZU5vZGVzKHV1aWRzOiBzdHJpbmdbXSwgcmVxdWVzdGVyOiBFZGl0b3JSZXF1ZXN0ZXIpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHJlcXVlc3Rlcignc2NlbmUnLCAncmVtb3ZlLW5vZGUnLCB7XG4gICAgICAgICAgICAgICAgdXVpZDogdXVpZHMubGVuZ3RoID09PSAxID8gdXVpZHNbMF0gOiB1dWlkc1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfSBjYXRjaCAoYmF0Y2hFcnJvcjogYW55KSB7XG4gICAgICAgICAgICBjb25zdCBmYWlsZWQ6IHN0cmluZ1tdID0gW107XG4gICAgICAgICAgICBmb3IgKGNvbnN0IHV1aWQgb2YgdXVpZHMpIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCByZXF1ZXN0ZXIoJ3NjZW5lJywgJ3JlbW92ZS1ub2RlJywgeyB1dWlkIH0pO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgICAgICAgICAgICBmYWlsZWQucHVzaCh1dWlkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChmYWlsZWQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYCR7bm9ybWFsaXplRXJyb3IoYmF0Y2hFcnJvcil9OyBzdGlsbCBmYWlsZWQgdXVpZHM6ICR7ZmFpbGVkLmpvaW4oJywgJyl9YDtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==