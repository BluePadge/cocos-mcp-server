"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.NextMcpRouter = void 0;
const crypto_1 = require("crypto");
function makeError(id, code, message, data) {
    return {
        jsonrpc: '2.0',
        id,
        error: {
            code,
            message,
            data
        }
    };
}
class NextMcpRouter {
    constructor(registry, maxTraceRecords = 300) {
        this.traces = new Map();
        this.traceOrder = [];
        this.registry = registry;
        this.maxTraceRecords = maxTraceRecords;
    }
    async handle(message) {
        var _a;
        if (!message || message.jsonrpc !== '2.0' || typeof message.method !== 'string') {
            return makeError(null, -32600, 'Invalid Request');
        }
        const isNotification = message.id === undefined;
        if (isNotification) {
            return null;
        }
        const id = (_a = message.id) !== null && _a !== void 0 ? _a : null;
        switch (message.method) {
            case 'tools/list':
                return {
                    jsonrpc: '2.0',
                    id,
                    result: {
                        tools: this.registry.listTools()
                    }
                };
            case 'tools/call':
                return await this.handleToolCall(id, message.params);
            case 'get_tool_manifest':
                return this.handleGetManifest(id, message.params);
            case 'get_trace_by_id':
                return this.handleGetTraceById(id, message.params);
            case 'get_capability_matrix':
                return {
                    jsonrpc: '2.0',
                    id,
                    result: this.registry.getCapabilityMatrix()
                };
            default:
                return makeError(id, -32601, `Method not found: ${message.method}`);
        }
    }
    async handleToolCall(id, params) {
        var _a, _b, _c;
        const name = params === null || params === void 0 ? void 0 : params.name;
        const args = (_a = params === null || params === void 0 ? void 0 : params.arguments) !== null && _a !== void 0 ? _a : {};
        if (typeof name !== 'string' || name.trim() === '') {
            return makeError(id, -32602, 'Invalid params: name is required');
        }
        const tool = this.registry.getTool(name);
        if (!tool) {
            return makeError(id, -32602, `Unknown or unavailable tool: ${name}`);
        }
        try {
            const startedAt = Date.now();
            const timestamp = new Date(startedAt).toISOString();
            const traceId = (0, crypto_1.randomUUID)();
            const result = await tool.run(args);
            const wrapped = this.wrapToolResult(name, traceId, startedAt, timestamp, result);
            this.recordTrace({
                traceId,
                tool: name,
                timestamp,
                durationMs: wrapped.structuredContent.meta.durationMs,
                success: result.success,
                errorCode: result.success ? null : ((_c = (_b = result.error) === null || _b === void 0 ? void 0 : _b.code) !== null && _c !== void 0 ? _c : 'E_UNKNOWN'),
                argsSummary: this.summarizeArgs(args)
            });
            return {
                jsonrpc: '2.0',
                id,
                result: wrapped
            };
        }
        catch (error) {
            return makeError(id, -32603, (error === null || error === void 0 ? void 0 : error.message) || String(error));
        }
    }
    handleGetManifest(id, params) {
        const name = params === null || params === void 0 ? void 0 : params.name;
        if (typeof name !== 'string' || name.trim() === '') {
            return makeError(id, -32602, 'Invalid params: name is required');
        }
        const manifest = this.registry.getManifest(name);
        if (!manifest) {
            return makeError(id, -32602, `Unknown tool: ${name}`);
        }
        return {
            jsonrpc: '2.0',
            id,
            result: manifest
        };
    }
    handleGetTraceById(id, params) {
        const traceId = params === null || params === void 0 ? void 0 : params.traceId;
        if (typeof traceId !== 'string' || traceId.trim() === '') {
            return makeError(id, -32602, 'Invalid params: traceId is required');
        }
        return {
            jsonrpc: '2.0',
            id,
            result: {
                trace: this.traces.get(traceId) || null
            }
        };
    }
    wrapToolResult(toolName, traceId, startedAt, timestamp, result) {
        const durationMs = Date.now() - startedAt;
        const meta = {
            traceId,
            tool: toolName,
            version: 'next-0.1.0',
            durationMs,
            timestamp
        };
        const structuredContent = result.success
            ? {
                success: true,
                data: result.data,
                meta
            }
            : {
                success: false,
                error: result.error,
                meta
            };
        return {
            content: [
                {
                    type: 'text',
                    text: result.success ? `工具执行成功: ${toolName}` : `工具执行失败: ${toolName}`
                }
            ],
            structuredContent,
            isError: !result.success
        };
    }
    recordTrace(trace) {
        this.traces.set(trace.traceId, trace);
        this.traceOrder.push(trace.traceId);
        while (this.traceOrder.length > this.maxTraceRecords) {
            const oldest = this.traceOrder.shift();
            if (oldest) {
                this.traces.delete(oldest);
            }
        }
    }
    summarizeArgs(args) {
        if (!args || typeof args !== 'object' || Array.isArray(args)) {
            return {};
        }
        const summary = {};
        for (const [key, value] of Object.entries(args)) {
            if (typeof value === 'string') {
                summary[key] = value.length > 120 ? `${value.slice(0, 117)}...` : value;
                continue;
            }
            if (typeof value === 'number' || typeof value === 'boolean') {
                summary[key] = String(value);
                continue;
            }
            if (value === null) {
                summary[key] = 'null';
                continue;
            }
            if (Array.isArray(value)) {
                summary[key] = `array(${value.length})`;
                continue;
            }
            summary[key] = 'object';
        }
        return summary;
    }
}
exports.NextMcpRouter = NextMcpRouter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc291cmNlL25leHQvcHJvdG9jb2wvcm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFvQztBQWNwQyxTQUFTLFNBQVMsQ0FBQyxFQUEwQixFQUFFLElBQVksRUFBRSxPQUFlLEVBQUUsSUFBVTtJQUNwRixPQUFPO1FBQ0gsT0FBTyxFQUFFLEtBQUs7UUFDZCxFQUFFO1FBQ0YsS0FBSyxFQUFFO1lBQ0gsSUFBSTtZQUNKLE9BQU87WUFDUCxJQUFJO1NBQ1A7S0FDSixDQUFDO0FBQ04sQ0FBQztBQUVELE1BQWEsYUFBYTtJQU10QixZQUFZLFFBQTBCLEVBQUUsa0JBQTBCLEdBQUc7UUFKcEQsV0FBTSxHQUFHLElBQUksR0FBRyxFQUEyQixDQUFDO1FBQzVDLGVBQVUsR0FBYSxFQUFFLENBQUM7UUFJdkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsSUFBSSxDQUFDLGVBQWUsR0FBRyxlQUFlLENBQUM7SUFDM0MsQ0FBQztJQUVNLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBOEI7O1FBQzlDLElBQUksQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sS0FBSyxLQUFLLElBQUksT0FBTyxPQUFPLENBQUMsTUFBTSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQzlFLE9BQU8sU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDLEtBQUssRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3RELENBQUM7UUFFRCxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsRUFBRSxLQUFLLFNBQVMsQ0FBQztRQUNoRCxJQUFJLGNBQWMsRUFBRSxDQUFDO1lBQ2pCLE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUM7UUFFRCxNQUFNLEVBQUUsR0FBRyxNQUFBLE9BQU8sQ0FBQyxFQUFFLG1DQUFJLElBQUksQ0FBQztRQUU5QixRQUFRLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNyQixLQUFLLFlBQVk7Z0JBQ2IsT0FBTztvQkFDSCxPQUFPLEVBQUUsS0FBSztvQkFDZCxFQUFFO29CQUNGLE1BQU0sRUFBRTt3QkFDSixLQUFLLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEVBQUU7cUJBQ25DO2lCQUNKLENBQUM7WUFFTixLQUFLLFlBQVk7Z0JBQ2IsT0FBTyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUV6RCxLQUFLLG1CQUFtQjtnQkFDcEIsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUV0RCxLQUFLLGlCQUFpQjtnQkFDbEIsT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUV2RCxLQUFLLHVCQUF1QjtnQkFDeEIsT0FBTztvQkFDSCxPQUFPLEVBQUUsS0FBSztvQkFDZCxFQUFFO29CQUNGLE1BQU0sRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLG1CQUFtQixFQUFFO2lCQUM5QyxDQUFDO1lBRU47Z0JBQ0ksT0FBTyxTQUFTLENBQUMsRUFBRSxFQUFFLENBQUMsS0FBSyxFQUFFLHFCQUFxQixPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUM1RSxDQUFDO0lBQ0wsQ0FBQztJQUVPLEtBQUssQ0FBQyxjQUFjLENBQUMsRUFBMEIsRUFBRSxNQUFXOztRQUNoRSxNQUFNLElBQUksR0FBRyxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUsSUFBSSxDQUFDO1FBQzFCLE1BQU0sSUFBSSxHQUFHLE1BQUEsTUFBTSxhQUFOLE1BQU0sdUJBQU4sTUFBTSxDQUFFLFNBQVMsbUNBQUksRUFBRSxDQUFDO1FBRXJDLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQztZQUNqRCxPQUFPLFNBQVMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxLQUFLLEVBQUUsa0NBQWtDLENBQUMsQ0FBQztRQUNyRSxDQUFDO1FBRUQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ1IsT0FBTyxTQUFTLENBQUMsRUFBRSxFQUFFLENBQUMsS0FBSyxFQUFFLGdDQUFnQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ3pFLENBQUM7UUFFRCxJQUFJLENBQUM7WUFDRCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDN0IsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDcEQsTUFBTSxPQUFPLEdBQUcsSUFBQSxtQkFBVSxHQUFFLENBQUM7WUFDN0IsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ2pGLElBQUksQ0FBQyxXQUFXLENBQUM7Z0JBQ2IsT0FBTztnQkFDUCxJQUFJLEVBQUUsSUFBSTtnQkFDVixTQUFTO2dCQUNULFVBQVUsRUFBRSxPQUFPLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFVBQVU7Z0JBQ3JELE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTztnQkFDdkIsU0FBUyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFBLE1BQUEsTUFBTSxDQUFDLEtBQUssMENBQUUsSUFBSSxtQ0FBSSxXQUFXLENBQUM7Z0JBQ3RFLFdBQVcsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQzthQUN4QyxDQUFDLENBQUM7WUFDSCxPQUFPO2dCQUNILE9BQU8sRUFBRSxLQUFLO2dCQUNkLEVBQUU7Z0JBQ0YsTUFBTSxFQUFFLE9BQU87YUFDbEIsQ0FBQztRQUNOLENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ2xCLE9BQU8sU0FBUyxDQUFDLEVBQUUsRUFBRSxDQUFDLEtBQUssRUFBRSxDQUFBLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxPQUFPLEtBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDbEUsQ0FBQztJQUNMLENBQUM7SUFFTyxpQkFBaUIsQ0FBQyxFQUEwQixFQUFFLE1BQVc7UUFDN0QsTUFBTSxJQUFJLEdBQUcsTUFBTSxhQUFOLE1BQU0sdUJBQU4sTUFBTSxDQUFFLElBQUksQ0FBQztRQUMxQixJQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVEsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUM7WUFDakQsT0FBTyxTQUFTLENBQUMsRUFBRSxFQUFFLENBQUMsS0FBSyxFQUFFLGtDQUFrQyxDQUFDLENBQUM7UUFDckUsQ0FBQztRQUVELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNaLE9BQU8sU0FBUyxDQUFDLEVBQUUsRUFBRSxDQUFDLEtBQUssRUFBRSxpQkFBaUIsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUMxRCxDQUFDO1FBRUQsT0FBTztZQUNILE9BQU8sRUFBRSxLQUFLO1lBQ2QsRUFBRTtZQUNGLE1BQU0sRUFBRSxRQUFRO1NBQ25CLENBQUM7SUFDTixDQUFDO0lBRU8sa0JBQWtCLENBQUMsRUFBMEIsRUFBRSxNQUFXO1FBQzlELE1BQU0sT0FBTyxHQUFHLE1BQU0sYUFBTixNQUFNLHVCQUFOLE1BQU0sQ0FBRSxPQUFPLENBQUM7UUFDaEMsSUFBSSxPQUFPLE9BQU8sS0FBSyxRQUFRLElBQUksT0FBTyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDO1lBQ3ZELE9BQU8sU0FBUyxDQUFDLEVBQUUsRUFBRSxDQUFDLEtBQUssRUFBRSxxQ0FBcUMsQ0FBQyxDQUFDO1FBQ3hFLENBQUM7UUFFRCxPQUFPO1lBQ0gsT0FBTyxFQUFFLEtBQUs7WUFDZCxFQUFFO1lBQ0YsTUFBTSxFQUFFO2dCQUNKLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJO2FBQzFDO1NBQ0osQ0FBQztJQUNOLENBQUM7SUFFTyxjQUFjLENBQ2xCLFFBQWdCLEVBQ2hCLE9BQWUsRUFDZixTQUFpQixFQUNqQixTQUFpQixFQUNqQixNQUFzQjtRQUV0QixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsU0FBUyxDQUFDO1FBQzFDLE1BQU0sSUFBSSxHQUFHO1lBQ1QsT0FBTztZQUNQLElBQUksRUFBRSxRQUFRO1lBQ2QsT0FBTyxFQUFFLFlBQVk7WUFDckIsVUFBVTtZQUNWLFNBQVM7U0FDWixDQUFDO1FBRUYsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLENBQUMsT0FBTztZQUNwQyxDQUFDLENBQUM7Z0JBQ0UsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJO2dCQUNqQixJQUFJO2FBQ1A7WUFDRCxDQUFDLENBQUM7Z0JBQ0UsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLO2dCQUNuQixJQUFJO2FBQ1AsQ0FBQztRQUVOLE9BQU87WUFDSCxPQUFPLEVBQUU7Z0JBQ0w7b0JBQ0ksSUFBSSxFQUFFLE1BQU07b0JBQ1osSUFBSSxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFdBQVcsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsUUFBUSxFQUFFO2lCQUN2RTthQUNKO1lBQ0QsaUJBQWlCO1lBQ2pCLE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPO1NBQzNCLENBQUM7SUFDTixDQUFDO0lBRU8sV0FBVyxDQUFDLEtBQXNCO1FBQ3RDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXBDLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ25ELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDdkMsSUFBSSxNQUFNLEVBQUUsQ0FBQztnQkFDVCxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMvQixDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUM7SUFFTyxhQUFhLENBQUMsSUFBUztRQUMzQixJQUFJLENBQUMsSUFBSSxJQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVEsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDM0QsT0FBTyxFQUFFLENBQUM7UUFDZCxDQUFDO1FBRUQsTUFBTSxPQUFPLEdBQTJCLEVBQUUsQ0FBQztRQUMzQyxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQzlDLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFLENBQUM7Z0JBQzVCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7Z0JBQ3hFLFNBQVM7WUFDYixDQUFDO1lBQ0QsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLElBQUksT0FBTyxLQUFLLEtBQUssU0FBUyxFQUFFLENBQUM7Z0JBQzFELE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQzdCLFNBQVM7WUFDYixDQUFDO1lBQ0QsSUFBSSxLQUFLLEtBQUssSUFBSSxFQUFFLENBQUM7Z0JBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUM7Z0JBQ3RCLFNBQVM7WUFDYixDQUFDO1lBQ0QsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQ3ZCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxTQUFTLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQztnQkFDeEMsU0FBUztZQUNiLENBQUM7WUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQzVCLENBQUM7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNuQixDQUFDO0NBQ0o7QUE1TUQsc0NBNE1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmFuZG9tVVVJRCB9IGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgeyBKc29uUnBjUmVxdWVzdE1lc3NhZ2UsIEpzb25ScGNSZXNwb25zZU1lc3NhZ2UsIE5leHRUb29sUmVzdWx0IH0gZnJvbSAnLi4vbW9kZWxzJztcbmltcG9ydCB7IE5leHRUb29sUmVnaXN0cnkgfSBmcm9tICcuL3Rvb2wtcmVnaXN0cnknO1xuXG5pbnRlcmZhY2UgTmV4dFRyYWNlUmVjb3JkIHtcbiAgICB0cmFjZUlkOiBzdHJpbmc7XG4gICAgdG9vbDogc3RyaW5nO1xuICAgIHRpbWVzdGFtcDogc3RyaW5nO1xuICAgIGR1cmF0aW9uTXM6IG51bWJlcjtcbiAgICBzdWNjZXNzOiBib29sZWFuO1xuICAgIGVycm9yQ29kZTogc3RyaW5nIHwgbnVsbDtcbiAgICBhcmdzU3VtbWFyeTogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbn1cblxuZnVuY3Rpb24gbWFrZUVycm9yKGlkOiBzdHJpbmcgfCBudW1iZXIgfCBudWxsLCBjb2RlOiBudW1iZXIsIG1lc3NhZ2U6IHN0cmluZywgZGF0YT86IGFueSk6IEpzb25ScGNSZXNwb25zZU1lc3NhZ2Uge1xuICAgIHJldHVybiB7XG4gICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICBpZCxcbiAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICAgIGNvZGUsXG4gICAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgICAgZGF0YVxuICAgICAgICB9XG4gICAgfTtcbn1cblxuZXhwb3J0IGNsYXNzIE5leHRNY3BSb3V0ZXIge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVnaXN0cnk6IE5leHRUb29sUmVnaXN0cnk7XG4gICAgcHJpdmF0ZSByZWFkb25seSB0cmFjZXMgPSBuZXcgTWFwPHN0cmluZywgTmV4dFRyYWNlUmVjb3JkPigpO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgdHJhY2VPcmRlcjogc3RyaW5nW10gPSBbXTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1heFRyYWNlUmVjb3JkczogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IocmVnaXN0cnk6IE5leHRUb29sUmVnaXN0cnksIG1heFRyYWNlUmVjb3JkczogbnVtYmVyID0gMzAwKSB7XG4gICAgICAgIHRoaXMucmVnaXN0cnkgPSByZWdpc3RyeTtcbiAgICAgICAgdGhpcy5tYXhUcmFjZVJlY29yZHMgPSBtYXhUcmFjZVJlY29yZHM7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGhhbmRsZShtZXNzYWdlOiBKc29uUnBjUmVxdWVzdE1lc3NhZ2UpOiBQcm9taXNlPEpzb25ScGNSZXNwb25zZU1lc3NhZ2UgfCBudWxsPiB7XG4gICAgICAgIGlmICghbWVzc2FnZSB8fCBtZXNzYWdlLmpzb25ycGMgIT09ICcyLjAnIHx8IHR5cGVvZiBtZXNzYWdlLm1ldGhvZCAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHJldHVybiBtYWtlRXJyb3IobnVsbCwgLTMyNjAwLCAnSW52YWxpZCBSZXF1ZXN0Jyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBpc05vdGlmaWNhdGlvbiA9IG1lc3NhZ2UuaWQgPT09IHVuZGVmaW5lZDtcbiAgICAgICAgaWYgKGlzTm90aWZpY2F0aW9uKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGlkID0gbWVzc2FnZS5pZCA/PyBudWxsO1xuXG4gICAgICAgIHN3aXRjaCAobWVzc2FnZS5tZXRob2QpIHtcbiAgICAgICAgICAgIGNhc2UgJ3Rvb2xzL2xpc3QnOlxuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgICAgICBpZCxcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b29sczogdGhpcy5yZWdpc3RyeS5saXN0VG9vbHMoKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgY2FzZSAndG9vbHMvY2FsbCc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuaGFuZGxlVG9vbENhbGwoaWQsIG1lc3NhZ2UucGFyYW1zKTtcblxuICAgICAgICAgICAgY2FzZSAnZ2V0X3Rvb2xfbWFuaWZlc3QnOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmhhbmRsZUdldE1hbmlmZXN0KGlkLCBtZXNzYWdlLnBhcmFtcyk7XG5cbiAgICAgICAgICAgIGNhc2UgJ2dldF90cmFjZV9ieV9pZCc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlR2V0VHJhY2VCeUlkKGlkLCBtZXNzYWdlLnBhcmFtcyk7XG5cbiAgICAgICAgICAgIGNhc2UgJ2dldF9jYXBhYmlsaXR5X21hdHJpeCc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAganNvbnJwYzogJzIuMCcsXG4gICAgICAgICAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IHRoaXMucmVnaXN0cnkuZ2V0Q2FwYWJpbGl0eU1hdHJpeCgpXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gbWFrZUVycm9yKGlkLCAtMzI2MDEsIGBNZXRob2Qgbm90IGZvdW5kOiAke21lc3NhZ2UubWV0aG9kfWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBoYW5kbGVUb29sQ2FsbChpZDogc3RyaW5nIHwgbnVtYmVyIHwgbnVsbCwgcGFyYW1zOiBhbnkpOiBQcm9taXNlPEpzb25ScGNSZXNwb25zZU1lc3NhZ2U+IHtcbiAgICAgICAgY29uc3QgbmFtZSA9IHBhcmFtcz8ubmFtZTtcbiAgICAgICAgY29uc3QgYXJncyA9IHBhcmFtcz8uYXJndW1lbnRzID8/IHt9O1xuXG4gICAgICAgIGlmICh0eXBlb2YgbmFtZSAhPT0gJ3N0cmluZycgfHwgbmFtZS50cmltKCkgPT09ICcnKSB7XG4gICAgICAgICAgICByZXR1cm4gbWFrZUVycm9yKGlkLCAtMzI2MDIsICdJbnZhbGlkIHBhcmFtczogbmFtZSBpcyByZXF1aXJlZCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdG9vbCA9IHRoaXMucmVnaXN0cnkuZ2V0VG9vbChuYW1lKTtcbiAgICAgICAgaWYgKCF0b29sKSB7XG4gICAgICAgICAgICByZXR1cm4gbWFrZUVycm9yKGlkLCAtMzI2MDIsIGBVbmtub3duIG9yIHVuYXZhaWxhYmxlIHRvb2w6ICR7bmFtZX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBzdGFydGVkQXQgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoc3RhcnRlZEF0KS50b0lTT1N0cmluZygpO1xuICAgICAgICAgICAgY29uc3QgdHJhY2VJZCA9IHJhbmRvbVVVSUQoKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRvb2wucnVuKGFyZ3MpO1xuICAgICAgICAgICAgY29uc3Qgd3JhcHBlZCA9IHRoaXMud3JhcFRvb2xSZXN1bHQobmFtZSwgdHJhY2VJZCwgc3RhcnRlZEF0LCB0aW1lc3RhbXAsIHJlc3VsdCk7XG4gICAgICAgICAgICB0aGlzLnJlY29yZFRyYWNlKHtcbiAgICAgICAgICAgICAgICB0cmFjZUlkLFxuICAgICAgICAgICAgICAgIHRvb2w6IG5hbWUsXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wLFxuICAgICAgICAgICAgICAgIGR1cmF0aW9uTXM6IHdyYXBwZWQuc3RydWN0dXJlZENvbnRlbnQubWV0YS5kdXJhdGlvbk1zLFxuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHJlc3VsdC5zdWNjZXNzLFxuICAgICAgICAgICAgICAgIGVycm9yQ29kZTogcmVzdWx0LnN1Y2Nlc3MgPyBudWxsIDogKHJlc3VsdC5lcnJvcj8uY29kZSA/PyAnRV9VTktOT1dOJyksXG4gICAgICAgICAgICAgICAgYXJnc1N1bW1hcnk6IHRoaXMuc3VtbWFyaXplQXJncyhhcmdzKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgICAgIHJlc3VsdDogd3JhcHBlZFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgICAgICAgcmV0dXJuIG1ha2VFcnJvcihpZCwgLTMyNjAzLCBlcnJvcj8ubWVzc2FnZSB8fCBTdHJpbmcoZXJyb3IpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlR2V0TWFuaWZlc3QoaWQ6IHN0cmluZyB8IG51bWJlciB8IG51bGwsIHBhcmFtczogYW55KTogSnNvblJwY1Jlc3BvbnNlTWVzc2FnZSB7XG4gICAgICAgIGNvbnN0IG5hbWUgPSBwYXJhbXM/Lm5hbWU7XG4gICAgICAgIGlmICh0eXBlb2YgbmFtZSAhPT0gJ3N0cmluZycgfHwgbmFtZS50cmltKCkgPT09ICcnKSB7XG4gICAgICAgICAgICByZXR1cm4gbWFrZUVycm9yKGlkLCAtMzI2MDIsICdJbnZhbGlkIHBhcmFtczogbmFtZSBpcyByZXF1aXJlZCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbWFuaWZlc3QgPSB0aGlzLnJlZ2lzdHJ5LmdldE1hbmlmZXN0KG5hbWUpO1xuICAgICAgICBpZiAoIW1hbmlmZXN0KSB7XG4gICAgICAgICAgICByZXR1cm4gbWFrZUVycm9yKGlkLCAtMzI2MDIsIGBVbmtub3duIHRvb2w6ICR7bmFtZX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgcmVzdWx0OiBtYW5pZmVzdFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlR2V0VHJhY2VCeUlkKGlkOiBzdHJpbmcgfCBudW1iZXIgfCBudWxsLCBwYXJhbXM6IGFueSk6IEpzb25ScGNSZXNwb25zZU1lc3NhZ2Uge1xuICAgICAgICBjb25zdCB0cmFjZUlkID0gcGFyYW1zPy50cmFjZUlkO1xuICAgICAgICBpZiAodHlwZW9mIHRyYWNlSWQgIT09ICdzdHJpbmcnIHx8IHRyYWNlSWQudHJpbSgpID09PSAnJykge1xuICAgICAgICAgICAgcmV0dXJuIG1ha2VFcnJvcihpZCwgLTMyNjAyLCAnSW52YWxpZCBwYXJhbXM6IHRyYWNlSWQgaXMgcmVxdWlyZWQnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgcmVzdWx0OiB7XG4gICAgICAgICAgICAgICAgdHJhY2U6IHRoaXMudHJhY2VzLmdldCh0cmFjZUlkKSB8fCBudWxsXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB3cmFwVG9vbFJlc3VsdChcbiAgICAgICAgdG9vbE5hbWU6IHN0cmluZyxcbiAgICAgICAgdHJhY2VJZDogc3RyaW5nLFxuICAgICAgICBzdGFydGVkQXQ6IG51bWJlcixcbiAgICAgICAgdGltZXN0YW1wOiBzdHJpbmcsXG4gICAgICAgIHJlc3VsdDogTmV4dFRvb2xSZXN1bHRcbiAgICApOiBhbnkge1xuICAgICAgICBjb25zdCBkdXJhdGlvbk1zID0gRGF0ZS5ub3coKSAtIHN0YXJ0ZWRBdDtcbiAgICAgICAgY29uc3QgbWV0YSA9IHtcbiAgICAgICAgICAgIHRyYWNlSWQsXG4gICAgICAgICAgICB0b29sOiB0b29sTmFtZSxcbiAgICAgICAgICAgIHZlcnNpb246ICduZXh0LTAuMS4wJyxcbiAgICAgICAgICAgIGR1cmF0aW9uTXMsXG4gICAgICAgICAgICB0aW1lc3RhbXBcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBzdHJ1Y3R1cmVkQ29udGVudCA9IHJlc3VsdC5zdWNjZXNzXG4gICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgICAgIGRhdGE6IHJlc3VsdC5kYXRhLFxuICAgICAgICAgICAgICAgIG1ldGFcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIDoge1xuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGVycm9yOiByZXN1bHQuZXJyb3IsXG4gICAgICAgICAgICAgICAgbWV0YVxuICAgICAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29udGVudDogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3RleHQnLFxuICAgICAgICAgICAgICAgICAgICB0ZXh0OiByZXN1bHQuc3VjY2VzcyA/IGDlt6XlhbfmiafooYzmiJDlip86ICR7dG9vbE5hbWV9YCA6IGDlt6XlhbfmiafooYzlpLHotKU6ICR7dG9vbE5hbWV9YFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBzdHJ1Y3R1cmVkQ29udGVudCxcbiAgICAgICAgICAgIGlzRXJyb3I6ICFyZXN1bHQuc3VjY2Vzc1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVjb3JkVHJhY2UodHJhY2U6IE5leHRUcmFjZVJlY29yZCk6IHZvaWQge1xuICAgICAgICB0aGlzLnRyYWNlcy5zZXQodHJhY2UudHJhY2VJZCwgdHJhY2UpO1xuICAgICAgICB0aGlzLnRyYWNlT3JkZXIucHVzaCh0cmFjZS50cmFjZUlkKTtcblxuICAgICAgICB3aGlsZSAodGhpcy50cmFjZU9yZGVyLmxlbmd0aCA+IHRoaXMubWF4VHJhY2VSZWNvcmRzKSB7XG4gICAgICAgICAgICBjb25zdCBvbGRlc3QgPSB0aGlzLnRyYWNlT3JkZXIuc2hpZnQoKTtcbiAgICAgICAgICAgIGlmIChvbGRlc3QpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnRyYWNlcy5kZWxldGUob2xkZXN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgc3VtbWFyaXplQXJncyhhcmdzOiBhbnkpOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+IHtcbiAgICAgICAgaWYgKCFhcmdzIHx8IHR5cGVvZiBhcmdzICE9PSAnb2JqZWN0JyB8fCBBcnJheS5pc0FycmF5KGFyZ3MpKSB7XG4gICAgICAgICAgICByZXR1cm4ge307XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzdW1tYXJ5OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG4gICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGFyZ3MpKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIHN1bW1hcnlba2V5XSA9IHZhbHVlLmxlbmd0aCA+IDEyMCA/IGAke3ZhbHVlLnNsaWNlKDAsIDExNyl9Li4uYCA6IHZhbHVlO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgfHwgdHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgICAgICAgICBzdW1tYXJ5W2tleV0gPSBTdHJpbmcodmFsdWUpO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgc3VtbWFyeVtrZXldID0gJ251bGwnO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgc3VtbWFyeVtrZXldID0gYGFycmF5KCR7dmFsdWUubGVuZ3RofSlgO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3VtbWFyeVtrZXldID0gJ29iamVjdCc7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN1bW1hcnk7XG4gICAgfVxufVxuIl19