"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolveNodeUuid = resolveNodeUuid;
exports.queryPrefabInstanceInfo = queryPrefabInstanceInfo;
exports.buildCreateNodeCandidates = buildCreateNodeCandidates;
exports.resolveNodeAssetType = resolveNodeAssetType;
const common_1 = require("./common");
function unwrapValue(value) {
    if (value && typeof value === 'object' && 'value' in value) {
        return value.value;
    }
    return value;
}
function readNodeName(node) {
    return (0, common_1.readDumpString)(node === null || node === void 0 ? void 0 : node.name) || null;
}
function readPrefabState(prefab) {
    const raw = unwrapValue(prefab === null || prefab === void 0 ? void 0 : prefab.state);
    return typeof raw === 'number' ? raw : null;
}
function readPrefabAssetUuid(prefab) {
    const direct = (0, common_1.readDumpString)(prefab === null || prefab === void 0 ? void 0 : prefab.assetUuid)
        || (0, common_1.readDumpString)(prefab === null || prefab === void 0 ? void 0 : prefab.prefabUuid)
        || (0, common_1.readDumpString)(prefab === null || prefab === void 0 ? void 0 : prefab.uuid)
        || (0, common_1.readDumpString)(prefab === null || prefab === void 0 ? void 0 : prefab.__uuid__);
    if (direct) {
        return direct;
    }
    const nestedAsset = prefab === null || prefab === void 0 ? void 0 : prefab.asset;
    const nested = (0, common_1.readDumpString)(nestedAsset === null || nestedAsset === void 0 ? void 0 : nestedAsset.uuid)
        || (0, common_1.readDumpString)(nestedAsset === null || nestedAsset === void 0 ? void 0 : nestedAsset.__uuid__)
        || (0, common_1.readDumpString)(nestedAsset === null || nestedAsset === void 0 ? void 0 : nestedAsset.assetUuid)
        || (0, common_1.readDumpString)(unwrapValue(nestedAsset));
    return nested || null;
}
function readPrefabContainer(node) {
    if (!node || typeof node !== 'object') {
        return null;
    }
    return node.prefab
        || node._prefabInstance
        || node.__prefab__
        || node._prefab
        || null;
}
function resolveNodeUuid(result) {
    var _a, _b;
    if (typeof result === 'string' && result.trim() !== '') {
        return result.trim();
    }
    if (Array.isArray(result) && typeof result[0] === 'string' && result[0].trim() !== '') {
        return result[0].trim();
    }
    if (result && typeof result === 'object') {
        const direct = (0, common_1.readDumpString)(result.uuid)
            || (0, common_1.readDumpString)(result.nodeUuid)
            || (0, common_1.readDumpString)(result.id)
            || (0, common_1.readDumpString)(result.value);
        if (direct) {
            return direct;
        }
        const nested = (0, common_1.readDumpString)((_a = result.node) === null || _a === void 0 ? void 0 : _a.uuid)
            || (0, common_1.readDumpString)((_b = result.node) === null || _b === void 0 ? void 0 : _b.nodeUuid);
        if (nested) {
            return nested;
        }
    }
    return null;
}
async function queryPrefabInstanceInfo(requester, nodeUuid) {
    const node = await requester('scene', 'query-node', nodeUuid);
    const prefab = readPrefabContainer(node);
    const prefabAssetUuid = readPrefabAssetUuid(prefab);
    const prefabState = readPrefabState(prefab);
    const hasPrefabSignal = Boolean(prefab)
        || Object.prototype.hasOwnProperty.call(node || {}, 'prefab')
        || Object.prototype.hasOwnProperty.call(node || {}, '_prefabInstance')
        || Object.prototype.hasOwnProperty.call(node || {}, '__prefab__')
        || Object.prototype.hasOwnProperty.call(node || {}, '_prefab');
    const isPrefabInstance = Boolean(prefabAssetUuid)
        || (typeof prefabState === 'number' && prefabState > 0)
        || hasPrefabSignal;
    return {
        nodeUuid,
        nodeName: readNodeName(node),
        isPrefabInstance,
        prefabState,
        prefabAssetUuid,
        prefab,
        node
    };
}
function buildCreateNodeCandidates(baseOptions, assetType) {
    const candidates = [];
    const seen = new Set();
    const tryAdd = (candidate) => {
        const key = JSON.stringify(candidate);
        if (!seen.has(key)) {
            seen.add(key);
            candidates.push(candidate);
        }
    };
    tryAdd(Object.assign({}, baseOptions));
    if (assetType) {
        tryAdd(Object.assign(Object.assign({}, baseOptions), { type: assetType }));
    }
    const rawAssetUuid = baseOptions.assetUuid;
    if (typeof rawAssetUuid === 'string' && rawAssetUuid.trim() !== '') {
        const wrappedValue = { value: rawAssetUuid };
        if (assetType) {
            wrappedValue.type = assetType;
        }
        tryAdd(Object.assign(Object.assign({}, baseOptions), { assetUuid: wrappedValue }));
        const wrappedUuid = { uuid: rawAssetUuid };
        if (assetType) {
            wrappedUuid.type = assetType;
        }
        tryAdd(Object.assign(Object.assign({}, baseOptions), { assetUuid: wrappedUuid }));
    }
    return candidates;
}
function resolveNodeAssetType(assetInfo) {
    return (0, common_1.toNonEmptyString)(assetInfo === null || assetInfo === void 0 ? void 0 : assetInfo.type);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlZmFiLWluc3RhbmNlLXV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc291cmNlL25leHQvdG9vbHMvcHJlZmFiLWluc3RhbmNlLXV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBZ0RBLDBDQTBCQztBQVlELDBEQXVCQztBQUVELDhEQWtDQztBQUVELG9EQUVDO0FBcEpELHFDQUE0RDtBQUU1RCxTQUFTLFdBQVcsQ0FBQyxLQUFVO0lBQzNCLElBQUksS0FBSyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsSUFBSSxPQUFPLElBQUksS0FBSyxFQUFFLENBQUM7UUFDekQsT0FBUSxLQUF3QixDQUFDLEtBQUssQ0FBQztJQUMzQyxDQUFDO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDakIsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLElBQVM7SUFDM0IsT0FBTyxJQUFBLHVCQUFjLEVBQUMsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQztBQUM5QyxDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUMsTUFBVztJQUNoQyxNQUFNLEdBQUcsR0FBRyxXQUFXLENBQUMsTUFBTSxhQUFOLE1BQU0sdUJBQU4sTUFBTSxDQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3ZDLE9BQU8sT0FBTyxHQUFHLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztBQUNoRCxDQUFDO0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxNQUFXO0lBQ3BDLE1BQU0sTUFBTSxHQUFHLElBQUEsdUJBQWMsRUFBQyxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUsU0FBUyxDQUFDO1dBQ3pDLElBQUEsdUJBQWMsRUFBQyxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUsVUFBVSxDQUFDO1dBQ2xDLElBQUEsdUJBQWMsRUFBQyxNQUFNLGFBQU4sTUFBTSx1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IjpbImltcG9ydCB7IEVkaXRvclJlcXVlc3RlciB9IGZyb20gJy4uL21vZGVscyc7XG5pbXBvcnQgeyByZWFkRHVtcFN0cmluZywgdG9Ob25FbXB0eVN0cmluZyB9IGZyb20gJy4vY29tbW9uJztcblxuZnVuY3Rpb24gdW53cmFwVmFsdWUodmFsdWU6IGFueSk6IGFueSB7XG4gICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgJ3ZhbHVlJyBpbiB2YWx1ZSkge1xuICAgICAgICByZXR1cm4gKHZhbHVlIGFzIHsgdmFsdWU6IGFueSB9KS52YWx1ZTtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xufVxuXG5mdW5jdGlvbiByZWFkTm9kZU5hbWUobm9kZTogYW55KTogc3RyaW5nIHwgbnVsbCB7XG4gICAgcmV0dXJuIHJlYWREdW1wU3RyaW5nKG5vZGU/Lm5hbWUpIHx8IG51bGw7XG59XG5cbmZ1bmN0aW9uIHJlYWRQcmVmYWJTdGF0ZShwcmVmYWI6IGFueSk6IG51bWJlciB8IG51bGwge1xuICAgIGNvbnN0IHJhdyA9IHVud3JhcFZhbHVlKHByZWZhYj8uc3RhdGUpO1xuICAgIHJldHVybiB0eXBlb2YgcmF3ID09PSAnbnVtYmVyJyA/IHJhdyA6IG51bGw7XG59XG5cbmZ1bmN0aW9uIHJlYWRQcmVmYWJBc3NldFV1aWQocHJlZmFiOiBhbnkpOiBzdHJpbmcgfCBudWxsIHtcbiAgICBjb25zdCBkaXJlY3QgPSByZWFkRHVtcFN0cmluZyhwcmVmYWI/LmFzc2V0VXVpZClcbiAgICAgICAgfHwgcmVhZER1bXBTdHJpbmcocHJlZmFiPy5wcmVmYWJVdWlkKVxuICAgICAgICB8fCByZWFkRHVtcFN0cmluZyhwcmVmYWI/LnV1aWQpXG4gICAgICAgIHx8IHJlYWREdW1wU3RyaW5nKHByZWZhYj8uX191dWlkX18pO1xuICAgIGlmIChkaXJlY3QpIHtcbiAgICAgICAgcmV0dXJuIGRpcmVjdDtcbiAgICB9XG5cbiAgICBjb25zdCBuZXN0ZWRBc3NldCA9IHByZWZhYj8uYXNzZXQ7XG4gICAgY29uc3QgbmVzdGVkID0gcmVhZER1bXBTdHJpbmcobmVzdGVkQXNzZXQ/LnV1aWQpXG4gICAgICAgIHx8IHJlYWREdW1wU3RyaW5nKG5lc3RlZEFzc2V0Py5fX3V1aWRfXylcbiAgICAgICAgfHwgcmVhZER1bXBTdHJpbmcobmVzdGVkQXNzZXQ/LmFzc2V0VXVpZClcbiAgICAgICAgfHwgcmVhZER1bXBTdHJpbmcodW53cmFwVmFsdWUobmVzdGVkQXNzZXQpKTtcbiAgICByZXR1cm4gbmVzdGVkIHx8IG51bGw7XG59XG5cbmZ1bmN0aW9uIHJlYWRQcmVmYWJDb250YWluZXIobm9kZTogYW55KTogYW55IHtcbiAgICBpZiAoIW5vZGUgfHwgdHlwZW9mIG5vZGUgIT09ICdvYmplY3QnKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiBub2RlLnByZWZhYlxuICAgICAgICB8fCBub2RlLl9wcmVmYWJJbnN0YW5jZVxuICAgICAgICB8fCBub2RlLl9fcHJlZmFiX19cbiAgICAgICAgfHwgbm9kZS5fcHJlZmFiXG4gICAgICAgIHx8IG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXNvbHZlTm9kZVV1aWQocmVzdWx0OiBhbnkpOiBzdHJpbmcgfCBudWxsIHtcbiAgICBpZiAodHlwZW9mIHJlc3VsdCA9PT0gJ3N0cmluZycgJiYgcmVzdWx0LnRyaW0oKSAhPT0gJycpIHtcbiAgICAgICAgcmV0dXJuIHJlc3VsdC50cmltKCk7XG4gICAgfVxuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSAmJiB0eXBlb2YgcmVzdWx0WzBdID09PSAnc3RyaW5nJyAmJiByZXN1bHRbMF0udHJpbSgpICE9PSAnJykge1xuICAgICAgICByZXR1cm4gcmVzdWx0WzBdLnRyaW0oKTtcbiAgICB9XG5cbiAgICBpZiAocmVzdWx0ICYmIHR5cGVvZiByZXN1bHQgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIGNvbnN0IGRpcmVjdCA9IHJlYWREdW1wU3RyaW5nKHJlc3VsdC51dWlkKVxuICAgICAgICAgICAgfHwgcmVhZER1bXBTdHJpbmcocmVzdWx0Lm5vZGVVdWlkKVxuICAgICAgICAgICAgfHwgcmVhZER1bXBTdHJpbmcocmVzdWx0LmlkKVxuICAgICAgICAgICAgfHwgcmVhZER1bXBTdHJpbmcocmVzdWx0LnZhbHVlKTtcbiAgICAgICAgaWYgKGRpcmVjdCkge1xuICAgICAgICAgICAgcmV0dXJuIGRpcmVjdDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG5lc3RlZCA9IHJlYWREdW1wU3RyaW5nKHJlc3VsdC5ub2RlPy51dWlkKVxuICAgICAgICAgICAgfHwgcmVhZER1bXBTdHJpbmcocmVzdWx0Lm5vZGU/Lm5vZGVVdWlkKTtcbiAgICAgICAgaWYgKG5lc3RlZCkge1xuICAgICAgICAgICAgcmV0dXJuIG5lc3RlZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFByZWZhYkluc3RhbmNlSW5mbyB7XG4gICAgbm9kZVV1aWQ6IHN0cmluZztcbiAgICBub2RlTmFtZTogc3RyaW5nIHwgbnVsbDtcbiAgICBpc1ByZWZhYkluc3RhbmNlOiBib29sZWFuO1xuICAgIHByZWZhYlN0YXRlOiBudW1iZXIgfCBudWxsO1xuICAgIHByZWZhYkFzc2V0VXVpZDogc3RyaW5nIHwgbnVsbDtcbiAgICBwcmVmYWI6IGFueTtcbiAgICBub2RlOiBhbnk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBxdWVyeVByZWZhYkluc3RhbmNlSW5mbyhyZXF1ZXN0ZXI6IEVkaXRvclJlcXVlc3Rlciwgbm9kZVV1aWQ6IHN0cmluZyk6IFByb21pc2U8UHJlZmFiSW5zdGFuY2VJbmZvPiB7XG4gICAgY29uc3Qgbm9kZSA9IGF3YWl0IHJlcXVlc3Rlcignc2NlbmUnLCAncXVlcnktbm9kZScsIG5vZGVVdWlkKTtcbiAgICBjb25zdCBwcmVmYWIgPSByZWFkUHJlZmFiQ29udGFpbmVyKG5vZGUpO1xuICAgIGNvbnN0IHByZWZhYkFzc2V0VXVpZCA9IHJlYWRQcmVmYWJBc3NldFV1aWQocHJlZmFiKTtcbiAgICBjb25zdCBwcmVmYWJTdGF0ZSA9IHJlYWRQcmVmYWJTdGF0ZShwcmVmYWIpO1xuICAgIGNvbnN0IGhhc1ByZWZhYlNpZ25hbCA9IEJvb2xlYW4ocHJlZmFiKVxuICAgICAgICB8fCBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobm9kZSB8fCB7fSwgJ3ByZWZhYicpXG4gICAgICAgIHx8IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChub2RlIHx8IHt9LCAnX3ByZWZhYkluc3RhbmNlJylcbiAgICAgICAgfHwgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG5vZGUgfHwge30sICdfX3ByZWZhYl9fJylcbiAgICAgICAgfHwgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG5vZGUgfHwge30sICdfcHJlZmFiJyk7XG4gICAgY29uc3QgaXNQcmVmYWJJbnN0YW5jZSA9IEJvb2xlYW4ocHJlZmFiQXNzZXRVdWlkKVxuICAgICAgICB8fCAodHlwZW9mIHByZWZhYlN0YXRlID09PSAnbnVtYmVyJyAmJiBwcmVmYWJTdGF0ZSA+IDApXG4gICAgICAgIHx8IGhhc1ByZWZhYlNpZ25hbDtcblxuICAgIHJldHVybiB7XG4gICAgICAgIG5vZGVVdWlkLFxuICAgICAgICBub2RlTmFtZTogcmVhZE5vZGVOYW1lKG5vZGUpLFxuICAgICAgICBpc1ByZWZhYkluc3RhbmNlLFxuICAgICAgICBwcmVmYWJTdGF0ZSxcbiAgICAgICAgcHJlZmFiQXNzZXRVdWlkLFxuICAgICAgICBwcmVmYWIsXG4gICAgICAgIG5vZGVcbiAgICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRDcmVhdGVOb2RlQ2FuZGlkYXRlcyhiYXNlT3B0aW9uczogUmVjb3JkPHN0cmluZywgYW55PiwgYXNzZXRUeXBlOiBzdHJpbmcgfCBudWxsKTogQXJyYXk8UmVjb3JkPHN0cmluZywgYW55Pj4ge1xuICAgIGNvbnN0IGNhbmRpZGF0ZXM6IEFycmF5PFJlY29yZDxzdHJpbmcsIGFueT4+ID0gW107XG4gICAgY29uc3Qgc2VlbiA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuXG4gICAgY29uc3QgdHJ5QWRkID0gKGNhbmRpZGF0ZTogUmVjb3JkPHN0cmluZywgYW55Pik6IHZvaWQgPT4ge1xuICAgICAgICBjb25zdCBrZXkgPSBKU09OLnN0cmluZ2lmeShjYW5kaWRhdGUpO1xuICAgICAgICBpZiAoIXNlZW4uaGFzKGtleSkpIHtcbiAgICAgICAgICAgIHNlZW4uYWRkKGtleSk7XG4gICAgICAgICAgICBjYW5kaWRhdGVzLnB1c2goY2FuZGlkYXRlKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICB0cnlBZGQoeyAuLi5iYXNlT3B0aW9ucyB9KTtcblxuICAgIGlmIChhc3NldFR5cGUpIHtcbiAgICAgICAgdHJ5QWRkKHsgLi4uYmFzZU9wdGlvbnMsIHR5cGU6IGFzc2V0VHlwZSB9KTtcbiAgICB9XG5cbiAgICBjb25zdCByYXdBc3NldFV1aWQgPSBiYXNlT3B0aW9ucy5hc3NldFV1aWQ7XG4gICAgaWYgKHR5cGVvZiByYXdBc3NldFV1aWQgPT09ICdzdHJpbmcnICYmIHJhd0Fzc2V0VXVpZC50cmltKCkgIT09ICcnKSB7XG4gICAgICAgIGNvbnN0IHdyYXBwZWRWYWx1ZTogUmVjb3JkPHN0cmluZywgYW55PiA9IHsgdmFsdWU6IHJhd0Fzc2V0VXVpZCB9O1xuICAgICAgICBpZiAoYXNzZXRUeXBlKSB7XG4gICAgICAgICAgICB3cmFwcGVkVmFsdWUudHlwZSA9IGFzc2V0VHlwZTtcbiAgICAgICAgfVxuICAgICAgICB0cnlBZGQoeyAuLi5iYXNlT3B0aW9ucywgYXNzZXRVdWlkOiB3cmFwcGVkVmFsdWUgfSk7XG5cbiAgICAgICAgY29uc3Qgd3JhcHBlZFV1aWQ6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7IHV1aWQ6IHJhd0Fzc2V0VXVpZCB9O1xuICAgICAgICBpZiAoYXNzZXRUeXBlKSB7XG4gICAgICAgICAgICB3cmFwcGVkVXVpZC50eXBlID0gYXNzZXRUeXBlO1xuICAgICAgICB9XG4gICAgICAgIHRyeUFkZCh7IC4uLmJhc2VPcHRpb25zLCBhc3NldFV1aWQ6IHdyYXBwZWRVdWlkIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBjYW5kaWRhdGVzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVzb2x2ZU5vZGVBc3NldFR5cGUoYXNzZXRJbmZvOiBhbnkpOiBzdHJpbmcgfCBudWxsIHtcbiAgICByZXR1cm4gdG9Ob25FbXB0eVN0cmluZyhhc3NldEluZm8/LnR5cGUpO1xufVxuIl19