"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.linkPrefabToNodeByMessage = linkPrefabToNodeByMessage;
exports.replaceNodeWithPrefabInstance = replaceNodeWithPrefabInstance;
const common_1 = require("./common");
const prefab_instance_utils_1 = require("./prefab-instance-utils");
function readParentUuid(node) {
    var _a, _b, _c, _d, _e, _f, _g, _h;
    const candidates = [
        (0, common_1.readDumpString)((_b = (_a = node === null || node === void 0 ? void 0 : node.parent) === null || _a === void 0 ? void 0 : _a.value) === null || _b === void 0 ? void 0 : _b.uuid),
        (0, common_1.readDumpString)((_c = node === null || node === void 0 ? void 0 : node.parent) === null || _c === void 0 ? void 0 : _c.uuid),
        (0, common_1.readDumpString)((_e = (_d = node === null || node === void 0 ? void 0 : node._parent) === null || _d === void 0 ? void 0 : _d.value) === null || _e === void 0 ? void 0 : _e.uuid),
        (0, common_1.readDumpString)((_f = node === null || node === void 0 ? void 0 : node._parent) === null || _f === void 0 ? void 0 : _f.uuid),
        (0, common_1.readDumpString)((_g = (0, common_1.unwrapDumpValue)(node === null || node === void 0 ? void 0 : node.parent)) === null || _g === void 0 ? void 0 : _g.uuid),
        (0, common_1.readDumpString)((_h = (0, common_1.unwrapDumpValue)(node === null || node === void 0 ? void 0 : node._parent)) === null || _h === void 0 ? void 0 : _h.uuid)
    ];
    const matched = candidates.find((item) => Boolean(item));
    return matched || null;
}
function readNodeName(node) {
    return (0, common_1.readDumpString)(node === null || node === void 0 ? void 0 : node.name)
        || (0, common_1.readDumpString)(node === null || node === void 0 ? void 0 : node._name)
        || null;
}
function readVec3(node, key) {
    const raw = (0, common_1.unwrapDumpValue)(node === null || node === void 0 ? void 0 : node[key]);
    if (!raw || typeof raw !== 'object') {
        return null;
    }
    const x = Number(raw.x);
    const y = Number(raw.y);
    const z = Number(raw.z);
    if (!Number.isFinite(x) || !Number.isFinite(y) || !Number.isFinite(z)) {
        return null;
    }
    return { x, y, z };
}
function readChildrenUuids(node) {
    var _a;
    const children = Array.isArray(node === null || node === void 0 ? void 0 : node.children) ? node.children : [];
    const uuids = [];
    for (const child of children) {
        if (typeof child === 'string' && child.trim() !== '') {
            uuids.push(child.trim());
            continue;
        }
        const childUuid = (0, common_1.readDumpString)(child === null || child === void 0 ? void 0 : child.uuid)
            || (0, common_1.readDumpString)((_a = child === null || child === void 0 ? void 0 : child.value) === null || _a === void 0 ? void 0 : _a.uuid)
            || (0, common_1.readDumpString)(child === null || child === void 0 ? void 0 : child.nodeUuid)
            || (0, common_1.readDumpString)(child === null || child === void 0 ? void 0 : child.id);
        if (childUuid) {
            uuids.push(childUuid);
        }
    }
    return Array.from(new Set(uuids));
}
async function trySetVec3Property(requester, nodeUuid, path, value) {
    try {
        await requester('scene', 'set-property', {
            uuid: nodeUuid,
            path,
            dump: {
                type: 'cc.Vec3',
                value
            }
        });
        return null;
    }
    catch (error) {
        return (0, common_1.normalizeError)(error);
    }
}
async function removeNodeQuietly(requester, nodeUuid) {
    try {
        await requester('scene', 'remove-node', { uuid: nodeUuid });
    }
    catch (_a) {
        // ignore cleanup error
    }
}
function buildReplacementCreateCandidates(assetUuid, parentUuid, name, position, assetType) {
    const baseVariants = [
        {
            assetUuid,
            parent: parentUuid || undefined,
            keepWorldTransform: true
        },
        {
            assetUuid,
            parent: parentUuid || undefined,
            position: position || undefined,
            keepWorldTransform: true
        },
        {
            assetUuid,
            parent: parentUuid || undefined,
            name: name || undefined,
            keepWorldTransform: true
        },
        {
            assetUuid,
            parent: parentUuid || undefined,
            name: name || undefined,
            position: position || undefined,
            keepWorldTransform: true
        }
    ];
    const seen = new Set();
    const candidates = [];
    let counter = 0;
    for (let baseIndex = 0; baseIndex < baseVariants.length; baseIndex += 1) {
        const built = (0, prefab_instance_utils_1.buildCreateNodeCandidates)(baseVariants[baseIndex], assetType);
        for (const options of built) {
            const key = JSON.stringify(options);
            if (seen.has(key)) {
                continue;
            }
            seen.add(key);
            counter += 1;
            candidates.push({
                options,
                label: `create-node#${counter}(base:${baseIndex + 1})`
            });
        }
    }
    return candidates;
}
async function linkPrefabToNodeByMessage(requester, nodeUuid, assetUuid) {
    const attempts = [
        { method: 'link-prefab', args: [nodeUuid, assetUuid], label: 'link-prefab(nodeUuid, assetUuid)' },
        { method: 'link-prefab', args: [{ uuid: nodeUuid, assetUuid }], label: 'link-prefab({uuid,assetUuid})' },
        { method: 'link-prefab', args: [{ node: nodeUuid, prefab: assetUuid }], label: 'link-prefab({node,prefab})' },
        { method: 'restore-prefab', args: [nodeUuid, assetUuid], label: 'restore-prefab(nodeUuid, assetUuid)' },
        { method: 'restore-prefab', args: [{ uuid: nodeUuid, assetUuid }], label: 'restore-prefab({uuid,assetUuid})' },
        { method: 'restore-prefab', args: [nodeUuid], label: 'restore-prefab(nodeUuid)' },
        { method: 'restore-prefab', args: [{ uuid: nodeUuid }], label: 'restore-prefab({uuid})' }
    ];
    const errors = [];
    for (const attempt of attempts) {
        try {
            await requester('scene', attempt.method, ...attempt.args);
            return { method: attempt.label };
        }
        catch (error) {
            errors.push(`${attempt.label} => ${(0, common_1.normalizeError)(error)}`);
        }
    }
    throw new Error(errors.join('; '));
}
async function replaceNodeWithPrefabInstance(requester, nodeUuid, assetUuid) {
    const node = await requester('scene', 'query-node', nodeUuid);
    const parentUuid = readParentUuid(node);
    const name = readNodeName(node);
    const position = readVec3(node, 'position');
    const rotation = readVec3(node, 'rotation');
    const scale = readVec3(node, 'scale');
    const childrenUuids = readChildrenUuids(node);
    let assetType = null;
    try {
        const assetInfo = await requester('asset-db', 'query-asset-info', assetUuid);
        assetType = (0, prefab_instance_utils_1.resolveNodeAssetType)(assetInfo);
    }
    catch (_a) {
        assetType = null;
    }
    const candidates = buildReplacementCreateCandidates(assetUuid, parentUuid, name, position, assetType);
    const createErrors = [];
    let replacementNodeUuid = null;
    let createMethod = '';
    for (const candidate of candidates) {
        try {
            const created = await requester('scene', 'create-node', candidate.options);
            const resolved = (0, prefab_instance_utils_1.resolveNodeUuid)(created);
            if (!resolved) {
                createErrors.push(`${candidate.label} => create-node 未返回有效节点 UUID`);
                continue;
            }
            let verification = await (0, prefab_instance_utils_1.queryPrefabInstanceInfo)(requester, resolved);
            const initialMatched = !verification.prefabAssetUuid || verification.prefabAssetUuid === assetUuid;
            if (!verification.isPrefabInstance || !initialMatched) {
                try {
                    const linked = await linkPrefabToNodeByMessage(requester, resolved, assetUuid);
                    verification = await (0, prefab_instance_utils_1.queryPrefabInstanceInfo)(requester, resolved);
                    const linkedMatched = !verification.prefabAssetUuid || verification.prefabAssetUuid === assetUuid;
                    if (verification.isPrefabInstance && linkedMatched) {
                        replacementNodeUuid = resolved;
                        createMethod = `${candidate.label} -> ${linked.method}`;
                        break;
                    }
                    createErrors.push(`${candidate.label} => ${linked.method} 后仍未建立关联（prefabAssetUuid=${verification.prefabAssetUuid || 'null'}）`);
                }
                catch (linkError) {
                    createErrors.push(`${candidate.label} => ${(0, common_1.normalizeError)(linkError)}`);
                }
                await removeNodeQuietly(requester, resolved);
                continue;
            }
            replacementNodeUuid = resolved;
            createMethod = candidate.label;
            break;
        }
        catch (error) {
            createErrors.push(`${candidate.label} => ${(0, common_1.normalizeError)(error)}`);
        }
    }
    if (!replacementNodeUuid) {
        throw new Error(createErrors.join('; ') || '创建替代 Prefab 实例失败');
    }
    const warnings = [];
    if (rotation) {
        const error = await trySetVec3Property(requester, replacementNodeUuid, 'rotation', rotation);
        if (error) {
            warnings.push(`恢复 rotation 失败：${error}`);
        }
    }
    if (scale) {
        const error = await trySetVec3Property(requester, replacementNodeUuid, 'scale', scale);
        if (error) {
            warnings.push(`恢复 scale 失败：${error}`);
        }
    }
    if (childrenUuids.length > 0) {
        try {
            await requester('scene', 'set-parent', {
                parent: replacementNodeUuid,
                uuids: childrenUuids,
                keepWorldTransform: true
            });
        }
        catch (error) {
            warnings.push(`迁移子节点失败：${(0, common_1.normalizeError)(error)}`);
        }
    }
    try {
        await requester('scene', 'remove-node', { uuid: nodeUuid });
    }
    catch (removeError) {
        await removeNodeQuietly(requester, replacementNodeUuid);
        throw new Error(`替换节点时删除原节点失败：${(0, common_1.normalizeError)(removeError)}`);
    }
    return {
        originalNodeUuid: nodeUuid,
        replacementNodeUuid,
        createMethod,
        warnings
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlZmFiLWxpbmstZmFsbGJhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zb3VyY2UvbmV4dC90b29scy9wcmVmYWItbGluay1mYWxsYmFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQWdLQSw4REEwQkM7QUFFRCxzRUFnSEM7QUEzU0QscUNBQTJFO0FBQzNFLG1FQUFvSTtBQWNwSSxTQUFTLGNBQWMsQ0FBQyxJQUFTOztJQUM3QixNQUFNLFVBQVUsR0FBRztRQUNmLElBQUEsdUJBQWMsRUFBQyxNQUFBLE1BQUEsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLE1BQU0sMENBQUUsS0FBSywwQ0FBRSxJQUFJLENBQUM7UUFDekMsSUFBQSx1QkFBYyxFQUFDLE1BQUEsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLE1BQU0sMENBQUUsSUFBSSxDQUFDO1FBQ2xDLElBQUEsdUJBQWMsRUFBQyxNQUFBLE1BQUEsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLE9BQU8sMENBQUUsS0FBSywwQ0FBRSxJQUFJLENBQUM7UUFDMUMsSUFBQSx1QkFBYyxFQUFDLE1BQUEsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLE9BQU8sMENBQUUsSUFBSSxDQUFDO1FBQ25DLElBQUEsdUJBQWMsRUFBQyxNQUFBLElBQUEsd0JBQWUsRUFBQyxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsTUFBTSxDQUFDLDBDQUFFLElBQUksQ0FBQztRQUNuRCxJQUFBLHVCQUFjLEVBQUMsTUFBQSxJQUFBLHdCQUFlLEVBQUMsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLE9BQU8sQ0FBQywwQ0FBRSxJQUFJLENBQUM7S0FDdkQsQ0FBQztJQUVGLE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxD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Q25FLENBQUM7SUFFRCxPQUFPO1FBQ0gsZ0JBQWdCLEVBQUUsUUFBUTtRQUMxQixtQkFBbUI7UUFDbkIsWUFBWTtRQUNaLFFBQVE7S0FDWCxDQUFDO0FBQ04sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVkaXRvclJlcXVlc3RlciB9IGZyb20gJy4uL21vZGVscyc7XG5pbXBvcnQgeyBub3JtYWxpemVFcnJvciwgcmVhZER1bXBTdHJpbmcsIHVud3JhcER1bXBWYWx1ZSB9IGZyb20gJy4vY29tbW9uJztcbmltcG9ydCB7IGJ1aWxkQ3JlYXRlTm9kZUNhbmRpZGF0ZXMsIHF1ZXJ5UHJlZmFiSW5zdGFuY2VJbmZvLCByZXNvbHZlTm9kZUFzc2V0VHlwZSwgcmVzb2x2ZU5vZGVVdWlkIH0gZnJvbSAnLi9wcmVmYWItaW5zdGFuY2UtdXRpbHMnO1xuXG5pbnRlcmZhY2UgVmVjM0xpa2Uge1xuICAgIHg6IG51bWJlcjtcbiAgICB5OiBudW1iZXI7XG4gICAgejogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgTGlua0F0dGVtcHQge1xuICAgIG1ldGhvZDogJ2xpbmstcHJlZmFiJyB8ICdyZXN0b3JlLXByZWZhYic7XG4gICAgYXJnczogYW55W107XG4gICAgbGFiZWw6IHN0cmluZztcbn1cblxuZnVuY3Rpb24gcmVhZFBhcmVudFV1aWQobm9kZTogYW55KTogc3RyaW5nIHwgbnVsbCB7XG4gICAgY29uc3QgY2FuZGlkYXRlcyA9IFtcbiAgICAgICAgcmVhZER1bXBTdHJpbmcobm9kZT8ucGFyZW50Py52YWx1ZT8udXVpZCksXG4gICAgICAgIHJlYWREdW1wU3RyaW5nKG5vZGU/LnBhcmVudD8udXVpZCksXG4gICAgICAgIHJlYWREdW1wU3RyaW5nKG5vZGU/Ll9wYXJlbnQ/LnZhbHVlPy51dWlkKSxcbiAgICAgICAgcmVhZER1bXBTdHJpbmcobm9kZT8uX3BhcmVudD8udXVpZCksXG4gICAgICAgIHJlYWREdW1wU3RyaW5nKHVud3JhcER1bXBWYWx1ZShub2RlPy5wYXJlbnQpPy51dWlkKSxcbiAgICAgICAgcmVhZER1bXBTdHJpbmcodW53cmFwRHVtcFZhbHVlKG5vZGU/Ll9wYXJlbnQpPy51dWlkKVxuICAgIF07XG5cbiAgICBjb25zdCBtYXRjaGVkID0gY2FuZGlkYXRlcy5maW5kKChpdGVtKSA9PiBCb29sZWFuKGl0ZW0pKTtcbiAgICByZXR1cm4gbWF0Y2hlZCB8fCBudWxsO1xufVxuXG5mdW5jdGlvbiByZWFkTm9kZU5hbWUobm9kZTogYW55KTogc3RyaW5nIHwgbnVsbCB7XG4gICAgcmV0dXJuIHJlYWREdW1wU3RyaW5nKG5vZGU/Lm5hbWUpXG4gICAgICAgIHx8IHJlYWREdW1wU3RyaW5nKG5vZGU/Ll9uYW1lKVxuICAgICAgICB8fCBudWxsO1xufVxuXG5mdW5jdGlvbiByZWFkVmVjMyhub2RlOiBhbnksIGtleTogc3RyaW5nKTogVmVjM0xpa2UgfCBudWxsIHtcbiAgICBjb25zdCByYXcgPSB1bndyYXBEdW1wVmFsdWUobm9kZT8uW2tleV0pO1xuICAgIGlmICghcmF3IHx8IHR5cGVvZiByYXcgIT09ICdvYmplY3QnKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IHggPSBOdW1iZXIocmF3LngpO1xuICAgIGNvbnN0IHkgPSBOdW1iZXIocmF3LnkpO1xuICAgIGNvbnN0IHogPSBOdW1iZXIocmF3LnopO1xuICAgIGlmICghTnVtYmVyLmlzRmluaXRlKHgpIHx8ICFOdW1iZXIuaXNGaW5pdGUoeSkgfHwgIU51bWJlci5pc0Zpbml0ZSh6KSkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4geyB4LCB5LCB6IH07XG59XG5cbmZ1bmN0aW9uIHJlYWRDaGlsZHJlblV1aWRzKG5vZGU6IGFueSk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBjaGlsZHJlbiA9IEFycmF5LmlzQXJyYXkobm9kZT8uY2hpbGRyZW4pID8gbm9kZS5jaGlsZHJlbiA6IFtdO1xuICAgIGNvbnN0IHV1aWRzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgZm9yIChjb25zdCBjaGlsZCBvZiBjaGlsZHJlbikge1xuICAgICAgICBpZiAodHlwZW9mIGNoaWxkID09PSAnc3RyaW5nJyAmJiBjaGlsZC50cmltKCkgIT09ICcnKSB7XG4gICAgICAgICAgICB1dWlkcy5wdXNoKGNoaWxkLnRyaW0oKSk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNoaWxkVXVpZCA9IHJlYWREdW1wU3RyaW5nKGNoaWxkPy51dWlkKVxuICAgICAgICAgICAgfHwgcmVhZER1bXBTdHJpbmcoY2hpbGQ/LnZhbHVlPy51dWlkKVxuICAgICAgICAgICAgfHwgcmVhZER1bXBTdHJpbmcoY2hpbGQ/Lm5vZGVVdWlkKVxuICAgICAgICAgICAgfHwgcmVhZER1bXBTdHJpbmcoY2hpbGQ/LmlkKTtcbiAgICAgICAgaWYgKGNoaWxkVXVpZCkge1xuICAgICAgICAgICAgdXVpZHMucHVzaChjaGlsZFV1aWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIEFycmF5LmZyb20obmV3IFNldCh1dWlkcykpO1xufVxuXG5hc3luYyBmdW5jdGlvbiB0cnlTZXRWZWMzUHJvcGVydHkoXG4gICAgcmVxdWVzdGVyOiBFZGl0b3JSZXF1ZXN0ZXIsXG4gICAgbm9kZVV1aWQ6IHN0cmluZyxcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgdmFsdWU6IFZlYzNMaWtlXG4pOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgICBhd2FpdCByZXF1ZXN0ZXIoJ3NjZW5lJywgJ3NldC1wcm9wZXJ0eScsIHtcbiAgICAgICAgICAgIHV1aWQ6IG5vZGVVdWlkLFxuICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgIGR1bXA6IHtcbiAgICAgICAgICAgICAgICB0eXBlOiAnY2MuVmVjMycsXG4gICAgICAgICAgICAgICAgdmFsdWVcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZUVycm9yKGVycm9yKTtcbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlbW92ZU5vZGVRdWlldGx5KHJlcXVlc3RlcjogRWRpdG9yUmVxdWVzdGVyLCBub2RlVXVpZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgcmVxdWVzdGVyKCdzY2VuZScsICdyZW1vdmUtbm9kZScsIHsgdXVpZDogbm9kZVV1aWQgfSk7XG4gICAgfSBjYXRjaCB7XG4gICAgICAgIC8vIGlnbm9yZSBjbGVhbnVwIGVycm9yXG4gICAgfVxufVxuXG5mdW5jdGlvbiBidWlsZFJlcGxhY2VtZW50Q3JlYXRlQ2FuZGlkYXRlcyhcbiAgICBhc3NldFV1aWQ6IHN0cmluZyxcbiAgICBwYXJlbnRVdWlkOiBzdHJpbmcgfCBudWxsLFxuICAgIG5hbWU6IHN0cmluZyB8IG51bGwsXG4gICAgcG9zaXRpb246IFZlYzNMaWtlIHwgbnVsbCxcbiAgICBhc3NldFR5cGU6IHN0cmluZyB8IG51bGxcbik6IEFycmF5PHsgb3B0aW9uczogUmVjb3JkPHN0cmluZywgYW55PjsgbGFiZWw6IHN0cmluZyB9PiB7XG4gICAgY29uc3QgYmFzZVZhcmlhbnRzOiBBcnJheTxSZWNvcmQ8c3RyaW5nLCBhbnk+PiA9IFtcbiAgICAgICAge1xuICAgICAgICAgICAgYXNzZXRVdWlkLFxuICAgICAgICAgICAgcGFyZW50OiBwYXJlbnRVdWlkIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGtlZXBXb3JsZFRyYW5zZm9ybTogdHJ1ZVxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBhc3NldFV1aWQsXG4gICAgICAgICAgICBwYXJlbnQ6IHBhcmVudFV1aWQgfHwgdW5kZWZpbmVkLFxuICAgICAgICAgICAgcG9zaXRpb246IHBvc2l0aW9uIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGtlZXBXb3JsZFRyYW5zZm9ybTogdHJ1ZVxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBhc3NldFV1aWQsXG4gICAgICAgICAgICBwYXJlbnQ6IHBhcmVudFV1aWQgfHwgdW5kZWZpbmVkLFxuICAgICAgICAgICAgbmFtZTogbmFtZSB8fCB1bmRlZmluZWQsXG4gICAgICAgICAgICBrZWVwV29ybGRUcmFuc2Zvcm06IHRydWVcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgICAgYXNzZXRVdWlkLFxuICAgICAgICAgICAgcGFyZW50OiBwYXJlbnRVdWlkIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIG5hbWU6IG5hbWUgfHwgdW5kZWZpbmVkLFxuICAgICAgICAgICAgcG9zaXRpb246IHBvc2l0aW9uIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGtlZXBXb3JsZFRyYW5zZm9ybTogdHJ1ZVxuICAgICAgICB9XG4gICAgXTtcblxuICAgIGNvbnN0IHNlZW4gPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICBjb25zdCBjYW5kaWRhdGVzOiBBcnJheTx7IG9wdGlvbnM6IFJlY29yZDxzdHJpbmcsIGFueT47IGxhYmVsOiBzdHJpbmcgfT4gPSBbXTtcbiAgICBsZXQgY291bnRlciA9IDA7XG5cbiAgICBmb3IgKGxldCBiYXNlSW5kZXggPSAwOyBiYXNlSW5kZXggPCBiYXNlVmFyaWFudHMubGVuZ3RoOyBiYXNlSW5kZXggKz0gMSkge1xuICAgICAgICBjb25zdCBidWlsdCA9IGJ1aWxkQ3JlYXRlTm9kZUNhbmRpZGF0ZXMoYmFzZVZhcmlhbnRzW2Jhc2VJbmRleF0sIGFzc2V0VHlwZSk7XG4gICAgICAgIGZvciAoY29uc3Qgb3B0aW9ucyBvZiBidWlsdCkge1xuICAgICAgICAgICAgY29uc3Qga2V5ID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucyk7XG4gICAgICAgICAgICBpZiAoc2Vlbi5oYXMoa2V5KSkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2Vlbi5hZGQoa2V5KTtcbiAgICAgICAgICAgIGNvdW50ZXIgKz0gMTtcbiAgICAgICAgICAgIGNhbmRpZGF0ZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgICAgICAgICBsYWJlbDogYGNyZWF0ZS1ub2RlIyR7Y291bnRlcn0oYmFzZToke2Jhc2VJbmRleCArIDF9KWBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGNhbmRpZGF0ZXM7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsaW5rUHJlZmFiVG9Ob2RlQnlNZXNzYWdlKFxuICAgIHJlcXVlc3RlcjogRWRpdG9yUmVxdWVzdGVyLFxuICAgIG5vZGVVdWlkOiBzdHJpbmcsXG4gICAgYXNzZXRVdWlkOiBzdHJpbmdcbik6IFByb21pc2U8eyBtZXRob2Q6IHN0cmluZyB9PiB7XG4gICAgY29uc3QgYXR0ZW1wdHM6IExpbmtBdHRlbXB0W10gPSBbXG4gICAgICAgIHsgbWV0aG9kOiAnbGluay1wcmVmYWInLCBhcmdzOiBbbm9kZVV1aWQsIGFzc2V0VXVpZF0sIGxhYmVsOiAnbGluay1wcmVmYWIobm9kZVV1aWQsIGFzc2V0VXVpZCknIH0sXG4gICAgICAgIHsgbWV0aG9kOiAnbGluay1wcmVmYWInLCBhcmdzOiBbeyB1dWlkOiBub2RlVXVpZCwgYXNzZXRVdWlkIH1dLCBsYWJlbDogJ2xpbmstcHJlZmFiKHt1dWlkLGFzc2V0VXVpZH0pJyB9LFxuICAgICAgICB7IG1ldGhvZDogJ2xpbmstcHJlZmFiJywgYXJnczogW3sgbm9kZTogbm9kZVV1aWQsIHByZWZhYjogYXNzZXRVdWlkIH1dLCBsYWJlbDogJ2xpbmstcHJlZmFiKHtub2RlLHByZWZhYn0pJyB9LFxuICAgICAgICB7IG1ldGhvZDogJ3Jlc3RvcmUtcHJlZmFiJywgYXJnczogW25vZGVVdWlkLCBhc3NldFV1aWRdLCBsYWJlbDogJ3Jlc3RvcmUtcHJlZmFiKG5vZGVVdWlkLCBhc3NldFV1aWQpJyB9LFxuICAgICAgICB7IG1ldGhvZDogJ3Jlc3RvcmUtcHJlZmFiJywgYXJnczogW3sgdXVpZDogbm9kZVV1aWQsIGFzc2V0VXVpZCB9XSwgbGFiZWw6ICdyZXN0b3JlLXByZWZhYih7dXVpZCxhc3NldFV1aWR9KScgfSxcbiAgICAgICAgeyBtZXRob2Q6ICdyZXN0b3JlLXByZWZhYicsIGFyZ3M6IFtub2RlVXVpZF0sIGxhYmVsOiAncmVzdG9yZS1wcmVmYWIobm9kZVV1aWQpJyB9LFxuICAgICAgICB7IG1ldGhvZDogJ3Jlc3RvcmUtcHJlZmFiJywgYXJnczogW3sgdXVpZDogbm9kZVV1aWQgfV0sIGxhYmVsOiAncmVzdG9yZS1wcmVmYWIoe3V1aWR9KScgfVxuICAgIF07XG5cbiAgICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG4gICAgZm9yIChjb25zdCBhdHRlbXB0IG9mIGF0dGVtcHRzKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCByZXF1ZXN0ZXIoJ3NjZW5lJywgYXR0ZW1wdC5tZXRob2QsIC4uLmF0dGVtcHQuYXJncyk7XG4gICAgICAgICAgICByZXR1cm4geyBtZXRob2Q6IGF0dGVtcHQubGFiZWwgfTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgICAgICAgZXJyb3JzLnB1c2goYCR7YXR0ZW1wdC5sYWJlbH0gPT4gJHtub3JtYWxpemVFcnJvcihlcnJvcil9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JzLmpvaW4oJzsgJykpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVwbGFjZU5vZGVXaXRoUHJlZmFiSW5zdGFuY2UoXG4gICAgcmVxdWVzdGVyOiBFZGl0b3JSZXF1ZXN0ZXIsXG4gICAgbm9kZVV1aWQ6IHN0cmluZyxcbiAgICBhc3NldFV1aWQ6IHN0cmluZ1xuKTogUHJvbWlzZTx7XG4gICAgb3JpZ2luYWxOb2RlVXVpZDogc3RyaW5nO1xuICAgIHJlcGxhY2VtZW50Tm9kZVV1aWQ6IHN0cmluZztcbiAgICBjcmVhdGVNZXRob2Q6IHN0cmluZztcbiAgICB3YXJuaW5nczogc3RyaW5nW107XG59PiB7XG4gICAgY29uc3Qgbm9kZSA9IGF3YWl0IHJlcXVlc3Rlcignc2NlbmUnLCAncXVlcnktbm9kZScsIG5vZGVVdWlkKTtcbiAgICBjb25zdCBwYXJlbnRVdWlkID0gcmVhZFBhcmVudFV1aWQobm9kZSk7XG4gICAgY29uc3QgbmFtZSA9IHJlYWROb2RlTmFtZShub2RlKTtcbiAgICBjb25zdCBwb3NpdGlvbiA9IHJlYWRWZWMzKG5vZGUsICdwb3NpdGlvbicpO1xuICAgIGNvbnN0IHJvdGF0aW9uID0gcmVhZFZlYzMobm9kZSwgJ3JvdGF0aW9uJyk7XG4gICAgY29uc3Qgc2NhbGUgPSByZWFkVmVjMyhub2RlLCAnc2NhbGUnKTtcbiAgICBjb25zdCBjaGlsZHJlblV1aWRzID0gcmVhZENoaWxkcmVuVXVpZHMobm9kZSk7XG5cbiAgICBsZXQgYXNzZXRUeXBlOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBhc3NldEluZm8gPSBhd2FpdCByZXF1ZXN0ZXIoJ2Fzc2V0LWRiJywgJ3F1ZXJ5LWFzc2V0LWluZm8nLCBhc3NldFV1aWQpO1xuICAgICAgICBhc3NldFR5cGUgPSByZXNvbHZlTm9kZUFzc2V0VHlwZShhc3NldEluZm8pO1xuICAgIH0gY2F0Y2gge1xuICAgICAgICBhc3NldFR5cGUgPSBudWxsO1xuICAgIH1cbiAgICBjb25zdCBjYW5kaWRhdGVzID0gYnVpbGRSZXBsYWNlbWVudENyZWF0ZUNhbmRpZGF0ZXMoYXNzZXRVdWlkLCBwYXJlbnRVdWlkLCBuYW1lLCBwb3NpdGlvbiwgYXNzZXRUeXBlKTtcblxuICAgIGNvbnN0IGNyZWF0ZUVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgICBsZXQgcmVwbGFjZW1lbnROb2RlVXVpZDogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG4gICAgbGV0IGNyZWF0ZU1ldGhvZCA9ICcnO1xuICAgIGZvciAoY29uc3QgY2FuZGlkYXRlIG9mIGNhbmRpZGF0ZXMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGNyZWF0ZWQgPSBhd2FpdCByZXF1ZXN0ZXIoJ3NjZW5lJywgJ2NyZWF0ZS1ub2RlJywgY2FuZGlkYXRlLm9wdGlvbnMpO1xuICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSByZXNvbHZlTm9kZVV1aWQoY3JlYXRlZCk7XG4gICAgICAgICAgICBpZiAoIXJlc29sdmVkKSB7XG4gICAgICAgICAgICAgICAgY3JlYXRlRXJyb3JzLnB1c2goYCR7Y2FuZGlkYXRlLmxhYmVsfSA9PiBjcmVhdGUtbm9kZSDmnKrov5Tlm57mnInmlYjoioLngrkgVVVJRGApO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgdmVyaWZpY2F0aW9uID0gYXdhaXQgcXVlcnlQcmVmYWJJbnN0YW5jZUluZm8ocmVxdWVzdGVyLCByZXNvbHZlZCk7XG4gICAgICAgICAgICBjb25zdCBpbml0aWFsTWF0Y2hlZCA9ICF2ZXJpZmljYXRpb24ucHJlZmFiQXNzZXRVdWlkIHx8IHZlcmlmaWNhdGlvbi5wcmVmYWJBc3NldFV1aWQgPT09IGFzc2V0VXVpZDtcbiAgICAgICAgICAgIGlmICghdmVyaWZpY2F0aW9uLmlzUHJlZmFiSW5zdGFuY2UgfHwgIWluaXRpYWxNYXRjaGVkKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlua2VkID0gYXdhaXQgbGlua1ByZWZhYlRvTm9kZUJ5TWVzc2FnZShyZXF1ZXN0ZXIsIHJlc29sdmVkLCBhc3NldFV1aWQpO1xuICAgICAgICAgICAgICAgICAgICB2ZXJpZmljYXRpb24gPSBhd2FpdCBxdWVyeVByZWZhYkluc3RhbmNlSW5mbyhyZXF1ZXN0ZXIsIHJlc29sdmVkKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlua2VkTWF0Y2hlZCA9ICF2ZXJpZmljYXRpb24ucHJlZmFiQXNzZXRVdWlkIHx8IHZlcmlmaWNhdGlvbi5wcmVmYWJBc3NldFV1aWQgPT09IGFzc2V0VXVpZDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZlcmlmaWNhdGlvbi5pc1ByZWZhYkluc3RhbmNlICYmIGxpbmtlZE1hdGNoZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VtZW50Tm9kZVV1aWQgPSByZXNvbHZlZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZU1ldGhvZCA9IGAke2NhbmRpZGF0ZS5sYWJlbH0gLT4gJHtsaW5rZWQubWV0aG9kfWA7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjcmVhdGVFcnJvcnMucHVzaChcbiAgICAgICAgICAgICAgICAgICAgICAgIGAke2NhbmRpZGF0ZS5sYWJlbH0gPT4gJHtsaW5rZWQubWV0aG9kfSDlkI7ku43mnKrlu7rnq4vlhbPogZTvvIhwcmVmYWJBc3NldFV1aWQ9JHt2ZXJpZmljYXRpb24ucHJlZmFiQXNzZXRVdWlkIHx8ICdudWxsJ33vvIlgXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAobGlua0Vycm9yOiBhbnkpIHtcbiAgICAgICAgICAgICAgICAgICAgY3JlYXRlRXJyb3JzLnB1c2goYCR7Y2FuZGlkYXRlLmxhYmVsfSA9PiAke25vcm1hbGl6ZUVycm9yKGxpbmtFcnJvcil9YCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGF3YWl0IHJlbW92ZU5vZGVRdWlldGx5KHJlcXVlc3RlciwgcmVzb2x2ZWQpO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXBsYWNlbWVudE5vZGVVdWlkID0gcmVzb2x2ZWQ7XG4gICAgICAgICAgICBjcmVhdGVNZXRob2QgPSBjYW5kaWRhdGUubGFiZWw7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgICAgICAgY3JlYXRlRXJyb3JzLnB1c2goYCR7Y2FuZGlkYXRlLmxhYmVsfSA9PiAke25vcm1hbGl6ZUVycm9yKGVycm9yKX1gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlmICghcmVwbGFjZW1lbnROb2RlVXVpZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoY3JlYXRlRXJyb3JzLmpvaW4oJzsgJykgfHwgJ+WIm+W7uuabv+S7oyBQcmVmYWIg5a6e5L6L5aSx6LSlJyk7XG4gICAgfVxuXG4gICAgY29uc3Qgd2FybmluZ3M6IHN0cmluZ1tdID0gW107XG4gICAgaWYgKHJvdGF0aW9uKSB7XG4gICAgICAgIGNvbnN0IGVycm9yID0gYXdhaXQgdHJ5U2V0VmVjM1Byb3BlcnR5KHJlcXVlc3RlciwgcmVwbGFjZW1lbnROb2RlVXVpZCwgJ3JvdGF0aW9uJywgcm90YXRpb24pO1xuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgIHdhcm5pbmdzLnB1c2goYOaBouWkjSByb3RhdGlvbiDlpLHotKXvvJoke2Vycm9yfWApO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChzY2FsZSkge1xuICAgICAgICBjb25zdCBlcnJvciA9IGF3YWl0IHRyeVNldFZlYzNQcm9wZXJ0eShyZXF1ZXN0ZXIsIHJlcGxhY2VtZW50Tm9kZVV1aWQsICdzY2FsZScsIHNjYWxlKTtcbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICB3YXJuaW5ncy5wdXNoKGDmgaLlpI0gc2NhbGUg5aSx6LSl77yaJHtlcnJvcn1gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlmIChjaGlsZHJlblV1aWRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHJlcXVlc3Rlcignc2NlbmUnLCAnc2V0LXBhcmVudCcsIHtcbiAgICAgICAgICAgICAgICBwYXJlbnQ6IHJlcGxhY2VtZW50Tm9kZVV1aWQsXG4gICAgICAgICAgICAgICAgdXVpZHM6IGNoaWxkcmVuVXVpZHMsXG4gICAgICAgICAgICAgICAga2VlcFdvcmxkVHJhbnNmb3JtOiB0cnVlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgICAgICAgd2FybmluZ3MucHVzaChg6L+B56e75a2Q6IqC54K55aSx6LSl77yaJHtub3JtYWxpemVFcnJvcihlcnJvcil9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgICBhd2FpdCByZXF1ZXN0ZXIoJ3NjZW5lJywgJ3JlbW92ZS1ub2RlJywgeyB1dWlkOiBub2RlVXVpZCB9KTtcbiAgICB9IGNhdGNoIChyZW1vdmVFcnJvcjogYW55KSB7XG4gICAgICAgIGF3YWl0IHJlbW92ZU5vZGVRdWlldGx5KHJlcXVlc3RlciwgcmVwbGFjZW1lbnROb2RlVXVpZCk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihg5pu/5o2i6IqC54K55pe25Yig6Zmk5Y6f6IqC54K55aSx6LSl77yaJHtub3JtYWxpemVFcnJvcihyZW1vdmVFcnJvcil9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgb3JpZ2luYWxOb2RlVXVpZDogbm9kZVV1aWQsXG4gICAgICAgIHJlcGxhY2VtZW50Tm9kZVV1aWQsXG4gICAgICAgIGNyZWF0ZU1ldGhvZCxcbiAgICAgICAgd2FybmluZ3NcbiAgICB9O1xufVxuIl19