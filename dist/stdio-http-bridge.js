"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.StdioHttpBridge = void 0;
const http = __importStar(require("http"));
const https = __importStar(require("https"));
const url_1 = require("url");
const DEFAULT_ENDPOINT = process.env.COCOS_MCP_HTTP_URL || 'http://127.0.0.1:3000/mcp';
const DEFAULT_TIMEOUT_MS = Number(process.env.COCOS_MCP_HTTP_TIMEOUT_MS || 30000);
class StdioHttpBridge {
    constructor(options) {
        this.buffer = '';
        this.processingQueue = Promise.resolve();
        this.options = options;
    }
    start() {
        process.stdin.setEncoding('utf8');
        process.stdin.on('data', (chunk) => {
            this.onStdinData(chunk);
        });
        process.stdin.on('error', (error) => {
            this.logError(`读取 stdin 失败: ${error.message}`);
        });
        process.stdin.on('end', () => {
            this.logDebug('stdin 已结束，桥接进程即将退出。');
            process.exit(0);
        });
        process.on('SIGINT', () => process.exit(0));
        process.on('SIGTERM', () => process.exit(0));
        process.stdin.resume();
        this.logDebug(`桥接已启动（标准换行协议），目标 MCP 端点: ${this.options.endpoint}`);
    }
    onStdinData(chunk) {
        this.buffer += chunk;
        while (true) {
            const newlineIndex = this.buffer.indexOf('\n');
            if (newlineIndex === -1) {
                return;
            }
            const rawLine = this.buffer.slice(0, newlineIndex);
            this.buffer = this.buffer.slice(newlineIndex + 1);
            const line = rawLine.replace(/\r$/, '').trim();
            if (!line) {
                continue;
            }
            this.enqueueMessage(line);
        }
    }
    enqueueMessage(messageText) {
        this.processingQueue = this.processingQueue
            .then(() => this.handleMessage(messageText))
            .catch((error) => {
            this.logError(`处理消息失败: ${error.message}`);
        });
    }
    async handleMessage(messageText) {
        let message;
        try {
            message = JSON.parse(messageText);
        }
        catch (error) {
            this.logError(`收到非法 JSON: ${error.message}`);
            const parseError = {
                jsonrpc: '2.0',
                id: null,
                error: {
                    code: -32700,
                    message: `Parse error: ${error.message}`
                }
            };
            this.writeStdoutLine(JSON.stringify(parseError));
            return;
        }
        const expectsResponse = this.expectsResponse(message);
        try {
            const response = await this.forwardToHttp(messageText);
            if (!expectsResponse) {
                return;
            }
            if (!response.body.trim()) {
                const emptyResponseError = this.buildErrorResponse(message, -32603, 'Bridge error: upstream returned empty response body for request.');
                if (emptyResponseError) {
                    this.writeStdoutLine(JSON.stringify(emptyResponseError));
                }
                return;
            }
            this.writeStdoutLine(response.body.trim());
        }
        catch (error) {
            this.logError(`转发到 HTTP 端点失败: ${error.message}`);
            const errorResponse = this.buildErrorResponse(message, -32603, `Bridge transport error: ${error.message}`);
            if (errorResponse) {
                this.writeStdoutLine(JSON.stringify(errorResponse));
            }
        }
    }
    expectsResponse(message) {
        if (Array.isArray(message)) {
            return message.some((item) => this.isRequestMessage(item));
        }
        return this.isRequestMessage(message);
    }
    isRequestMessage(message) {
        if (!message || typeof message !== 'object' || Array.isArray(message)) {
            return false;
        }
        return typeof message.method === 'string' && Object.prototype.hasOwnProperty.call(message, 'id');
    }
    buildErrorResponse(message, code, errorMessage) {
        var _a;
        if (Array.isArray(message)) {
            const requestIds = message
                .filter((item) => this.isRequestMessage(item))
                .map((item) => { var _a; return (_a = item.id) !== null && _a !== void 0 ? _a : null; });
            if (requestIds.length === 0) {
                return null;
            }
            return requestIds.map((id) => ({
                jsonrpc: '2.0',
                id,
                error: {
                    code,
                    message: errorMessage
                }
            }));
        }
        if (!this.isRequestMessage(message)) {
            return null;
        }
        return {
            jsonrpc: '2.0',
            id: (_a = message.id) !== null && _a !== void 0 ? _a : null,
            error: {
                code,
                message: errorMessage
            }
        };
    }
    async forwardToHttp(rawBody) {
        const endpointUrl = new url_1.URL(this.options.endpoint);
        const client = endpointUrl.protocol === 'https:' ? https : http;
        const payload = Buffer.from(rawBody, 'utf8');
        return new Promise((resolve, reject) => {
            const request = client.request(endpointUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': String(payload.length),
                    Accept: 'application/json'
                }
            }, (response) => {
                const chunks = [];
                response.on('data', (chunk) => {
                    chunks.push(typeof chunk === 'string' ? Buffer.from(chunk) : chunk);
                });
                response.on('end', () => {
                    const body = Buffer.concat(chunks).toString('utf8');
                    const statusCode = response.statusCode || 0;
                    if (statusCode >= 400) {
                        reject(new Error(`upstream HTTP ${statusCode}: ${body || 'empty body'}`));
                        return;
                    }
                    resolve({ statusCode, body });
                });
            });
            request.setTimeout(this.options.timeoutMs, () => {
                request.destroy(new Error(`request timeout after ${this.options.timeoutMs}ms`));
            });
            request.on('error', (error) => {
                reject(error);
            });
            request.write(payload);
            request.end();
        });
    }
    writeStdoutLine(payload) {
        process.stdout.write(`${payload}\n`);
        this.logDebug(`已写出响应消息，大小 ${Buffer.byteLength(payload, 'utf8')} 字节`);
    }
    logDebug(message) {
        if (this.options.debug) {
            process.stderr.write(`[stdio-http-bridge][debug] ${message}\n`);
        }
    }
    logError(message) {
        process.stderr.write(`[stdio-http-bridge][error] ${message}\n`);
    }
}
exports.StdioHttpBridge = StdioHttpBridge;
function parseArgs(argv) {
    let endpoint = DEFAULT_ENDPOINT;
    let timeoutMs = Number.isFinite(DEFAULT_TIMEOUT_MS) ? DEFAULT_TIMEOUT_MS : 30000;
    let debug = false;
    for (let i = 0; i < argv.length; i += 1) {
        const arg = argv[i];
        if (arg === '--help' || arg === '-h') {
            printHelpAndExit(0);
        }
        else if (arg === '--debug') {
            debug = true;
        }
        else if (arg === '--url') {
            const next = argv[i + 1];
            if (!next) {
                printHelpAndExit(1, '--url 缺少参数');
            }
            endpoint = next;
            i += 1;
        }
        else if (arg.startsWith('--url=')) {
            endpoint = arg.slice('--url='.length);
        }
        else if (arg === '--timeout') {
            const next = argv[i + 1];
            if (!next) {
                printHelpAndExit(1, '--timeout 缺少参数');
            }
            timeoutMs = Number(next);
            i += 1;
        }
        else if (arg.startsWith('--timeout=')) {
            timeoutMs = Number(arg.slice('--timeout='.length));
        }
        else {
            printHelpAndExit(1, `未知参数: ${arg}`);
        }
    }
    if (!Number.isFinite(timeoutMs) || timeoutMs <= 0) {
        printHelpAndExit(1, `--timeout 参数无效: ${timeoutMs}`);
    }
    let parsedUrl;
    try {
        parsedUrl = new url_1.URL(endpoint);
    }
    catch (error) {
        printHelpAndExit(1, `--url 参数无效: ${error.message}`);
    }
    if (parsedUrl.protocol !== 'http:' && parsedUrl.protocol !== 'https:') {
        printHelpAndExit(1, `仅支持 http/https URL，当前为: ${parsedUrl.protocol}`);
    }
    return {
        endpoint,
        timeoutMs,
        debug
    };
}
function printHelpAndExit(code, errorMessage) {
    if (errorMessage) {
        process.stderr.write(`[stdio-http-bridge][error] ${errorMessage}\n`);
    }
    process.stderr.write([
        '用法: node dist/stdio-http-bridge.js [--url <mcp_http_url>] [--timeout <ms>] [--debug]',
        '',
        '协议:',
        '  stdin/stdout 均使用标准换行分隔（每行一条 JSON-RPC 消息）',
        '',
        '参数:',
        '  --url      MCP HTTP 端点，默认 http://127.0.0.1:3000/mcp',
        '  --timeout  请求超时毫秒，默认 30000',
        '  --debug    输出调试日志（stderr）',
        '',
        '环境变量:',
        '  COCOS_MCP_HTTP_URL         默认 HTTP 端点',
        '  COCOS_MCP_HTTP_TIMEOUT_MS  默认超时毫秒'
    ].join('\n') + '\n');
    process.exit(code);
}
function main() {
    const options = parseArgs(process.argv.slice(2));
    const bridge = new StdioHttpBridge(options);
    bridge.start();
}
if (require.main === module) {
    main();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RkaW8taHR0cC1icmlkZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zb3VyY2Uvc3RkaW8taHR0cC1icmlkZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQTZCO0FBQzdCLDZDQUErQjtBQUMvQiw2QkFBMEI7QUFzQjFCLE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsSUFBSSwyQkFBMkIsQ0FBQztBQUN2RixNQUFNLGtCQUFrQixHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixJQUFJLEtBQUssQ0FBQyxDQUFDO0FBRWxGLE1BQU0sZUFBZTtJQUtqQixZQUFZLE9BQXNCO1FBSDFCLFdBQU0sR0FBRyxFQUFFLENBQUM7UUFDWixvQkFBZSxHQUFrQixPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFHdkQsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7SUFDM0IsQ0FBQztJQUVNLEtBQUs7UUFDUixPQUFPLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUVsQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFhLEVBQUUsRUFBRTtZQUN2QyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDaEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDbkQsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFO1lBQ3pCLElBQUks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QztJQUVGLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdkIsQ0FBQztBQUVELFNBQVMsSUFBSTtJQUNULE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pELE1BQU0sTUFBTSxHQUFHLElBQUksZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzVDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUNuQixDQUFDO0FBRUQsSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRSxDQUFDO0lBQzFCLElBQUksRUFBRSxDQUFDO0FBQ1gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGh0dHAgZnJvbSAnaHR0cCc7XG5pbXBvcnQgKiBhcyBodHRwcyBmcm9tICdodHRwcyc7XG5pbXBvcnQgeyBVUkwgfSBmcm9tICd1cmwnO1xuXG5pbnRlcmZhY2UgQnJpZGdlT3B0aW9ucyB7XG4gICAgZW5kcG9pbnQ6IHN0cmluZztcbiAgICB0aW1lb3V0TXM6IG51bWJlcjtcbiAgICBkZWJ1ZzogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIEh0dHBSZXNwb25zZSB7XG4gICAgc3RhdHVzQ29kZTogbnVtYmVyO1xuICAgIGJvZHk6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIEpzb25ScGNFcnJvclJlc3BvbnNlIHtcbiAgICBqc29ucnBjOiAnMi4wJztcbiAgICBpZDogc3RyaW5nIHwgbnVtYmVyIHwgbnVsbDtcbiAgICBlcnJvcjoge1xuICAgICAgICBjb2RlOiBudW1iZXI7XG4gICAgICAgIG1lc3NhZ2U6IHN0cmluZztcbiAgICB9O1xufVxuXG5jb25zdCBERUZBVUxUX0VORFBPSU5UID0gcHJvY2Vzcy5lbnYuQ09DT1NfTUNQX0hUVFBfVVJMIHx8ICdodHRwOi8vMTI3LjAuMC4xOjMwMDAvbWNwJztcbmNvbnN0IERFRkFVTFRfVElNRU9VVF9NUyA9IE51bWJlcihwcm9jZXNzLmVudi5DT0NPU19NQ1BfSFRUUF9USU1FT1VUX01TIHx8IDMwMDAwKTtcblxuY2xhc3MgU3RkaW9IdHRwQnJpZGdlIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IG9wdGlvbnM6IEJyaWRnZU9wdGlvbnM7XG4gICAgcHJpdmF0ZSBidWZmZXIgPSAnJztcbiAgICBwcml2YXRlIHByb2Nlc3NpbmdRdWV1ZTogUHJvbWlzZTx2b2lkPiA9IFByb21pc2UucmVzb2x2ZSgpO1xuXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogQnJpZGdlT3B0aW9ucykge1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGFydCgpOiB2b2lkIHtcbiAgICAgICAgcHJvY2Vzcy5zdGRpbi5zZXRFbmNvZGluZygndXRmOCcpO1xuXG4gICAgICAgIHByb2Nlc3Muc3RkaW4ub24oJ2RhdGEnLCAoY2h1bms6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgdGhpcy5vblN0ZGluRGF0YShjaHVuayk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHByb2Nlc3Muc3RkaW4ub24oJ2Vycm9yJywgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxvZ0Vycm9yKGDor7vlj5Ygc3RkaW4g5aSx6LSlOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHByb2Nlc3Muc3RkaW4ub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMubG9nRGVidWcoJ3N0ZGluIOW3sue7k+adn++8jOahpeaOpei/m+eoi+WNs+WwhumAgOWHuuOAgicpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDApO1xuICAgICAgICB9KTtcblxuICAgICAgICBwcm9jZXNzLm9uKCdTSUdJTlQnLCAoKSA9PiBwcm9jZXNzLmV4aXQoMCkpO1xuICAgICAgICBwcm9jZXNzLm9uKCdTSUdURVJNJywgKCkgPT4gcHJvY2Vzcy5leGl0KDApKTtcblxuICAgICAgICBwcm9jZXNzLnN0ZGluLnJlc3VtZSgpO1xuICAgICAgICB0aGlzLmxvZ0RlYnVnKGDmoaXmjqXlt7LlkK/liqjvvIjmoIflh4bmjaLooYzljY/orq7vvInvvIznm67moIcgTUNQIOerr+eCuTogJHt0aGlzLm9wdGlvbnMuZW5kcG9pbnR9YCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblN0ZGluRGF0YShjaHVuazogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRoaXMuYnVmZmVyICs9IGNodW5rO1xuXG4gICAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgICAgICBjb25zdCBuZXdsaW5lSW5kZXggPSB0aGlzLmJ1ZmZlci5pbmRleE9mKCdcXG4nKTtcbiAgICAgICAgICAgIGlmIChuZXdsaW5lSW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCByYXdMaW5lID0gdGhpcy5idWZmZXIuc2xpY2UoMCwgbmV3bGluZUluZGV4KTtcbiAgICAgICAgICAgIHRoaXMuYnVmZmVyID0gdGhpcy5idWZmZXIuc2xpY2UobmV3bGluZUluZGV4ICsgMSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGxpbmUgPSByYXdMaW5lLnJlcGxhY2UoL1xcciQvLCAnJykudHJpbSgpO1xuICAgICAgICAgICAgaWYgKCFsaW5lKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZW5xdWV1ZU1lc3NhZ2UobGluZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGVucXVldWVNZXNzYWdlKG1lc3NhZ2VUZXh0OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5wcm9jZXNzaW5nUXVldWUgPSB0aGlzLnByb2Nlc3NpbmdRdWV1ZVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5oYW5kbGVNZXNzYWdlKG1lc3NhZ2VUZXh0KSlcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyb3I6IEVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dFcnJvcihg5aSE55CG5raI5oGv5aSx6LSlOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGhhbmRsZU1lc3NhZ2UobWVzc2FnZVRleHQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBsZXQgbWVzc2FnZTogYW55O1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBtZXNzYWdlID0gSlNPTi5wYXJzZShtZXNzYWdlVGV4dCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgICAgICAgIHRoaXMubG9nRXJyb3IoYOaUtuWIsOmdnuazlSBKU09OOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgICBjb25zdCBwYXJzZUVycm9yOiBKc29uUnBjRXJyb3JSZXNwb25zZSA9IHtcbiAgICAgICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgICAgICAgICAgICBpZDogbnVsbCxcbiAgICAgICAgICAgICAgICBlcnJvcjoge1xuICAgICAgICAgICAgICAgICAgICBjb2RlOiAtMzI3MDAsXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBQYXJzZSBlcnJvcjogJHtlcnJvci5tZXNzYWdlfWBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy53cml0ZVN0ZG91dExpbmUoSlNPTi5zdHJpbmdpZnkocGFyc2VFcnJvcikpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZXhwZWN0c1Jlc3BvbnNlID0gdGhpcy5leHBlY3RzUmVzcG9uc2UobWVzc2FnZSk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5mb3J3YXJkVG9IdHRwKG1lc3NhZ2VUZXh0KTtcblxuICAgICAgICAgICAgaWYgKCFleHBlY3RzUmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghcmVzcG9uc2UuYm9keS50cmltKCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBlbXB0eVJlc3BvbnNlRXJyb3IgPSB0aGlzLmJ1aWxkRXJyb3JSZXNwb25zZShcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgLTMyNjAzLFxuICAgICAgICAgICAgICAgICAgICAnQnJpZGdlIGVycm9yOiB1cHN0cmVhbSByZXR1cm5lZCBlbXB0eSByZXNwb25zZSBib2R5IGZvciByZXF1ZXN0LidcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIGlmIChlbXB0eVJlc3BvbnNlRXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy53cml0ZVN0ZG91dExpbmUoSlNPTi5zdHJpbmdpZnkoZW1wdHlSZXNwb25zZUVycm9yKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy53cml0ZVN0ZG91dExpbmUocmVzcG9uc2UuYm9keS50cmltKCkpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICAgICAgICB0aGlzLmxvZ0Vycm9yKGDovazlj5HliLAgSFRUUCDnq6/ngrnlpLHotKU6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgICAgIGNvbnN0IGVycm9yUmVzcG9uc2UgPSB0aGlzLmJ1aWxkRXJyb3JSZXNwb25zZShcbiAgICAgICAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgICAgICAgIC0zMjYwMyxcbiAgICAgICAgICAgICAgICBgQnJpZGdlIHRyYW5zcG9ydCBlcnJvcjogJHtlcnJvci5tZXNzYWdlfWBcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmIChlcnJvclJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy53cml0ZVN0ZG91dExpbmUoSlNPTi5zdHJpbmdpZnkoZXJyb3JSZXNwb25zZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBleHBlY3RzUmVzcG9uc2UobWVzc2FnZTogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KG1lc3NhZ2UpKSB7XG4gICAgICAgICAgICByZXR1cm4gbWVzc2FnZS5zb21lKChpdGVtKSA9PiB0aGlzLmlzUmVxdWVzdE1lc3NhZ2UoaXRlbSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuaXNSZXF1ZXN0TWVzc2FnZShtZXNzYWdlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzUmVxdWVzdE1lc3NhZ2UobWVzc2FnZTogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIGlmICghbWVzc2FnZSB8fCB0eXBlb2YgbWVzc2FnZSAhPT0gJ29iamVjdCcgfHwgQXJyYXkuaXNBcnJheShtZXNzYWdlKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHR5cGVvZiBtZXNzYWdlLm1ldGhvZCA9PT0gJ3N0cmluZycgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICdpZCcpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYnVpbGRFcnJvclJlc3BvbnNlKFxuICAgICAgICBtZXNzYWdlOiBhbnksXG4gICAgICAgIGNvZGU6IG51bWJlcixcbiAgICAgICAgZXJyb3JNZXNzYWdlOiBzdHJpbmdcbiAgICApOiBKc29uUnBjRXJyb3JSZXNwb25zZSB8IEpzb25ScGNFcnJvclJlc3BvbnNlW10gfCBudWxsIHtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobWVzc2FnZSkpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlcXVlc3RJZHMgPSBtZXNzYWdlXG4gICAgICAgICAgICAgICAgLmZpbHRlcigoaXRlbSkgPT4gdGhpcy5pc1JlcXVlc3RNZXNzYWdlKGl0ZW0pKVxuICAgICAgICAgICAgICAgIC5tYXAoKGl0ZW0pID0+IGl0ZW0uaWQgPz8gbnVsbCk7XG5cbiAgICAgICAgICAgIGlmIChyZXF1ZXN0SWRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVxdWVzdElkcy5tYXAoKGlkKSA9PiAoe1xuICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgICAgICAgICAgIGNvZGUsXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yTWVzc2FnZVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5pc1JlcXVlc3RNZXNzYWdlKG1lc3NhZ2UpKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgICAgICAgIGlkOiBtZXNzYWdlLmlkID8/IG51bGwsXG4gICAgICAgICAgICBlcnJvcjoge1xuICAgICAgICAgICAgICAgIGNvZGUsXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogZXJyb3JNZXNzYWdlXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBmb3J3YXJkVG9IdHRwKHJhd0JvZHk6IHN0cmluZyk6IFByb21pc2U8SHR0cFJlc3BvbnNlPiB7XG4gICAgICAgIGNvbnN0IGVuZHBvaW50VXJsID0gbmV3IFVSTCh0aGlzLm9wdGlvbnMuZW5kcG9pbnQpO1xuICAgICAgICBjb25zdCBjbGllbnQgPSBlbmRwb2ludFVybC5wcm90b2NvbCA9PT0gJ2h0dHBzOicgPyBodHRwcyA6IGh0dHA7XG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSBCdWZmZXIuZnJvbShyYXdCb2R5LCAndXRmOCcpO1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxIdHRwUmVzcG9uc2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlcXVlc3QgPSBjbGllbnQucmVxdWVzdChcbiAgICAgICAgICAgICAgICBlbmRwb2ludFVybCxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ0NvbnRlbnQtTGVuZ3RoJzogU3RyaW5nKHBheWxvYWQubGVuZ3RoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIEFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb24nXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjaHVua3M6IEJ1ZmZlcltdID0gW107XG5cbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2Uub24oJ2RhdGEnLCAoY2h1bms6IEJ1ZmZlciB8IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2h1bmtzLnB1c2godHlwZW9mIGNodW5rID09PSAnc3RyaW5nJyA/IEJ1ZmZlci5mcm9tKGNodW5rKSA6IGNodW5rKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2Uub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJvZHkgPSBCdWZmZXIuY29uY2F0KGNodW5rcykudG9TdHJpbmcoJ3V0ZjgnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1c0NvZGUgPSByZXNwb25zZS5zdGF0dXNDb2RlIHx8IDA7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0dXNDb2RlID49IDQwMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYHVwc3RyZWFtIEhUVFAgJHtzdGF0dXNDb2RlfTogJHtib2R5IHx8ICdlbXB0eSBib2R5J31gKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHsgc3RhdHVzQ29kZSwgYm9keSB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgcmVxdWVzdC5zZXRUaW1lb3V0KHRoaXMub3B0aW9ucy50aW1lb3V0TXMsICgpID0+IHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0LmRlc3Ryb3kobmV3IEVycm9yKGByZXF1ZXN0IHRpbWVvdXQgYWZ0ZXIgJHt0aGlzLm9wdGlvbnMudGltZW91dE1zfW1zYCkpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJlcXVlc3Qub24oJ2Vycm9yJywgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXF1ZXN0LndyaXRlKHBheWxvYWQpO1xuICAgICAgICAgICAgcmVxdWVzdC5lbmQoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB3cml0ZVN0ZG91dExpbmUocGF5bG9hZDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGAke3BheWxvYWR9XFxuYCk7XG4gICAgICAgIHRoaXMubG9nRGVidWcoYOW3suWGmeWHuuWTjeW6lOa2iOaBr++8jOWkp+WwjyAke0J1ZmZlci5ieXRlTGVuZ3RoKHBheWxvYWQsICd1dGY4Jyl9IOWtl+iKgmApO1xuICAgIH1cblxuICAgIHByaXZhdGUgbG9nRGVidWcobWVzc2FnZTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZGVidWcpIHtcbiAgICAgICAgICAgIHByb2Nlc3Muc3RkZXJyLndyaXRlKGBbc3RkaW8taHR0cC1icmlkZ2VdW2RlYnVnXSAke21lc3NhZ2V9XFxuYCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGxvZ0Vycm9yKG1lc3NhZ2U6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBwcm9jZXNzLnN0ZGVyci53cml0ZShgW3N0ZGlvLWh0dHAtYnJpZGdlXVtlcnJvcl0gJHttZXNzYWdlfVxcbmApO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VBcmdzKGFyZ3Y6IHN0cmluZ1tdKTogQnJpZGdlT3B0aW9ucyB7XG4gICAgbGV0IGVuZHBvaW50ID0gREVGQVVMVF9FTkRQT0lOVDtcbiAgICBsZXQgdGltZW91dE1zID0gTnVtYmVyLmlzRmluaXRlKERFRkFVTFRfVElNRU9VVF9NUykgPyBERUZBVUxUX1RJTUVPVVRfTVMgOiAzMDAwMDtcbiAgICBsZXQgZGVidWcgPSBmYWxzZTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJndi5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICBjb25zdCBhcmcgPSBhcmd2W2ldO1xuXG4gICAgICAgIGlmIChhcmcgPT09ICctLWhlbHAnIHx8IGFyZyA9PT0gJy1oJykge1xuICAgICAgICAgICAgcHJpbnRIZWxwQW5kRXhpdCgwKTtcbiAgICAgICAgfSBlbHNlIGlmIChhcmcgPT09ICctLWRlYnVnJykge1xuICAgICAgICAgICAgZGVidWcgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKGFyZyA9PT0gJy0tdXJsJykge1xuICAgICAgICAgICAgY29uc3QgbmV4dCA9IGFyZ3ZbaSArIDFdO1xuICAgICAgICAgICAgaWYgKCFuZXh0KSB7XG4gICAgICAgICAgICAgICAgcHJpbnRIZWxwQW5kRXhpdCgxLCAnLS11cmwg57y65bCR5Y+C5pWwJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbmRwb2ludCA9IG5leHQ7XG4gICAgICAgICAgICBpICs9IDE7XG4gICAgICAgIH0gZWxzZSBpZiAoYXJnLnN0YXJ0c1dpdGgoJy0tdXJsPScpKSB7XG4gICAgICAgICAgICBlbmRwb2ludCA9IGFyZy5zbGljZSgnLS11cmw9Jy5sZW5ndGgpO1xuICAgICAgICB9IGVsc2UgaWYgKGFyZyA9PT0gJy0tdGltZW91dCcpIHtcbiAgICAgICAgICAgIGNvbnN0IG5leHQgPSBhcmd2W2kgKyAxXTtcbiAgICAgICAgICAgIGlmICghbmV4dCkge1xuICAgICAgICAgICAgICAgIHByaW50SGVscEFuZEV4aXQoMSwgJy0tdGltZW91dCDnvLrlsJHlj4LmlbAnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRpbWVvdXRNcyA9IE51bWJlcihuZXh0KTtcbiAgICAgICAgICAgIGkgKz0gMTtcbiAgICAgICAgfSBlbHNlIGlmIChhcmcuc3RhcnRzV2l0aCgnLS10aW1lb3V0PScpKSB7XG4gICAgICAgICAgICB0aW1lb3V0TXMgPSBOdW1iZXIoYXJnLnNsaWNlKCctLXRpbWVvdXQ9Jy5sZW5ndGgpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHByaW50SGVscEFuZEV4aXQoMSwgYOacquefpeWPguaVsDogJHthcmd9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIU51bWJlci5pc0Zpbml0ZSh0aW1lb3V0TXMpIHx8IHRpbWVvdXRNcyA8PSAwKSB7XG4gICAgICAgIHByaW50SGVscEFuZEV4aXQoMSwgYC0tdGltZW91dCDlj4LmlbDml6DmlYg6ICR7dGltZW91dE1zfWApO1xuICAgIH1cblxuICAgIGxldCBwYXJzZWRVcmw6IFVSTDtcbiAgICB0cnkge1xuICAgICAgICBwYXJzZWRVcmwgPSBuZXcgVVJMKGVuZHBvaW50KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICAgIHByaW50SGVscEFuZEV4aXQoMSwgYC0tdXJsIOWPguaVsOaXoOaViDogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgIH1cblxuICAgIGlmIChwYXJzZWRVcmwucHJvdG9jb2wgIT09ICdodHRwOicgJiYgcGFyc2VkVXJsLnByb3RvY29sICE9PSAnaHR0cHM6Jykge1xuICAgICAgICBwcmludEhlbHBBbmRFeGl0KDEsIGDku4XmlK/mjIEgaHR0cC9odHRwcyBVUkzvvIzlvZPliY3kuLo6ICR7cGFyc2VkVXJsLnByb3RvY29sfWApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAgIGVuZHBvaW50LFxuICAgICAgICB0aW1lb3V0TXMsXG4gICAgICAgIGRlYnVnXG4gICAgfTtcbn1cblxuZnVuY3Rpb24gcHJpbnRIZWxwQW5kRXhpdChjb2RlOiBudW1iZXIsIGVycm9yTWVzc2FnZT86IHN0cmluZyk6IG5ldmVyIHtcbiAgICBpZiAoZXJyb3JNZXNzYWdlKSB7XG4gICAgICAgIHByb2Nlc3Muc3RkZXJyLndyaXRlKGBbc3RkaW8taHR0cC1icmlkZ2VdW2Vycm9yXSAke2Vycm9yTWVzc2FnZX1cXG5gKTtcbiAgICB9XG5cbiAgICBwcm9jZXNzLnN0ZGVyci53cml0ZShcbiAgICAgICAgW1xuICAgICAgICAgICAgJ+eUqOazlTogbm9kZSBkaXN0L3N0ZGlvLWh0dHAtYnJpZGdlLmpzIFstLXVybCA8bWNwX2h0dHBfdXJsPl0gWy0tdGltZW91dCA8bXM+XSBbLS1kZWJ1Z10nLFxuICAgICAgICAgICAgJycsXG4gICAgICAgICAgICAn5Y2P6K6uOicsXG4gICAgICAgICAgICAnICBzdGRpbi9zdGRvdXQg5Z2H5L2/55So5qCH5YeG5o2i6KGM5YiG6ZqU77yI5q+P6KGM5LiA5p2hIEpTT04tUlBDIOa2iOaBr++8iScsXG4gICAgICAgICAgICAnJyxcbiAgICAgICAgICAgICflj4LmlbA6JyxcbiAgICAgICAgICAgICcgIC0tdXJsICAgICAgTUNQIEhUVFAg56uv54K577yM6buY6K6kIGh0dHA6Ly8xMjcuMC4wLjE6MzAwMC9tY3AnLFxuICAgICAgICAgICAgJyAgLS10aW1lb3V0ICDor7fmsYLotoXml7bmr6vnp5LvvIzpu5jorqQgMzAwMDAnLFxuICAgICAgICAgICAgJyAgLS1kZWJ1ZyAgICDovpPlh7rosIPor5Xml6Xlv5fvvIhzdGRlcnLvvIknLFxuICAgICAgICAgICAgJycsXG4gICAgICAgICAgICAn546v5aKD5Y+Y6YePOicsXG4gICAgICAgICAgICAnICBDT0NPU19NQ1BfSFRUUF9VUkwgICAgICAgICDpu5jorqQgSFRUUCDnq6/ngrknLFxuICAgICAgICAgICAgJyAgQ09DT1NfTUNQX0hUVFBfVElNRU9VVF9NUyAg6buY6K6k6LaF5pe25q+r56eSJ1xuICAgICAgICBdLmpvaW4oJ1xcbicpICsgJ1xcbidcbiAgICApO1xuXG4gICAgcHJvY2Vzcy5leGl0KGNvZGUpO1xufVxuXG5mdW5jdGlvbiBtYWluKCk6IHZvaWQge1xuICAgIGNvbnN0IG9wdGlvbnMgPSBwYXJzZUFyZ3MocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKTtcbiAgICBjb25zdCBicmlkZ2UgPSBuZXcgU3RkaW9IdHRwQnJpZGdlKG9wdGlvbnMpO1xuICAgIGJyaWRnZS5zdGFydCgpO1xufVxuXG5pZiAocmVxdWlyZS5tYWluID09PSBtb2R1bGUpIHtcbiAgICBtYWluKCk7XG59XG5cbmV4cG9ydCB7IFN0ZGlvSHR0cEJyaWRnZSwgQnJpZGdlT3B0aW9ucyB9O1xuIl19