"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.StdioHttpBridge = void 0;
const http = __importStar(require("http"));
const https = __importStar(require("https"));
const url_1 = require("url");
const DEFAULT_ENDPOINT = process.env.COCOS_MCP_HTTP_URL || 'http://127.0.0.1:3000/mcp';
const DEFAULT_TIMEOUT_MS = Number(process.env.COCOS_MCP_HTTP_TIMEOUT_MS || 30000);
class StdioHttpBridge {
    constructor(options) {
        this.buffer = '';
        this.processingQueue = Promise.resolve();
        this.sessionId = null;
        this.options = options;
    }
    start() {
        process.stdin.setEncoding('utf8');
        process.stdin.on('data', (chunk) => {
            this.onStdinData(chunk);
        });
        process.stdin.on('error', (error) => {
            this.logError(`读取 stdin 失败: ${error.message}`);
        });
        process.stdin.on('end', () => {
            this.logDebug('stdin 已结束，桥接进程即将退出。');
            process.exit(0);
        });
        process.on('SIGINT', () => process.exit(0));
        process.on('SIGTERM', () => process.exit(0));
        process.stdin.resume();
        this.logDebug(`桥接已启动（标准换行协议），目标 MCP 端点: ${this.options.endpoint}`);
    }
    onStdinData(chunk) {
        this.buffer += chunk;
        while (true) {
            const newlineIndex = this.buffer.indexOf('\n');
            if (newlineIndex === -1) {
                return;
            }
            const rawLine = this.buffer.slice(0, newlineIndex);
            this.buffer = this.buffer.slice(newlineIndex + 1);
            const line = rawLine.replace(/\r$/, '').trim();
            if (!line) {
                continue;
            }
            this.enqueueMessage(line);
        }
    }
    enqueueMessage(messageText) {
        this.processingQueue = this.processingQueue
            .then(() => this.handleMessage(messageText))
            .catch((error) => {
            this.logError(`处理消息失败: ${error.message}`);
        });
    }
    async handleMessage(messageText) {
        let message;
        try {
            message = JSON.parse(messageText);
        }
        catch (error) {
            this.logError(`收到非法 JSON: ${error.message}`);
            const parseError = {
                jsonrpc: '2.0',
                id: null,
                error: {
                    code: -32700,
                    message: `Parse error: ${error.message}`
                }
            };
            this.writeStdoutLine(JSON.stringify(parseError));
            return;
        }
        const expectsResponse = this.expectsResponse(message);
        try {
            const response = await this.forwardToHttp(messageText, message);
            this.captureSessionId(message, response.headers);
            if (!expectsResponse) {
                return;
            }
            if (!response.body.trim()) {
                const emptyResponseError = this.buildErrorResponse(message, -32603, 'Bridge error: upstream returned empty response body for request.');
                if (emptyResponseError) {
                    this.writeStdoutLine(JSON.stringify(emptyResponseError));
                }
                return;
            }
            this.writeStdoutLine(response.body.trim());
        }
        catch (error) {
            this.logError(`转发到 HTTP 端点失败: ${error.message}`);
            const errorResponse = this.buildErrorResponse(message, -32603, `Bridge transport error: ${error.message}`);
            if (errorResponse) {
                this.writeStdoutLine(JSON.stringify(errorResponse));
            }
        }
    }
    expectsResponse(message) {
        if (Array.isArray(message)) {
            return message.some((item) => this.isRequestMessage(item));
        }
        return this.isRequestMessage(message);
    }
    isRequestMessage(message) {
        if (!message || typeof message !== 'object' || Array.isArray(message)) {
            return false;
        }
        return typeof message.method === 'string' && Object.prototype.hasOwnProperty.call(message, 'id');
    }
    buildErrorResponse(message, code, errorMessage) {
        var _a;
        if (Array.isArray(message)) {
            const requestIds = message
                .filter((item) => this.isRequestMessage(item))
                .map((item) => { var _a; return (_a = item.id) !== null && _a !== void 0 ? _a : null; });
            if (requestIds.length === 0) {
                return null;
            }
            return requestIds.map((id) => ({
                jsonrpc: '2.0',
                id,
                error: {
                    code,
                    message: errorMessage
                }
            }));
        }
        if (!this.isRequestMessage(message)) {
            return null;
        }
        return {
            jsonrpc: '2.0',
            id: (_a = message.id) !== null && _a !== void 0 ? _a : null,
            error: {
                code,
                message: errorMessage
            }
        };
    }
    async forwardToHttp(rawBody, message) {
        const endpointUrl = new url_1.URL(this.options.endpoint);
        const client = endpointUrl.protocol === 'https:' ? https : http;
        const payload = Buffer.from(rawBody, 'utf8');
        const headers = this.buildRequestHeaders(message, payload.length);
        return new Promise((resolve, reject) => {
            const request = client.request(endpointUrl, {
                method: 'POST',
                headers
            }, (response) => {
                const chunks = [];
                response.on('data', (chunk) => {
                    chunks.push(typeof chunk === 'string' ? Buffer.from(chunk) : chunk);
                });
                response.on('end', () => {
                    const body = Buffer.concat(chunks).toString('utf8');
                    const statusCode = response.statusCode || 0;
                    if (statusCode >= 400) {
                        reject(new Error(`upstream HTTP ${statusCode}: ${body || 'empty body'}`));
                        return;
                    }
                    resolve({
                        statusCode,
                        body,
                        headers: response.headers
                    });
                });
            });
            request.setTimeout(this.options.timeoutMs, () => {
                request.destroy(new Error(`request timeout after ${this.options.timeoutMs}ms`));
            });
            request.on('error', (error) => {
                reject(error);
            });
            request.write(payload);
            request.end();
        });
    }
    buildRequestHeaders(message, payloadLength) {
        const headers = {
            'Content-Type': 'application/json',
            'Content-Length': String(payloadLength),
            Accept: 'application/json'
        };
        if (this.sessionId && this.requiresSessionHeader(message)) {
            headers['MCP-Session-Id'] = this.sessionId;
        }
        return headers;
    }
    requiresSessionHeader(message) {
        if (!message || typeof message !== 'object' || Array.isArray(message)) {
            return false;
        }
        const method = message.method;
        if (typeof method !== 'string') {
            return false;
        }
        return method !== 'initialize';
    }
    captureSessionId(message, headers) {
        if (!message || typeof message !== 'object' || Array.isArray(message)) {
            return;
        }
        const method = message.method;
        if (method !== 'initialize') {
            return;
        }
        const raw = headers['mcp-session-id'];
        if (Array.isArray(raw)) {
            this.sessionId = raw[0] || null;
            return;
        }
        if (typeof raw === 'string' && raw.trim()) {
            this.sessionId = raw;
        }
    }
    writeStdoutLine(payload) {
        process.stdout.write(`${payload}\n`);
        this.logDebug(`已写出响应消息，大小 ${Buffer.byteLength(payload, 'utf8')} 字节`);
    }
    logDebug(message) {
        if (this.options.debug) {
            process.stderr.write(`[stdio-http-bridge][debug] ${message}\n`);
        }
    }
    logError(message) {
        process.stderr.write(`[stdio-http-bridge][error] ${message}\n`);
    }
}
exports.StdioHttpBridge = StdioHttpBridge;
function parseArgs(argv) {
    let endpoint = DEFAULT_ENDPOINT;
    let timeoutMs = Number.isFinite(DEFAULT_TIMEOUT_MS) ? DEFAULT_TIMEOUT_MS : 30000;
    let debug = false;
    for (let i = 0; i < argv.length; i += 1) {
        const arg = argv[i];
        if (arg === '--help' || arg === '-h') {
            printHelpAndExit(0);
        }
        else if (arg === '--debug') {
            debug = true;
        }
        else if (arg === '--url') {
            const next = argv[i + 1];
            if (!next) {
                printHelpAndExit(1, '--url 缺少参数');
            }
            endpoint = next;
            i += 1;
        }
        else if (arg.startsWith('--url=')) {
            endpoint = arg.slice('--url='.length);
        }
        else if (arg === '--timeout') {
            const next = argv[i + 1];
            if (!next) {
                printHelpAndExit(1, '--timeout 缺少参数');
            }
            timeoutMs = Number(next);
            i += 1;
        }
        else if (arg.startsWith('--timeout=')) {
            timeoutMs = Number(arg.slice('--timeout='.length));
        }
        else {
            printHelpAndExit(1, `未知参数: ${arg}`);
        }
    }
    if (!Number.isFinite(timeoutMs) || timeoutMs <= 0) {
        printHelpAndExit(1, `--timeout 参数无效: ${timeoutMs}`);
    }
    let parsedUrl;
    try {
        parsedUrl = new url_1.URL(endpoint);
    }
    catch (error) {
        printHelpAndExit(1, `--url 参数无效: ${error.message}`);
    }
    if (parsedUrl.protocol !== 'http:' && parsedUrl.protocol !== 'https:') {
        printHelpAndExit(1, `仅支持 http/https URL，当前为: ${parsedUrl.protocol}`);
    }
    return {
        endpoint,
        timeoutMs,
        debug
    };
}
function printHelpAndExit(code, errorMessage) {
    if (errorMessage) {
        process.stderr.write(`[stdio-http-bridge][error] ${errorMessage}\n`);
    }
    process.stderr.write([
        '用法: node dist/stdio-http-bridge.js [--url <mcp_http_url>] [--timeout <ms>] [--debug]',
        '',
        '协议:',
        '  stdin/stdout 均使用标准换行分隔（每行一条 JSON-RPC 消息）',
        '',
        '参数:',
        '  --url      MCP HTTP 端点，默认 http://127.0.0.1:3000/mcp',
        '  --timeout  请求超时毫秒，默认 30000',
        '  --debug    输出调试日志（stderr）',
        '',
        '环境变量:',
        '  COCOS_MCP_HTTP_URL         默认 HTTP 端点',
        '  COCOS_MCP_HTTP_TIMEOUT_MS  默认超时毫秒'
    ].join('\n') + '\n');
    process.exit(code);
}
function main() {
    const options = parseArgs(process.argv.slice(2));
    const bridge = new StdioHttpBridge(options);
    bridge.start();
}
if (require.main === module) {
    main();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RkaW8taHR0cC1icmlkZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zb3VyY2Uvc3RkaW8taHR0cC1icmlkZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQTZCO0FBQzdCLDZDQUErQjtBQUMvQiw2QkFBMEI7QUF1QjFCLE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsSUFBSSwyQkFBMkIsQ0FBQztBQUN2RixNQUFNLGtCQUFrQixHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixJQUFJLEtBQUssQ0FBQyxDQUFDO0FBRWxGLE1BQU0sZUFBZTtJQU1qQixZQUFZLE9BQXNCO1FBSjFCLFdBQU0sR0FBRyxFQUFFLENBQUM7UUFDWixvQkFBZSxHQUFrQixPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDbkQsY0FBUyxHQUFrQixJQUFJLENBQUM7UUFHcEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7SUFDM0IsQ0FBQztJQUVNLEtBQUs7UUFDUixPQUFPLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUVsQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFhLEVBQUUsRUFBRTtZQUN2QyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDaEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDbkQsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFL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Q0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsSUFBWSxFQUFFLFlBQXFCO0lBQ3pELElBQUksWUFBWSxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsWUFBWSxJQUFJLENBQUMsQ0FBQztJQUN6RSxDQUFDO0lBRUQsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQ2hCO1FBQ0ksc0ZBQXNGO1FBQ3RGLEVBQUU7UUFDRixLQUFLO1FBQ0wsNENBQTRDO1FBQzVDLEVBQUU7UUFDRixLQUFLO1FBQ0wsdURBQXVEO1FBQ3ZELDhCQUE4QjtRQUM5Qiw2QkFBNkI7UUFDN0IsRUFBRTtRQUNGLE9BQU87UUFDUCx5Q0FBeUM7UUFDekMscUNBQXFDO0tBQ3hDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FDdEIsQ0FBQztJQUVGLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdkIsQ0FBQztBQUVELFNBQVMsSUFBSTtJQUNULE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pELE1BQU0sTUFBTSxHQUFHLElBQUksZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzVDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUNuQixDQUFDO0FBRUQsSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRSxDQUFDO0lBQzFCLElBQUksRUFBRSxDQUFDO0FBQ1gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGh0dHAgZnJvbSAnaHR0cCc7XG5pbXBvcnQgKiBhcyBodHRwcyBmcm9tICdodHRwcyc7XG5pbXBvcnQgeyBVUkwgfSBmcm9tICd1cmwnO1xuXG5pbnRlcmZhY2UgQnJpZGdlT3B0aW9ucyB7XG4gICAgZW5kcG9pbnQ6IHN0cmluZztcbiAgICB0aW1lb3V0TXM6IG51bWJlcjtcbiAgICBkZWJ1ZzogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIEh0dHBSZXNwb25zZSB7XG4gICAgc3RhdHVzQ29kZTogbnVtYmVyO1xuICAgIGJvZHk6IHN0cmluZztcbiAgICBoZWFkZXJzOiBodHRwLkluY29taW5nSHR0cEhlYWRlcnM7XG59XG5cbmludGVyZmFjZSBKc29uUnBjRXJyb3JSZXNwb25zZSB7XG4gICAganNvbnJwYzogJzIuMCc7XG4gICAgaWQ6IHN0cmluZyB8IG51bWJlciB8IG51bGw7XG4gICAgZXJyb3I6IHtcbiAgICAgICAgY29kZTogbnVtYmVyO1xuICAgICAgICBtZXNzYWdlOiBzdHJpbmc7XG4gICAgfTtcbn1cblxuY29uc3QgREVGQVVMVF9FTkRQT0lOVCA9IHByb2Nlc3MuZW52LkNPQ09TX01DUF9IVFRQX1VSTCB8fCAnaHR0cDovLzEyNy4wLjAuMTozMDAwL21jcCc7XG5jb25zdCBERUZBVUxUX1RJTUVPVVRfTVMgPSBOdW1iZXIocHJvY2Vzcy5lbnYuQ09DT1NfTUNQX0hUVFBfVElNRU9VVF9NUyB8fCAzMDAwMCk7XG5cbmNsYXNzIFN0ZGlvSHR0cEJyaWRnZSB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBvcHRpb25zOiBCcmlkZ2VPcHRpb25zO1xuICAgIHByaXZhdGUgYnVmZmVyID0gJyc7XG4gICAgcHJpdmF0ZSBwcm9jZXNzaW5nUXVldWU6IFByb21pc2U8dm9pZD4gPSBQcm9taXNlLnJlc29sdmUoKTtcbiAgICBwcml2YXRlIHNlc3Npb25JZDogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBCcmlkZ2VPcHRpb25zKSB7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXJ0KCk6IHZvaWQge1xuICAgICAgICBwcm9jZXNzLnN0ZGluLnNldEVuY29kaW5nKCd1dGY4Jyk7XG5cbiAgICAgICAgcHJvY2Vzcy5zdGRpbi5vbignZGF0YScsIChjaHVuazogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICB0aGlzLm9uU3RkaW5EYXRhKGNodW5rKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcHJvY2Vzcy5zdGRpbi5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgIHRoaXMubG9nRXJyb3IoYOivu+WPliBzdGRpbiDlpLHotKU6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcHJvY2Vzcy5zdGRpbi5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5sb2dEZWJ1Zygnc3RkaW4g5bey57uT5p2f77yM5qGl5o6l6L+b56iL5Y2z5bCG6YCA5Ye644CCJyk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHByb2Nlc3Mub24oJ1NJR0lOVCcsICgpID0+IHByb2Nlc3MuZXhpdCgwKSk7XG4gICAgICAgIHByb2Nlc3Mub24oJ1NJR1RFUk0nLCAoKSA9PiBwcm9jZXNzLmV4aXQoMCkpO1xuXG4gICAgICAgIHByb2Nlc3Muc3RkaW4ucmVzdW1lKCk7XG4gICAgICAgIHRoaXMubG9nRGVidWcoYOahpeaOpeW3suWQr+WKqO+8iOagh+WHhuaNouihjOWNj+iuru+8ie+8jOebruaghyBNQ1Ag56uv54K5OiAke3RoaXMub3B0aW9ucy5lbmRwb2ludH1gKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uU3RkaW5EYXRhKGNodW5rOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5idWZmZXIgKz0gY2h1bms7XG5cbiAgICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgICAgIGNvbnN0IG5ld2xpbmVJbmRleCA9IHRoaXMuYnVmZmVyLmluZGV4T2YoJ1xcbicpO1xuICAgICAgICAgICAgaWYgKG5ld2xpbmVJbmRleCA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHJhd0xpbmUgPSB0aGlzLmJ1ZmZlci5zbGljZSgwLCBuZXdsaW5lSW5kZXgpO1xuICAgICAgICAgICAgdGhpcy5idWZmZXIgPSB0aGlzLmJ1ZmZlci5zbGljZShuZXdsaW5lSW5kZXggKyAxKTtcblxuICAgICAgICAgICAgY29uc3QgbGluZSA9IHJhd0xpbmUucmVwbGFjZSgvXFxyJC8sICcnKS50cmltKCk7XG4gICAgICAgICAgICBpZiAoIWxpbmUpIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5lbnF1ZXVlTWVzc2FnZShsaW5lKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZW5xdWV1ZU1lc3NhZ2UobWVzc2FnZVRleHQ6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLnByb2Nlc3NpbmdRdWV1ZSA9IHRoaXMucHJvY2Vzc2luZ1F1ZXVlXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLmhhbmRsZU1lc3NhZ2UobWVzc2FnZVRleHQpKVxuICAgICAgICAgICAgLmNhdGNoKChlcnJvcjogRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ0Vycm9yKGDlpITnkIbmtojmga/lpLHotKU6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgaGFuZGxlTWVzc2FnZShtZXNzYWdlVGV4dDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGxldCBtZXNzYWdlOiBhbnk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIG1lc3NhZ2UgPSBKU09OLnBhcnNlKG1lc3NhZ2VUZXh0KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgICAgICAgdGhpcy5sb2dFcnJvcihg5pS25Yiw6Z2e5rOVIEpTT046ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlRXJyb3I6IEpzb25ScGNFcnJvclJlc3BvbnNlID0ge1xuICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgIGlkOiBudWxsLFxuICAgICAgICAgICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgICAgICAgICAgIGNvZGU6IC0zMjcwMCxcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogYFBhcnNlIGVycm9yOiAke2Vycm9yLm1lc3NhZ2V9YFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLndyaXRlU3Rkb3V0TGluZShKU09OLnN0cmluZ2lmeShwYXJzZUVycm9yKSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBleHBlY3RzUmVzcG9uc2UgPSB0aGlzLmV4cGVjdHNSZXNwb25zZShtZXNzYWdlKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmZvcndhcmRUb0h0dHAobWVzc2FnZVRleHQsIG1lc3NhZ2UpO1xuXG4gICAgICAgICAgICB0aGlzLmNhcHR1cmVTZXNzaW9uSWQobWVzc2FnZSwgcmVzcG9uc2UuaGVhZGVycyk7XG5cbiAgICAgICAgICAgIGlmICghZXhwZWN0c1Jlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIXJlc3BvbnNlLmJvZHkudHJpbSgpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZW1wdHlSZXNwb25zZUVycm9yID0gdGhpcy5idWlsZEVycm9yUmVzcG9uc2UoXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICAgIC0zMjYwMyxcbiAgICAgICAgICAgICAgICAgICAgJ0JyaWRnZSBlcnJvcjogdXBzdHJlYW0gcmV0dXJuZWQgZW1wdHkgcmVzcG9uc2UgYm9keSBmb3IgcmVxdWVzdC4nXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBpZiAoZW1wdHlSZXNwb25zZUVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMud3JpdGVTdGRvdXRMaW5lKEpTT04uc3RyaW5naWZ5KGVtcHR5UmVzcG9uc2VFcnJvcikpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMud3JpdGVTdGRvdXRMaW5lKHJlc3BvbnNlLmJvZHkudHJpbSgpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgICAgICAgdGhpcy5sb2dFcnJvcihg6L2s5Y+R5YiwIEhUVFAg56uv54K55aSx6LSlOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgICBjb25zdCBlcnJvclJlc3BvbnNlID0gdGhpcy5idWlsZEVycm9yUmVzcG9uc2UoXG4gICAgICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgICAgICAtMzI2MDMsXG4gICAgICAgICAgICAgICAgYEJyaWRnZSB0cmFuc3BvcnQgZXJyb3I6ICR7ZXJyb3IubWVzc2FnZX1gXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBpZiAoZXJyb3JSZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIHRoaXMud3JpdGVTdGRvdXRMaW5lKEpTT04uc3RyaW5naWZ5KGVycm9yUmVzcG9uc2UpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZXhwZWN0c1Jlc3BvbnNlKG1lc3NhZ2U6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShtZXNzYWdlKSkge1xuICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2Uuc29tZSgoaXRlbSkgPT4gdGhpcy5pc1JlcXVlc3RNZXNzYWdlKGl0ZW0pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmlzUmVxdWVzdE1lc3NhZ2UobWVzc2FnZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc1JlcXVlc3RNZXNzYWdlKG1lc3NhZ2U6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAoIW1lc3NhZ2UgfHwgdHlwZW9mIG1lc3NhZ2UgIT09ICdvYmplY3QnIHx8IEFycmF5LmlzQXJyYXkobWVzc2FnZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0eXBlb2YgbWVzc2FnZS5tZXRob2QgPT09ICdzdHJpbmcnICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAnaWQnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGJ1aWxkRXJyb3JSZXNwb25zZShcbiAgICAgICAgbWVzc2FnZTogYW55LFxuICAgICAgICBjb2RlOiBudW1iZXIsXG4gICAgICAgIGVycm9yTWVzc2FnZTogc3RyaW5nXG4gICAgKTogSnNvblJwY0Vycm9yUmVzcG9uc2UgfCBKc29uUnBjRXJyb3JSZXNwb25zZVtdIHwgbnVsbCB7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KG1lc3NhZ2UpKSB7XG4gICAgICAgICAgICBjb25zdCByZXF1ZXN0SWRzID0gbWVzc2FnZVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoKGl0ZW0pID0+IHRoaXMuaXNSZXF1ZXN0TWVzc2FnZShpdGVtKSlcbiAgICAgICAgICAgICAgICAubWFwKChpdGVtKSA9PiBpdGVtLmlkID8/IG51bGwpO1xuXG4gICAgICAgICAgICBpZiAocmVxdWVzdElkcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHJlcXVlc3RJZHMubWFwKChpZCkgPT4gKHtcbiAgICAgICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgICAgICAgICAgICBpZCxcbiAgICAgICAgICAgICAgICBlcnJvcjoge1xuICAgICAgICAgICAgICAgICAgICBjb2RlLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnJvck1lc3NhZ2VcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRoaXMuaXNSZXF1ZXN0TWVzc2FnZShtZXNzYWdlKSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAganNvbnJwYzogJzIuMCcsXG4gICAgICAgICAgICBpZDogbWVzc2FnZS5pZCA/PyBudWxsLFxuICAgICAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICAgICAgICBjb2RlLFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yTWVzc2FnZVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgZm9yd2FyZFRvSHR0cChyYXdCb2R5OiBzdHJpbmcsIG1lc3NhZ2U6IHVua25vd24pOiBQcm9taXNlPEh0dHBSZXNwb25zZT4ge1xuICAgICAgICBjb25zdCBlbmRwb2ludFVybCA9IG5ldyBVUkwodGhpcy5vcHRpb25zLmVuZHBvaW50KTtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gZW5kcG9pbnRVcmwucHJvdG9jb2wgPT09ICdodHRwczonID8gaHR0cHMgOiBodHRwO1xuICAgICAgICBjb25zdCBwYXlsb2FkID0gQnVmZmVyLmZyb20ocmF3Qm9keSwgJ3V0ZjgnKTtcbiAgICAgICAgY29uc3QgaGVhZGVycyA9IHRoaXMuYnVpbGRSZXF1ZXN0SGVhZGVycyhtZXNzYWdlLCBwYXlsb2FkLmxlbmd0aCk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPEh0dHBSZXNwb25zZT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVxdWVzdCA9IGNsaWVudC5yZXF1ZXN0KFxuICAgICAgICAgICAgICAgIGVuZHBvaW50VXJsLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICAgICAgICAgIGhlYWRlcnNcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjaHVua3M6IEJ1ZmZlcltdID0gW107XG5cbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2Uub24oJ2RhdGEnLCAoY2h1bms6IEJ1ZmZlciB8IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2h1bmtzLnB1c2godHlwZW9mIGNodW5rID09PSAnc3RyaW5nJyA/IEJ1ZmZlci5mcm9tKGNodW5rKSA6IGNodW5rKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2Uub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJvZHkgPSBCdWZmZXIuY29uY2F0KGNodW5rcykudG9TdHJpbmcoJ3V0ZjgnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1c0NvZGUgPSByZXNwb25zZS5zdGF0dXNDb2RlIHx8IDA7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0dXNDb2RlID49IDQwMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYHVwc3RyZWFtIEhUVFAgJHtzdGF0dXNDb2RlfTogJHtib2R5IHx8ICdlbXB0eSBib2R5J31gKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXNDb2RlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvZHksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogcmVzcG9uc2UuaGVhZGVyc1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIHJlcXVlc3Quc2V0VGltZW91dCh0aGlzLm9wdGlvbnMudGltZW91dE1zLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVxdWVzdC5kZXN0cm95KG5ldyBFcnJvcihgcmVxdWVzdCB0aW1lb3V0IGFmdGVyICR7dGhpcy5vcHRpb25zLnRpbWVvdXRNc31tc2ApKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXF1ZXN0Lm9uKCdlcnJvcicsIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcmVxdWVzdC53cml0ZShwYXlsb2FkKTtcbiAgICAgICAgICAgIHJlcXVlc3QuZW5kKCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgYnVpbGRSZXF1ZXN0SGVhZGVycyhtZXNzYWdlOiB1bmtub3duLCBwYXlsb2FkTGVuZ3RoOiBudW1iZXIpOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+IHtcbiAgICAgICAgY29uc3QgaGVhZGVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgICAnQ29udGVudC1MZW5ndGgnOiBTdHJpbmcocGF5bG9hZExlbmd0aCksXG4gICAgICAgICAgICBBY2NlcHQ6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgICB9O1xuXG4gICAgICAgIGlmICh0aGlzLnNlc3Npb25JZCAmJiB0aGlzLnJlcXVpcmVzU2Vzc2lvbkhlYWRlcihtZXNzYWdlKSkge1xuICAgICAgICAgICAgaGVhZGVyc1snTUNQLVNlc3Npb24tSWQnXSA9IHRoaXMuc2Vzc2lvbklkO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGhlYWRlcnM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZXF1aXJlc1Nlc3Npb25IZWFkZXIobWVzc2FnZTogdW5rbm93bik6IGJvb2xlYW4ge1xuICAgICAgICBpZiAoIW1lc3NhZ2UgfHwgdHlwZW9mIG1lc3NhZ2UgIT09ICdvYmplY3QnIHx8IEFycmF5LmlzQXJyYXkobWVzc2FnZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG1ldGhvZCA9IChtZXNzYWdlIGFzIGFueSkubWV0aG9kO1xuICAgICAgICBpZiAodHlwZW9mIG1ldGhvZCAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBtZXRob2QgIT09ICdpbml0aWFsaXplJztcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhcHR1cmVTZXNzaW9uSWQobWVzc2FnZTogdW5rbm93biwgaGVhZGVyczogaHR0cC5JbmNvbWluZ0h0dHBIZWFkZXJzKTogdm9pZCB7XG4gICAgICAgIGlmICghbWVzc2FnZSB8fCB0eXBlb2YgbWVzc2FnZSAhPT0gJ29iamVjdCcgfHwgQXJyYXkuaXNBcnJheShtZXNzYWdlKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbWV0aG9kID0gKG1lc3NhZ2UgYXMgYW55KS5tZXRob2Q7XG4gICAgICAgIGlmIChtZXRob2QgIT09ICdpbml0aWFsaXplJykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmF3ID0gaGVhZGVyc1snbWNwLXNlc3Npb24taWQnXTtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmF3KSkge1xuICAgICAgICAgICAgdGhpcy5zZXNzaW9uSWQgPSByYXdbMF0gfHwgbnVsbDtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlb2YgcmF3ID09PSAnc3RyaW5nJyAmJiByYXcudHJpbSgpKSB7XG4gICAgICAgICAgICB0aGlzLnNlc3Npb25JZCA9IHJhdztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgd3JpdGVTdGRvdXRMaW5lKHBheWxvYWQ6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShgJHtwYXlsb2FkfVxcbmApO1xuICAgICAgICB0aGlzLmxvZ0RlYnVnKGDlt7Llhpnlh7rlk43lupTmtojmga/vvIzlpKflsI8gJHtCdWZmZXIuYnl0ZUxlbmd0aChwYXlsb2FkLCAndXRmOCcpfSDlrZfoioJgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGxvZ0RlYnVnKG1lc3NhZ2U6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmRlYnVnKSB7XG4gICAgICAgICAgICBwcm9jZXNzLnN0ZGVyci53cml0ZShgW3N0ZGlvLWh0dHAtYnJpZGdlXVtkZWJ1Z10gJHttZXNzYWdlfVxcbmApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBsb2dFcnJvcihtZXNzYWdlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgcHJvY2Vzcy5zdGRlcnIud3JpdGUoYFtzdGRpby1odHRwLWJyaWRnZV1bZXJyb3JdICR7bWVzc2FnZX1cXG5gKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHBhcnNlQXJncyhhcmd2OiBzdHJpbmdbXSk6IEJyaWRnZU9wdGlvbnMge1xuICAgIGxldCBlbmRwb2ludCA9IERFRkFVTFRfRU5EUE9JTlQ7XG4gICAgbGV0IHRpbWVvdXRNcyA9IE51bWJlci5pc0Zpbml0ZShERUZBVUxUX1RJTUVPVVRfTVMpID8gREVGQVVMVF9USU1FT1VUX01TIDogMzAwMDA7XG4gICAgbGV0IGRlYnVnID0gZmFsc2U7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyZ3YubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgY29uc3QgYXJnID0gYXJndltpXTtcblxuICAgICAgICBpZiAoYXJnID09PSAnLS1oZWxwJyB8fCBhcmcgPT09ICctaCcpIHtcbiAgICAgICAgICAgIHByaW50SGVscEFuZEV4aXQoMCk7XG4gICAgICAgIH0gZWxzZSBpZiAoYXJnID09PSAnLS1kZWJ1ZycpIHtcbiAgICAgICAgICAgIGRlYnVnID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIGlmIChhcmcgPT09ICctLXVybCcpIHtcbiAgICAgICAgICAgIGNvbnN0IG5leHQgPSBhcmd2W2kgKyAxXTtcbiAgICAgICAgICAgIGlmICghbmV4dCkge1xuICAgICAgICAgICAgICAgIHByaW50SGVscEFuZEV4aXQoMSwgJy0tdXJsIOe8uuWwkeWPguaVsCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZW5kcG9pbnQgPSBuZXh0O1xuICAgICAgICAgICAgaSArPSAxO1xuICAgICAgICB9IGVsc2UgaWYgKGFyZy5zdGFydHNXaXRoKCctLXVybD0nKSkge1xuICAgICAgICAgICAgZW5kcG9pbnQgPSBhcmcuc2xpY2UoJy0tdXJsPScubGVuZ3RoKTtcbiAgICAgICAgfSBlbHNlIGlmIChhcmcgPT09ICctLXRpbWVvdXQnKSB7XG4gICAgICAgICAgICBjb25zdCBuZXh0ID0gYXJndltpICsgMV07XG4gICAgICAgICAgICBpZiAoIW5leHQpIHtcbiAgICAgICAgICAgICAgICBwcmludEhlbHBBbmRFeGl0KDEsICctLXRpbWVvdXQg57y65bCR5Y+C5pWwJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aW1lb3V0TXMgPSBOdW1iZXIobmV4dCk7XG4gICAgICAgICAgICBpICs9IDE7XG4gICAgICAgIH0gZWxzZSBpZiAoYXJnLnN0YXJ0c1dpdGgoJy0tdGltZW91dD0nKSkge1xuICAgICAgICAgICAgdGltZW91dE1zID0gTnVtYmVyKGFyZy5zbGljZSgnLS10aW1lb3V0PScubGVuZ3RoKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBwcmludEhlbHBBbmRFeGl0KDEsIGDmnKrnn6Xlj4LmlbA6ICR7YXJnfWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFOdW1iZXIuaXNGaW5pdGUodGltZW91dE1zKSB8fCB0aW1lb3V0TXMgPD0gMCkge1xuICAgICAgICBwcmludEhlbHBBbmRFeGl0KDEsIGAtLXRpbWVvdXQg5Y+C5pWw5peg5pWIOiAke3RpbWVvdXRNc31gKTtcbiAgICB9XG5cbiAgICBsZXQgcGFyc2VkVXJsOiBVUkw7XG4gICAgdHJ5IHtcbiAgICAgICAgcGFyc2VkVXJsID0gbmV3IFVSTChlbmRwb2ludCk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgICBwcmludEhlbHBBbmRFeGl0KDEsIGAtLXVybCDlj4LmlbDml6DmlYg6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICB9XG5cbiAgICBpZiAocGFyc2VkVXJsLnByb3RvY29sICE9PSAnaHR0cDonICYmIHBhcnNlZFVybC5wcm90b2NvbCAhPT0gJ2h0dHBzOicpIHtcbiAgICAgICAgcHJpbnRIZWxwQW5kRXhpdCgxLCBg5LuF5pSv5oyBIGh0dHAvaHR0cHMgVVJM77yM5b2T5YmN5Li6OiAke3BhcnNlZFVybC5wcm90b2NvbH1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBlbmRwb2ludCxcbiAgICAgICAgdGltZW91dE1zLFxuICAgICAgICBkZWJ1Z1xuICAgIH07XG59XG5cbmZ1bmN0aW9uIHByaW50SGVscEFuZEV4aXQoY29kZTogbnVtYmVyLCBlcnJvck1lc3NhZ2U/OiBzdHJpbmcpOiBuZXZlciB7XG4gICAgaWYgKGVycm9yTWVzc2FnZSkge1xuICAgICAgICBwcm9jZXNzLnN0ZGVyci53cml0ZShgW3N0ZGlvLWh0dHAtYnJpZGdlXVtlcnJvcl0gJHtlcnJvck1lc3NhZ2V9XFxuYCk7XG4gICAgfVxuXG4gICAgcHJvY2Vzcy5zdGRlcnIud3JpdGUoXG4gICAgICAgIFtcbiAgICAgICAgICAgICfnlKjms5U6IG5vZGUgZGlzdC9zdGRpby1odHRwLWJyaWRnZS5qcyBbLS11cmwgPG1jcF9odHRwX3VybD5dIFstLXRpbWVvdXQgPG1zPl0gWy0tZGVidWddJyxcbiAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgJ+WNj+iurjonLFxuICAgICAgICAgICAgJyAgc3RkaW4vc3Rkb3V0IOWdh+S9v+eUqOagh+WHhuaNouihjOWIhumalO+8iOavj+ihjOS4gOadoSBKU09OLVJQQyDmtojmga/vvIknLFxuICAgICAgICAgICAgJycsXG4gICAgICAgICAgICAn5Y+C5pWwOicsXG4gICAgICAgICAgICAnICAtLXVybCAgICAgIE1DUCBIVFRQIOerr+eCue+8jOm7mOiupCBodHRwOi8vMTI3LjAuMC4xOjMwMDAvbWNwJyxcbiAgICAgICAgICAgICcgIC0tdGltZW91dCAg6K+35rGC6LaF5pe25q+r56eS77yM6buY6K6kIDMwMDAwJyxcbiAgICAgICAgICAgICcgIC0tZGVidWcgICAg6L6T5Ye66LCD6K+V5pel5b+X77yIc3RkZXJy77yJJyxcbiAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgJ+eOr+Wig+WPmOmHjzonLFxuICAgICAgICAgICAgJyAgQ09DT1NfTUNQX0hUVFBfVVJMICAgICAgICAg6buY6K6kIEhUVFAg56uv54K5JyxcbiAgICAgICAgICAgICcgIENPQ09TX01DUF9IVFRQX1RJTUVPVVRfTVMgIOm7mOiupOi2heaXtuavq+enkidcbiAgICAgICAgXS5qb2luKCdcXG4nKSArICdcXG4nXG4gICAgKTtcblxuICAgIHByb2Nlc3MuZXhpdChjb2RlKTtcbn1cblxuZnVuY3Rpb24gbWFpbigpOiB2b2lkIHtcbiAgICBjb25zdCBvcHRpb25zID0gcGFyc2VBcmdzKHByb2Nlc3MuYXJndi5zbGljZSgyKSk7XG4gICAgY29uc3QgYnJpZGdlID0gbmV3IFN0ZGlvSHR0cEJyaWRnZShvcHRpb25zKTtcbiAgICBicmlkZ2Uuc3RhcnQoKTtcbn1cblxuaWYgKHJlcXVpcmUubWFpbiA9PT0gbW9kdWxlKSB7XG4gICAgbWFpbigpO1xufVxuXG5leHBvcnQgeyBTdGRpb0h0dHBCcmlkZ2UsIEJyaWRnZU9wdGlvbnMgfTtcbiJdfQ==