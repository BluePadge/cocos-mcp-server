"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
const assert = __importStar(require("assert"));
const http = __importStar(require("http"));
const mcp_server_1 = require("../mcp-server");
class MockTools {
    getTools() {
        return [
            {
                name: 'echo',
                description: 'Echo args for test',
                inputSchema: {
                    type: 'object',
                    properties: {
                        fail: { type: 'boolean' },
                        value: { type: 'string' }
                    }
                }
            }
        ];
    }
    async execute(toolName, args) {
        if (toolName !== 'echo') {
            throw new Error(`Tool mock_${toolName} not found`);
        }
        if (args && args.fail) {
            return {
                success: false,
                error: 'mock failure'
            };
        }
        return {
            success: true,
            data: args
        };
    }
}
function postRaw(port, body, sessionId) {
    return new Promise((resolve, reject) => {
        const headers = {
            'Content-Type': 'application/json'
        };
        if (sessionId) {
            headers['MCP-Session-Id'] = sessionId;
        }
        const req = http.request({
            method: 'POST',
            host: '127.0.0.1',
            port,
            path: '/mcp',
            headers
        }, (res) => {
            let data = '';
            res.setEncoding('utf8');
            res.on('data', (chunk) => {
                data += chunk;
            });
            res.on('end', () => {
                resolve({
                    statusCode: res.statusCode || 0,
                    headers: res.headers,
                    body: data
                });
            });
        });
        req.on('error', reject);
        req.write(body);
        req.end();
    });
}
function deleteSession(port, sessionId) {
    return new Promise((resolve, reject) => {
        const headers = {};
        if (sessionId) {
            headers['MCP-Session-Id'] = sessionId;
        }
        const req = http.request({
            method: 'DELETE',
            host: '127.0.0.1',
            port,
            path: '/mcp',
            headers
        }, (res) => {
            let data = '';
            res.setEncoding('utf8');
            res.on('data', (chunk) => {
                data += chunk;
            });
            res.on('end', () => {
                resolve({
                    statusCode: res.statusCode || 0,
                    headers: res.headers,
                    body: data
                });
            });
        });
        req.on('error', reject);
        req.end();
    });
}
function parseJson(body) {
    if (!body.trim()) {
        return null;
    }
    return JSON.parse(body);
}
async function main() {
    const settings = {
        port: 0,
        autoStart: false,
        enableDebugLog: false,
        allowedOrigins: ['*'],
        maxConnections: 10
    };
    const server = new mcp_server_1.MCPServer(settings, {
        toolExecutors: {
            mock: new MockTools()
        },
        sessionIdGenerator: () => 'session-fixed'
    });
    await server.start();
    const httpServer = server.httpServer;
    const address = httpServer.address();
    const port = address.port;
    try {
        // 1. 非法 JSON => -32700
        const parseError = await postRaw(port, '{');
        assert.strictEqual(parseError.statusCode, 400);
        assert.strictEqual(parseJson(parseError.body).error.code, -32700);
        // 2. POST batch 在 V2 中不支持 => -32600
        const emptyBatch = await postRaw(port, '[]');
        assert.strictEqual(emptyBatch.statusCode, 200);
        assert.strictEqual(parseJson(emptyBatch.body).error.code, -32600);
        // initialize，确认返回 MCP-Session-Id
        const initialize = await postRaw(port, JSON.stringify({
            jsonrpc: '2.0',
            id: 1,
            method: 'initialize',
            params: { protocolVersion: '2025-11-25' }
        }));
        assert.strictEqual(initialize.statusCode, 200);
        const sessionId = initialize.headers['mcp-session-id'];
        assert.ok(sessionId, 'initialize 必须返回 MCP-Session-Id');
        // 7. 初始化后缺失 session header => HTTP 400
        const missingHeader = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', id: 2, method: 'tools/list' }));
        assert.strictEqual(missingHeader.statusCode, 400);
        // 5. 未完成 initialized 前调用 tools/list => 生命周期错误
        const notReadyList = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', id: 3, method: 'tools/list' }), sessionId);
        assert.strictEqual(notReadyList.statusCode, 200);
        assert.strictEqual(parseJson(notReadyList.body).error.code, -32600);
        // 完成 notifications/initialized
        const initializedNotification = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', method: 'notifications/initialized' }), sessionId);
        assert.strictEqual(initializedNotification.statusCode, 202);
        assert.strictEqual(initializedNotification.body, '');
        // 3. notification（单消息）=> 202 且无 body
        const progressNotification = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', method: 'notifications/progress', params: { value: 1 } }), sessionId);
        assert.strictEqual(progressNotification.statusCode, 202);
        assert.strictEqual(progressNotification.body, '');
        // 4. tools/list 返回 V2 列表（含 _meta）
        const listResult = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', id: 4, method: 'tools/list' }), sessionId);
        assert.strictEqual(listResult.statusCode, 200);
        const listBody = parseJson(listResult.body);
        assert.ok(Array.isArray(listBody.result.tools));
        assert.ok(listBody.result.tools.length > 0);
        assert.ok(listBody.result.tools[0]._meta);
        // 8. 未知方法 => -32601
        const unknownMethod = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', id: 5, method: 'unknown/method' }), sessionId);
        assert.strictEqual(unknownMethod.statusCode, 200);
        assert.strictEqual(parseJson(unknownMethod.body).error.code, -32601);
        // 9. tools/call 缺少 name => -32602
        const missingName = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', id: 6, method: 'tools/call', params: {} }), sessionId);
        assert.strictEqual(missingName.statusCode, 200);
        assert.strictEqual(parseJson(missingName.body).error.code, -32602);
        // 10. 工具业务失败 => result.isError = true + structuredContent.success=false
        const businessFailure = await postRaw(port, JSON.stringify({
            jsonrpc: '2.0',
            id: 7,
            method: 'tools/call',
            params: {
                name: 'mock_echo',
                arguments: {
                    fail: true
                }
            }
        }), sessionId);
        assert.strictEqual(businessFailure.statusCode, 200);
        const businessBody = parseJson(businessFailure.body);
        assert.strictEqual(businessBody.result.isError, true);
        assert.strictEqual(businessBody.result.structuredContent.success, false);
        assert.ok(typeof businessBody.result.structuredContent.error.code === 'string');
        // 11. get_tool_manifest 可查询工具元数据
        const manifestResult = await postRaw(port, JSON.stringify({
            jsonrpc: '2.0',
            id: 8,
            method: 'get_tool_manifest',
            params: { name: 'mock_echo' }
        }), sessionId);
        assert.strictEqual(manifestResult.statusCode, 200);
        const manifestBody = parseJson(manifestResult.body);
        assert.strictEqual(manifestBody.result.name, 'mock_echo');
        assert.ok(typeof manifestBody.result.layer === 'string');
        // 12. get_trace_by_id 可查询调用记录
        const traceId = businessBody.result.structuredContent.meta.traceId;
        const traceResult = await postRaw(port, JSON.stringify({
            jsonrpc: '2.0',
            id: 9,
            method: 'get_trace_by_id',
            params: { traceId }
        }), sessionId);
        assert.strictEqual(traceResult.statusCode, 200);
        const traceBody = parseJson(traceResult.body);
        assert.strictEqual(traceBody.result.trace.traceId, traceId);
        // 13. DELETE /mcp 关闭会话
        const deleteResult = await deleteSession(port, sessionId);
        assert.strictEqual(deleteResult.statusCode, 204);
        // 14. 会话删除后再次调用 => HTTP 400
        const afterDelete = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', id: 10, method: 'tools/list' }), sessionId);
        assert.strictEqual(afterDelete.statusCode, 400);
        console.log('mcp-protocol-compliance-test: PASS');
    }
    finally {
        server.stop();
    }
}
main().catch((error) => {
    console.error('mcp-protocol-compliance-test: FAIL');
    console.error(error);
    process.exit(1);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWNwLXByb3RvY29sLWNvbXBsaWFuY2UtdGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS90ZXN0L21jcC1wcm90b2NvbC1jb21wbGlhbmNlLXRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwrQ0FBaUM7QUFDakMsMkNBQTZCO0FBRTdCLDhDQUEwQztBQUcxQyxNQUFNLFNBQVM7SUFDSixRQUFRO1FBQ1gsT0FBTztZQUNIO2dCQUNJLElBQUksRUFBRSxNQUFNO2dCQUNaLFdBQVcsRUFBRSxvQkFBb0I7Z0JBQ2pDLFdBQVcsRUFBRTtvQkFDVCxJQUFJLEVBQUUsUUFBUTtvQkFDZCxVQUFVLEVBQUU7d0JBQ1IsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRTt3QkFDekIsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRTtxQkFDNUI7aUJBQ0o7YUFDSjtTQUNKLENBQUM7SUFDTixDQUFDO0lBRU0sS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFnQixFQUFFLElBQVM7UUFDNUMsSUFBSSxRQUFRLEtBQUssTUFBTSxFQUFFLENBQUM7WUFDdEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxhQUFhLFFBQVEsWUFBWSxDQUFDLENBQUM7UUFDdkQsQ0FBQztRQUVELElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNwQixPQUFPO2dCQUNILE9BQU8sRUFBRSxLQUFLO2dCQUNkLEtBQUssRUFBRSxjQUFjO2FBQ3hCLENBQUM7UUFDTixDQUFDO1FBRUQsT0FBTztZQUNILE9BQU8sRUFBRSxJQUFJO1lBQ2IsSUFBSSxFQUFFLElBQUk7U0FDYixDQUFDO0lBQ04sQ0FBQztDQUNKO0FBUUQsU0FBUyxPQUFPLENBQUMsSUFBWSxFQUFFLElBQVksRUFBRSxTQUFrQjtJQUMzRCxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMs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Q0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDMUQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRWpELDRCQUE0QjtRQUM1QixNQUFNLFdBQVcsR0FBRyxNQUFNLE9BQU8sQ0FDN0IsSUFBSSxFQUNKLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxDQUFDLEVBQ2hFLFNBQVMsQ0FDWixDQUFDO1FBQ0YsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRWhELE9BQU8sQ0FBQyxHQUFHLENBQUMsb0NBQW9DLENBQUMsQ0FBQztJQUN0RCxDQUFDO1lBQVMsQ0FBQztRQUNQLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNsQixDQUFDO0FBQ0wsQ0FBQztBQUVELElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO0lBQ25CLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLENBQUMsQ0FBQztJQUNwRCxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3JCLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDcEIsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBhc3NlcnQgZnJvbSAnYXNzZXJ0JztcbmltcG9ydCAqIGFzIGh0dHAgZnJvbSAnaHR0cCc7XG5pbXBvcnQgeyBBZGRyZXNzSW5mbyB9IGZyb20gJ25ldCc7XG5pbXBvcnQgeyBNQ1BTZXJ2ZXIgfSBmcm9tICcuLi9tY3Atc2VydmVyJztcbmltcG9ydCB7IE1DUFNlcnZlclNldHRpbmdzLCBUb29sRGVmaW5pdGlvbiB9IGZyb20gJy4uL3R5cGVzJztcblxuY2xhc3MgTW9ja1Rvb2xzIHtcbiAgICBwdWJsaWMgZ2V0VG9vbHMoKTogVG9vbERlZmluaXRpb25bXSB7XG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbmFtZTogJ2VjaG8nLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnRWNobyBhcmdzIGZvciB0ZXN0JyxcbiAgICAgICAgICAgICAgICBpbnB1dFNjaGVtYToge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnb2JqZWN0JyxcbiAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmFpbDogeyB0eXBlOiAnYm9vbGVhbicgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiB7IHR5cGU6ICdzdHJpbmcnIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZXhlY3V0ZSh0b29sTmFtZTogc3RyaW5nLCBhcmdzOiBhbnkpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBpZiAodG9vbE5hbWUgIT09ICdlY2hvJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUb29sIG1vY2tfJHt0b29sTmFtZX0gbm90IGZvdW5kYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXJncyAmJiBhcmdzLmZhaWwpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICAgICAgZXJyb3I6ICdtb2NrIGZhaWx1cmUnXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICBkYXRhOiBhcmdzXG4gICAgICAgIH07XG4gICAgfVxufVxuXG5pbnRlcmZhY2UgSHR0cFJlc3VsdCB7XG4gICAgc3RhdHVzQ29kZTogbnVtYmVyO1xuICAgIGhlYWRlcnM6IGh0dHAuSW5jb21pbmdIdHRwSGVhZGVycztcbiAgICBib2R5OiBzdHJpbmc7XG59XG5cbmZ1bmN0aW9uIHBvc3RSYXcocG9ydDogbnVtYmVyLCBib2R5OiBzdHJpbmcsIHNlc3Npb25JZD86IHN0cmluZyk6IFByb21pc2U8SHR0cFJlc3VsdD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKHNlc3Npb25JZCkge1xuICAgICAgICAgICAgaGVhZGVyc1snTUNQLVNlc3Npb24tSWQnXSA9IHNlc3Npb25JZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlcSA9IGh0dHAucmVxdWVzdChcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgICAgICBob3N0OiAnMTI3LjAuMC4xJyxcbiAgICAgICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgICAgIHBhdGg6ICcvbWNwJyxcbiAgICAgICAgICAgICAgICBoZWFkZXJzXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBkYXRhID0gJyc7XG4gICAgICAgICAgICAgICAgcmVzLnNldEVuY29kaW5nKCd1dGY4Jyk7XG4gICAgICAgICAgICAgICAgcmVzLm9uKCdkYXRhJywgKGNodW5rKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGEgKz0gY2h1bms7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmVzLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzQ29kZTogcmVzLnN0YXR1c0NvZGUgfHwgMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHJlcy5oZWFkZXJzLFxuICAgICAgICAgICAgICAgICAgICAgICAgYm9keTogZGF0YVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgICByZXEub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICAgICAgcmVxLndyaXRlKGJvZHkpO1xuICAgICAgICByZXEuZW5kKCk7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIGRlbGV0ZVNlc3Npb24ocG9ydDogbnVtYmVyLCBzZXNzaW9uSWQ/OiBzdHJpbmcpOiBQcm9taXNlPEh0dHBSZXN1bHQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBjb25zdCBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG4gICAgICAgIGlmIChzZXNzaW9uSWQpIHtcbiAgICAgICAgICAgIGhlYWRlcnNbJ01DUC1TZXNzaW9uLUlkJ10gPSBzZXNzaW9uSWQ7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXEgPSBodHRwLnJlcXVlc3QoXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbWV0aG9kOiAnREVMRVRFJyxcbiAgICAgICAgICAgICAgICBob3N0OiAnMTI3LjAuMC4xJyxcbiAgICAgICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgICAgIHBhdGg6ICcvbWNwJyxcbiAgICAgICAgICAgICAgICBoZWFkZXJzXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBkYXRhID0gJyc7XG4gICAgICAgICAgICAgICAgcmVzLnNldEVuY29kaW5nKCd1dGY4Jyk7XG4gICAgICAgICAgICAgICAgcmVzLm9uKCdkYXRhJywgKGNodW5rKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGEgKz0gY2h1bms7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmVzLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzQ29kZTogcmVzLnN0YXR1c0NvZGUgfHwgMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHJlcy5oZWFkZXJzLFxuICAgICAgICAgICAgICAgICAgICAgICAgYm9keTogZGF0YVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgICByZXEub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICAgICAgcmVxLmVuZCgpO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBwYXJzZUpzb24oYm9keTogc3RyaW5nKTogYW55IHtcbiAgICBpZiAoIWJvZHkudHJpbSgpKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gSlNPTi5wYXJzZShib2R5KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbWFpbigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzZXR0aW5nczogTUNQU2VydmVyU2V0dGluZ3MgPSB7XG4gICAgICAgIHBvcnQ6IDAsXG4gICAgICAgIGF1dG9TdGFydDogZmFsc2UsXG4gICAgICAgIGVuYWJsZURlYnVnTG9nOiBmYWxzZSxcbiAgICAgICAgYWxsb3dlZE9yaWdpbnM6IFsnKiddLFxuICAgICAgICBtYXhDb25uZWN0aW9uczogMTBcbiAgICB9O1xuXG4gICAgY29uc3Qgc2VydmVyID0gbmV3IE1DUFNlcnZlcihzZXR0aW5ncywge1xuICAgICAgICB0b29sRXhlY3V0b3JzOiB7XG4gICAgICAgICAgICBtb2NrOiBuZXcgTW9ja1Rvb2xzKClcbiAgICAgICAgfSxcbiAgICAgICAgc2Vzc2lvbklkR2VuZXJhdG9yOiAoKSA9PiAnc2Vzc2lvbi1maXhlZCdcbiAgICB9KTtcblxuICAgIGF3YWl0IHNlcnZlci5zdGFydCgpO1xuXG4gICAgY29uc3QgaHR0cFNlcnZlcjogaHR0cC5TZXJ2ZXIgPSAoc2VydmVyIGFzIGFueSkuaHR0cFNlcnZlcjtcbiAgICBjb25zdCBhZGRyZXNzID0gaHR0cFNlcnZlci5hZGRyZXNzKCkgYXMgQWRkcmVzc0luZm87XG4gICAgY29uc3QgcG9ydCA9IGFkZHJlc3MucG9ydDtcblxuICAgIHRyeSB7XG4gICAgICAgIC8vIDEuIOmdnuazlSBKU09OID0+IC0zMjcwMFxuICAgICAgICBjb25zdCBwYXJzZUVycm9yID0gYXdhaXQgcG9zdFJhdyhwb3J0LCAneycpO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwocGFyc2VFcnJvci5zdGF0dXNDb2RlLCA0MDApO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwocGFyc2VKc29uKHBhcnNlRXJyb3IuYm9keSkuZXJyb3IuY29kZSwgLTMyNzAwKTtcblxuICAgICAgICAvLyAyLiBQT1NUIGJhdGNoIOWcqCBWMiDkuK3kuI3mlK/mjIEgPT4gLTMyNjAwXG4gICAgICAgIGNvbnN0IGVtcHR5QmF0Y2ggPSBhd2FpdCBwb3N0UmF3KHBvcnQsICdbXScpO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwoZW1wdHlCYXRjaC5zdGF0dXNDb2RlLCAyMDApO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwocGFyc2VKc29uKGVtcHR5QmF0Y2guYm9keSkuZXJyb3IuY29kZSwgLTMyNjAwKTtcblxuICAgICAgICAvLyBpbml0aWFsaXpl77yM56Gu6K6k6L+U5ZueIE1DUC1TZXNzaW9uLUlkXG4gICAgICAgIGNvbnN0IGluaXRpYWxpemUgPSBhd2FpdCBwb3N0UmF3KFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgICAgICAgICAgICBpZDogMSxcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdpbml0aWFsaXplJyxcbiAgICAgICAgICAgICAgICBwYXJhbXM6IHsgcHJvdG9jb2xWZXJzaW9uOiAnMjAyNS0xMS0yNScgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGluaXRpYWxpemUuc3RhdHVzQ29kZSwgMjAwKTtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbklkID0gaW5pdGlhbGl6ZS5oZWFkZXJzWydtY3Atc2Vzc2lvbi1pZCddIGFzIHN0cmluZztcbiAgICAgICAgYXNzZXJ0Lm9rKHNlc3Npb25JZCwgJ2luaXRpYWxpemUg5b+F6aG76L+U5ZueIE1DUC1TZXNzaW9uLUlkJyk7XG5cbiAgICAgICAgLy8gNy4g5Yid5aeL5YyW5ZCO57y65aSxIHNlc3Npb24gaGVhZGVyID0+IEhUVFAgNDAwXG4gICAgICAgIGNvbnN0IG1pc3NpbmdIZWFkZXIgPSBhd2FpdCBwb3N0UmF3KFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHsganNvbnJwYzogJzIuMCcsIGlkOiAyLCBtZXRob2Q6ICd0b29scy9saXN0JyB9KVxuICAgICAgICApO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwobWlzc2luZ0hlYWRlci5zdGF0dXNDb2RlLCA0MDApO1xuXG4gICAgICAgIC8vIDUuIOacquWujOaIkCBpbml0aWFsaXplZCDliY3osIPnlKggdG9vbHMvbGlzdCA9PiDnlJ/lkb3lkajmnJ/plJnor69cbiAgICAgICAgY29uc3Qgbm90UmVhZHlMaXN0ID0gYXdhaXQgcG9zdFJhdyhcbiAgICAgICAgICAgIHBvcnQsXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7IGpzb25ycGM6ICcyLjAnLCBpZDogMywgbWV0aG9kOiAndG9vbHMvbGlzdCcgfSksXG4gICAgICAgICAgICBzZXNzaW9uSWRcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKG5vdFJlYWR5TGlzdC5zdGF0dXNDb2RlLCAyMDApO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwocGFyc2VKc29uKG5vdFJlYWR5TGlzdC5ib2R5KS5lcnJvci5jb2RlLCAtMzI2MDApO1xuXG4gICAgICAgIC8vIOWujOaIkCBub3RpZmljYXRpb25zL2luaXRpYWxpemVkXG4gICAgICAgIGNvbnN0IGluaXRpYWxpemVkTm90aWZpY2F0aW9uID0gYXdhaXQgcG9zdFJhdyhcbiAgICAgICAgICAgIHBvcnQsXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7IGpzb25ycGM6ICcyLjAnLCBtZXRob2Q6ICdub3RpZmljYXRpb25zL2luaXRpYWxpemVkJyB9KSxcbiAgICAgICAgICAgIHNlc3Npb25JZFxuICAgICAgICApO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwoaW5pdGlhbGl6ZWROb3RpZmljYXRpb24uc3RhdHVzQ29kZSwgMjAyKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGluaXRpYWxpemVkTm90aWZpY2F0aW9uLmJvZHksICcnKTtcblxuICAgICAgICAvLyAzLiBub3RpZmljYXRpb27vvIjljZXmtojmga/vvIk9PiAyMDIg5LiU5pegIGJvZHlcbiAgICAgICAgY29uc3QgcHJvZ3Jlc3NOb3RpZmljYXRpb24gPSBhd2FpdCBwb3N0UmF3KFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHsganNvbnJwYzogJzIuMCcsIG1ldGhvZDogJ25vdGlmaWNhdGlvbnMvcHJvZ3Jlc3MnLCBwYXJhbXM6IHsgdmFsdWU6IDEgfSB9KSxcbiAgICAgICAgICAgIHNlc3Npb25JZFxuICAgICAgICApO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwocHJvZ3Jlc3NOb3RpZmljYXRpb24uc3RhdHVzQ29kZSwgMjAyKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHByb2dyZXNzTm90aWZpY2F0aW9uLmJvZHksICcnKTtcblxuICAgICAgICAvLyA0LiB0b29scy9saXN0IOi/lOWbniBWMiDliJfooajvvIjlkKsgX21ldGHvvIlcbiAgICAgICAgY29uc3QgbGlzdFJlc3VsdCA9IGF3YWl0IHBvc3RSYXcoXG4gICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoeyBqc29ucnBjOiAnMi4wJywgaWQ6IDQsIG1ldGhvZDogJ3Rvb2xzL2xpc3QnIH0pLFxuICAgICAgICAgICAgc2Vzc2lvbklkXG4gICAgICAgICk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChsaXN0UmVzdWx0LnN0YXR1c0NvZGUsIDIwMCk7XG4gICAgICAgIGNvbnN0IGxpc3RCb2R5ID0gcGFyc2VKc29uKGxpc3RSZXN1bHQuYm9keSk7XG4gICAgICAgIGFzc2VydC5vayhBcnJheS5pc0FycmF5KGxpc3RCb2R5LnJlc3VsdC50b29scykpO1xuICAgICAgICBhc3NlcnQub2sobGlzdEJvZHkucmVzdWx0LnRvb2xzLmxlbmd0aCA+IDApO1xuICAgICAgICBhc3NlcnQub2sobGlzdEJvZHkucmVzdWx0LnRvb2xzWzBdLl9tZXRhKTtcblxuICAgICAgICAvLyA4LiDmnKrnn6Xmlrnms5UgPT4gLTMyNjAxXG4gICAgICAgIGNvbnN0IHVua25vd25NZXRob2QgPSBhd2FpdCBwb3N0UmF3KFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHsganNvbnJwYzogJzIuMCcsIGlkOiA1LCBtZXRob2Q6ICd1bmtub3duL21ldGhvZCcgfSksXG4gICAgICAgICAgICBzZXNzaW9uSWRcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHVua25vd25NZXRob2Quc3RhdHVzQ29kZSwgMjAwKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHBhcnNlSnNvbih1bmtub3duTWV0aG9kLmJvZHkpLmVycm9yLmNvZGUsIC0zMjYwMSk7XG5cbiAgICAgICAgLy8gOS4gdG9vbHMvY2FsbCDnvLrlsJEgbmFtZSA9PiAtMzI2MDJcbiAgICAgICAgY29uc3QgbWlzc2luZ05hbWUgPSBhd2FpdCBwb3N0UmF3KFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHsganNvbnJwYzogJzIuMCcsIGlkOiA2LCBtZXRob2Q6ICd0b29scy9jYWxsJywgcGFyYW1zOiB7fSB9KSxcbiAgICAgICAgICAgIHNlc3Npb25JZFxuICAgICAgICApO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwobWlzc2luZ05hbWUuc3RhdHVzQ29kZSwgMjAwKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHBhcnNlSnNvbihtaXNzaW5nTmFtZS5ib2R5KS5lcnJvci5jb2RlLCAtMzI2MDIpO1xuXG4gICAgICAgIC8vIDEwLiDlt6XlhbfkuJrliqHlpLHotKUgPT4gcmVzdWx0LmlzRXJyb3IgPSB0cnVlICsgc3RydWN0dXJlZENvbnRlbnQuc3VjY2Vzcz1mYWxzZVxuICAgICAgICBjb25zdCBidXNpbmVzc0ZhaWx1cmUgPSBhd2FpdCBwb3N0UmF3KFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgICAgICAgICAgICBpZDogNyxcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICd0b29scy9jYWxsJyxcbiAgICAgICAgICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ21vY2tfZWNobycsXG4gICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50czoge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmFpbDogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBzZXNzaW9uSWRcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGJ1c2luZXNzRmFpbHVyZS5zdGF0dXNDb2RlLCAyMDApO1xuICAgICAgICBjb25zdCBidXNpbmVzc0JvZHkgPSBwYXJzZUpzb24oYnVzaW5lc3NGYWlsdXJlLmJvZHkpO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwoYnVzaW5lc3NCb2R5LnJlc3VsdC5pc0Vycm9yLCB0cnVlKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGJ1c2luZXNzQm9keS5yZXN1bHQuc3RydWN0dXJlZENvbnRlbnQuc3VjY2VzcywgZmFsc2UpO1xuICAgICAgICBhc3NlcnQub2sodHlwZW9mIGJ1c2luZXNzQm9keS5yZXN1bHQuc3RydWN0dXJlZENvbnRlbnQuZXJyb3IuY29kZSA9PT0gJ3N0cmluZycpO1xuXG4gICAgICAgIC8vIDExLiBnZXRfdG9vbF9tYW5pZmVzdCDlj6/mn6Xor6Llt6XlhbflhYPmlbDmja5cbiAgICAgICAgY29uc3QgbWFuaWZlc3RSZXN1bHQgPSBhd2FpdCBwb3N0UmF3KFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgICAgICAgICAgICBpZDogOCxcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdnZXRfdG9vbF9tYW5pZmVzdCcsXG4gICAgICAgICAgICAgICAgcGFyYW1zOiB7IG5hbWU6ICdtb2NrX2VjaG8nIH1cbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgc2Vzc2lvbklkXG4gICAgICAgICk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChtYW5pZmVzdFJlc3VsdC5zdGF0dXNDb2RlLCAyMDApO1xuICAgICAgICBjb25zdCBtYW5pZmVzdEJvZHkgPSBwYXJzZUpzb24obWFuaWZlc3RSZXN1bHQuYm9keSk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChtYW5pZmVzdEJvZHkucmVzdWx0Lm5hbWUsICdtb2NrX2VjaG8nKTtcbiAgICAgICAgYXNzZXJ0Lm9rKHR5cGVvZiBtYW5pZmVzdEJvZHkucmVzdWx0LmxheWVyID09PSAnc3RyaW5nJyk7XG5cbiAgICAgICAgLy8gMTIuIGdldF90cmFjZV9ieV9pZCDlj6/mn6Xor6LosIPnlKjorrDlvZVcbiAgICAgICAgY29uc3QgdHJhY2VJZCA9IGJ1c2luZXNzQm9keS5yZXN1bHQuc3RydWN0dXJlZENvbnRlbnQubWV0YS50cmFjZUlkO1xuICAgICAgICBjb25zdCB0cmFjZVJlc3VsdCA9IGF3YWl0IHBvc3RSYXcoXG4gICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgIGlkOiA5LFxuICAgICAgICAgICAgICAgIG1ldGhvZDogJ2dldF90cmFjZV9ieV9pZCcsXG4gICAgICAgICAgICAgICAgcGFyYW1zOiB7IHRyYWNlSWQgfVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBzZXNzaW9uSWRcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHRyYWNlUmVzdWx0LnN0YXR1c0NvZGUsIDIwMCk7XG4gICAgICAgIGNvbnN0IHRyYWNlQm9keSA9IHBhcnNlSnNvbih0cmFjZVJlc3VsdC5ib2R5KTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHRyYWNlQm9keS5yZXN1bHQudHJhY2UudHJhY2VJZCwgdHJhY2VJZCk7XG5cbiAgICAgICAgLy8gMTMuIERFTEVURSAvbWNwIOWFs+mXreS8muivnVxuICAgICAgICBjb25zdCBkZWxldGVSZXN1bHQgPSBhd2FpdCBkZWxldGVTZXNzaW9uKHBvcnQsIHNlc3Npb25JZCk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChkZWxldGVSZXN1bHQuc3RhdHVzQ29kZSwgMjA0KTtcblxuICAgICAgICAvLyAxNC4g5Lya6K+d5Yig6Zmk5ZCO5YaN5qyh6LCD55SoID0+IEhUVFAgNDAwXG4gICAgICAgIGNvbnN0IGFmdGVyRGVsZXRlID0gYXdhaXQgcG9zdFJhdyhcbiAgICAgICAgICAgIHBvcnQsXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7IGpzb25ycGM6ICcyLjAnLCBpZDogMTAsIG1ldGhvZDogJ3Rvb2xzL2xpc3QnIH0pLFxuICAgICAgICAgICAgc2Vzc2lvbklkXG4gICAgICAgICk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChhZnRlckRlbGV0ZS5zdGF0dXNDb2RlLCA0MDApO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKCdtY3AtcHJvdG9jb2wtY29tcGxpYW5jZS10ZXN0OiBQQVNTJyk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgICAgc2VydmVyLnN0b3AoKTtcbiAgICB9XG59XG5cbm1haW4oKS5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICBjb25zb2xlLmVycm9yKCdtY3AtcHJvdG9jb2wtY29tcGxpYW5jZS10ZXN0OiBGQUlMJyk7XG4gICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgcHJvY2Vzcy5leGl0KDEpO1xufSk7XG4iXX0=