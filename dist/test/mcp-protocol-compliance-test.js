"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
const assert = __importStar(require("assert"));
const http = __importStar(require("http"));
const mcp_server_1 = require("../mcp-server");
const official_tools_1 = require("../next/tools/official-tools");
const tool_registry_1 = require("../next/protocol/tool-registry");
const router_1 = require("../next/protocol/router");
function createMatrix(availableKeys) {
    const byKey = {};
    for (const key of availableKeys) {
        const firstDot = key.indexOf('.');
        byKey[key] = {
            key,
            channel: key.slice(0, firstDot),
            method: key.slice(firstDot + 1),
            layer: 'official',
            readonly: true,
            description: key,
            available: true,
            checkedAt: new Date().toISOString(),
            detail: 'ok'
        };
    }
    return {
        generatedAt: new Date().toISOString(),
        byKey,
        summary: {
            total: availableKeys.length,
            available: availableKeys.length,
            unavailable: 0,
            byLayer: {
                official: {
                    total: availableKeys.length,
                    available: availableKeys.length
                },
                extended: {
                    total: 0,
                    available: 0
                },
                experimental: {
                    total: 0,
                    available: 0
                }
            }
        }
    };
}
function postRaw(port, body, sessionId) {
    return new Promise((resolve, reject) => {
        const headers = {
            'Content-Type': 'application/json'
        };
        if (sessionId) {
            headers['MCP-Session-Id'] = sessionId;
        }
        const req = http.request({
            method: 'POST',
            host: '127.0.0.1',
            port,
            path: '/mcp',
            headers
        }, (res) => {
            let data = '';
            res.setEncoding('utf8');
            res.on('data', (chunk) => {
                data += chunk;
            });
            res.on('end', () => {
                resolve({
                    statusCode: res.statusCode || 0,
                    headers: res.headers,
                    body: data
                });
            });
        });
        req.on('error', reject);
        req.write(body);
        req.end();
    });
}
function deleteSession(port, sessionId) {
    return new Promise((resolve, reject) => {
        const headers = {};
        if (sessionId) {
            headers['MCP-Session-Id'] = sessionId;
        }
        const req = http.request({
            method: 'DELETE',
            host: '127.0.0.1',
            port,
            path: '/mcp',
            headers
        }, (res) => {
            let data = '';
            res.setEncoding('utf8');
            res.on('data', (chunk) => {
                data += chunk;
            });
            res.on('end', () => {
                resolve({
                    statusCode: res.statusCode || 0,
                    headers: res.headers,
                    body: data
                });
            });
        });
        req.on('error', reject);
        req.end();
    });
}
function parseJson(body) {
    if (!body.trim()) {
        return null;
    }
    return JSON.parse(body);
}
async function main() {
    const settings = {
        port: 0,
        autoStart: false,
        enableDebugLog: false,
        allowedOrigins: ['*'],
        maxConnections: 10
    };
    const requester = async (channel, method, ...args) => {
        if (channel === 'asset-db' && method === 'query-assets') {
            return [{ uuid: 'asset-1', url: 'db://assets/a.prefab' }];
        }
        if (channel === 'asset-db' && method === 'query-asset-info') {
            const query = args[0];
            if (query === 'bad://missing') {
                throw new Error('mock failure');
            }
            return { uuid: 'asset-1', url: String(query) };
        }
        throw new Error(`Unexpected request: ${channel}.${method}`);
    };
    const server = new mcp_server_1.MCPServer(settings, {
        sessionIdGenerator: () => 'session-fixed',
        nextRuntimeFactory: async () => {
            const tools = (0, official_tools_1.createOfficialTools)(requester);
            const matrix = createMatrix([
                'asset-db.query-assets',
                'asset-db.query-asset-info'
            ]);
            const registry = new tool_registry_1.NextToolRegistry(tools, matrix);
            const router = new router_1.NextMcpRouter(registry);
            return { registry, router };
        }
    });
    await server.start();
    const httpServer = server.httpServer;
    const address = httpServer.address();
    const port = address.port;
    try {
        // 1. 非法 JSON => -32700
        const parseError = await postRaw(port, '{');
        assert.strictEqual(parseError.statusCode, 400);
        assert.strictEqual(parseJson(parseError.body).error.code, -32700);
        // 2. POST batch 不支持 => -32600
        const emptyBatch = await postRaw(port, '[]');
        assert.strictEqual(emptyBatch.statusCode, 200);
        assert.strictEqual(parseJson(emptyBatch.body).error.code, -32600);
        // initialize 并提取会话
        const initialize = await postRaw(port, JSON.stringify({
            jsonrpc: '2.0',
            id: 1,
            method: 'initialize',
            params: { protocolVersion: '2025-11-25' }
        }));
        assert.strictEqual(initialize.statusCode, 200);
        const sessionId = initialize.headers['mcp-session-id'];
        assert.ok(sessionId, 'initialize 必须返回 MCP-Session-Id');
        // 缺失会话头 => HTTP 400
        const missingHeader = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', id: 2, method: 'tools/list' }));
        assert.strictEqual(missingHeader.statusCode, 400);
        // 未 ready 前调用 tools/list => -32600
        const notReadyList = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', id: 3, method: 'tools/list' }), sessionId);
        assert.strictEqual(notReadyList.statusCode, 200);
        assert.strictEqual(parseJson(notReadyList.body).error.code, -32600);
        // 完成 notifications/initialized
        const initializedNotification = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', method: 'notifications/initialized' }), sessionId);
        assert.strictEqual(initializedNotification.statusCode, 202);
        assert.strictEqual(initializedNotification.body, '');
        // 普通 notification => 202 且无 body
        const progressNotification = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', method: 'notifications/progress', params: { value: 1 } }), sessionId);
        assert.strictEqual(progressNotification.statusCode, 202);
        assert.strictEqual(progressNotification.body, '');
        // tools/list 返回 next 工具并带 _meta
        const listResult = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', id: 4, method: 'tools/list' }), sessionId);
        assert.strictEqual(listResult.statusCode, 200);
        const listBody = parseJson(listResult.body);
        assert.ok(Array.isArray(listBody.result.tools));
        assert.ok(listBody.result.tools.length > 0);
        assert.ok(listBody.result.tools[0]._meta);
        // 未知方法 => -32601
        const unknownMethod = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', id: 5, method: 'unknown/method' }), sessionId);
        assert.strictEqual(unknownMethod.statusCode, 200);
        assert.strictEqual(parseJson(unknownMethod.body).error.code, -32601);
        // tools/call 缺少 name => -32602
        const missingName = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', id: 6, method: 'tools/call', params: {} }), sessionId);
        assert.strictEqual(missingName.statusCode, 200);
        assert.strictEqual(parseJson(missingName.body).error.code, -32602);
        // 业务失败 => result.isError = true
        const businessFailure = await postRaw(port, JSON.stringify({
            jsonrpc: '2.0',
            id: 7,
            method: 'tools/call',
            params: {
                name: 'asset_query_asset_info',
                arguments: {
                    urlOrUuid: 'bad://missing'
                }
            }
        }), sessionId);
        assert.strictEqual(businessFailure.statusCode, 200);
        const businessBody = parseJson(businessFailure.body);
        assert.strictEqual(businessBody.result.isError, true);
        assert.strictEqual(businessBody.result.structuredContent.success, false);
        assert.ok(typeof businessBody.result.structuredContent.error.code === 'string');
        // get_tool_manifest
        const manifestResult = await postRaw(port, JSON.stringify({
            jsonrpc: '2.0',
            id: 8,
            method: 'get_tool_manifest',
            params: { name: 'asset_query_asset_info' }
        }), sessionId);
        assert.strictEqual(manifestResult.statusCode, 200);
        const manifestBody = parseJson(manifestResult.body);
        assert.strictEqual(manifestBody.result.name, 'asset_query_asset_info');
        assert.strictEqual(manifestBody.result._meta.layer, 'official');
        // get_trace_by_id
        const traceId = businessBody.result.structuredContent.meta.traceId;
        const traceResult = await postRaw(port, JSON.stringify({
            jsonrpc: '2.0',
            id: 9,
            method: 'get_trace_by_id',
            params: { traceId }
        }), sessionId);
        assert.strictEqual(traceResult.statusCode, 200);
        const traceBody = parseJson(traceResult.body);
        assert.strictEqual(traceBody.result.trace.traceId, traceId);
        assert.strictEqual(traceBody.result.trace.tool, 'asset_query_asset_info');
        // DELETE /mcp
        const deleteResult = await deleteSession(port, sessionId);
        assert.strictEqual(deleteResult.statusCode, 204);
        // 删除会话后请求 => HTTP 400
        const afterDelete = await postRaw(port, JSON.stringify({ jsonrpc: '2.0', id: 10, method: 'tools/list' }), sessionId);
        assert.strictEqual(afterDelete.statusCode, 400);
        console.log('mcp-protocol-compliance-test: PASS');
    }
    finally {
        server.stop();
    }
}
main().catch((error) => {
    console.error('mcp-protocol-compliance-test: FAIL');
    console.error(error);
    process.exit(1);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWNwLXByb3RvY29sLWNvbXBsaWFuY2UtdGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS90ZXN0L21jcC1wcm90b2NvbC1jb21wbGlhbmNlLXRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwrQ0FBaUM7QUFDakMsMkNBQTZCO0FBRTdCLDhDQUEwQztBQUcxQyxpRUFBbUU7QUFDbkUsa0VBQWtFO0FBQ2xFLG9EQUF3RDtBQVF4RCxTQUFTLFlBQVksQ0FBQyxhQUF1QjtJQUN6QyxNQUFNLEtBQUssR0FBOEIsRUFBRSxDQUFDO0lBQzVDLEtBQUssTUFBTSxHQUFHLElBQUksYUFBYSxFQUFFLENBQUM7UUFDOUIsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUc7WUFDVCxHQUFHO1lBQ0gsT0FBTyxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQztZQUMvQixNQUFNLEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO1lBQy9CLEtBQUssRUFBRSxVQUFVO1lBQ2pCLFFBQVEsRUFBRSxJQUFJO1lBQ2QsV0FBVyxFQUFFLEdBQUc7WUFDaEIsU0FBUyxFQUFFLElBQUk7WUFDZixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7WUFDbkMsTUFBTSxFQUFFLElBQUk7U0FDZixDQUFDO0lBQ04sQ0FBQztJQUVELE9BQU87UUFDSCxXQUFXLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7UUFDckMsS0FBSztRQUNMLE9BQU8sRUFBRTtZQUNMLEtBQUssRUFBRSxhQUFhLENBQUMsTUFBTTtZQUMzQixTQUFTLEVBQUUsYUFBYSxDQUFDLE1BQU07WUFDL0IsV0FBVyxFQUFFLENBQUM7WUFDZCxPQUFPLEVBQUU7Z0JBQ0wsUUFBUSxFQUFFO29CQUNOLEtBQUssRUFBRSxhQUFhLENBQUMsTUFBTTtvQkFDM0IsU0FBUyxFQUFFLGFBQWEsQ0FBQyxNQUFNO2lCQUNsQztnQkFDRCxRQUFRLEVBQUU7b0JBQ04sS0FBSyxFQUFFLENBQUM7b0JBQ1IsU0FBUyxFQUFFLENBQUM7aUJBQ2Y7Z0JBQ0QsWUFBWSxFQUFFO29CQUNWLEtBQUssRUFBRSxDQUFDO29CQUNSLFNBQVMsRUFBRSxDQUFDO2lCQUNmO2FBQ0o7U0FDSjtLQUNKLENBQUM7QUFDTixDQUFDO0FBRUQsU0FBUyxPQUFPLENBQUMsSUFBWSxFQUFFLElBQVksRUFBRSxTQUFrQjtJQUMzRCxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1FBQ25DLE1BQU0sT0FBTyxHQUEyQjtZQUNwQyxjQUFjLEVBQUUsa0JBQWtCO1NBQ3JDLENBQUM7UUFFRixJQUFJLFNBQVMsRUFBRSxDQUFDO1lBQ1osT0FBTyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsU0FBUyxDQUFDO1FBQzFDLENBQUM7UUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUNwQjtZQUNJLE1BQU0sRUFBRSxNQUFNO1lBQ2QsSUFBSSxFQUFFLFdBQVc7WUFDakIsSUFBSTtZQUNKLElBQUksRUFBRSxNQUFNO1lBQ1osT0FBTztTQUNWLEVBQ0QsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNKLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUNkLEdBQUcsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDeEIsR0FBRyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtnQkFDckIsSUFBSSxJQUFJLEtBQUssQ0FBQztZQUNsQixDQUFDLENBQUMsQ0FBQztZQUNILEdBQUcsQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRTtnQkFDZixPQUFPLENBQUM7b0JBQ0osVUFBVSxFQUFFLEdBQUcsQ0FBQyxVQUFVLElBQUksQ0FBQztvQkFDL0IsT0FBTyxFQUFFLEdBQUcsQ0FBQyxPQUFPO29CQUNwQixJQUFJLEVBQUUsSUFBSTtpQkFDYixDQUFDLENBQUM7WUFDUCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FDSixDQUFDO1FBRUYsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDeEIsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoQixHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDZCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxJQUFZLEVBQUUsU0FBa0I7SUFDbkQsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUNuQyxNQUFNLE9BQU8sR0FBMkIsRUFBRSxDQUFDO1FBQzNDLElBQUksU0FBUyxFQUFFLENBQUM7WUFDWixPQUFPLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxTQUFTLENBQUM7UUFDMUMsQ0FBQztRQUVELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQ3BCO1lBQ0ksTUFBTSxFQUFFLFFBQVE7WUFDaEIsSUFBSSxFQUFFLFdBQVc7WUFDakIsSUFBSTtZQUNKLElBQUksRUFBRSxNQUFNO1lBQ1osT0FBTztTQUNWLEVBQ0QsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNKLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUNkLEdBQUcsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDeEIsR0FBRyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtnQkFDckIsSUFBSSxJQUFJLEtBQUssQ0FBQztZQUNsQixDQUFDLENBQUMsQ0FBQztZQUNILEdBQUcsQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRTtnQkFDZixPQUFPLENBQUM7b0JBQ0osVUFBVSxFQUFFLEdBQUcsQ0FBQyxVQUFVLElBQUksQ0FBQztvQkFDL0IsT0FBTyxFQUFFLEdBQUcsQ0FBQyxPQUFPO29CQUNwQixJQUFJLEVBQUUsSUFBSTtpQkFDYixDQUFDLENBQUM7WUFDUCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FDSixDQUFDO1FBRUYsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDeEIsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ2QsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsU0FBUyxTQUFTLENBQUMsSUFBWTtJQUMzQixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7UUFDZixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBQ0QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzVCLENBQUM7QUFFRCxLQUFLLFVBQVUsSUFBSTtJQUNmLE1BQU0sUUFBUSxHQUFzQjtRQUNoQyxJQUFJLEVBQUUsQ0FBQztRQUNQLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLGNBQWMsRUFBRSxLQUFLO1FBQ3JCLGNBQWMsRUFBRSxDQUFDLEdBQUcsQ0FBQztRQUNyQixjQUFjLEVBQUUsRUFBRTtLQUNyQixDQUFDO0lBRUYsTUFBTSxTQUFTLEdBQUcsS0FBSyxFQUFFLE9BQWUsRUFBRSxNQUFjLEVBQUUsR0FBRyxJQUFXLEVBQWdCLEVBQUU7UUFDdEYsSUFBSSxPQUFPLEtBQUssVUFBVSxJQUFJLE1BQU0sS0FBSyxjQUFjLEVBQUUsQ0FBQztZQUN0RCxPQUFPLENBQUMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxzQkFBc0IsRUFBRSxDQUFDLENBQUM7UUFDOUQsQ0FBQztRQUNELElBQUksT0FBTyxLQUFLLFVBQVUsSUFBSSxNQUFNLEtBQUssa0JBQWtCLEVBQUUsQ0FBQztZQUMxRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEIsSUFBSSxLQUFLLEtBQUssZUFBZSxFQUFFLENBQUM7Z0JBQzVCLE1BQU0sSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDcEMsQ0FBQztZQUNELE9BQU8sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUNuRCxDQUFDO1FBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsT0FBTyxJQUFJLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDaEUsQ0FBQyxDQUFDO0lBRUYsTUFBTSxNQUFNLEdBQUcsSUFBSSxzQkFBUyxDQUFDLFFBQVEsRUFBRTtRQUNuQyxrQkFBa0IsRUFBRSxHQUFHLEVBQUUsQ0FBQyxlQUFlO1FBQ3pDLGtCQUFrQixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzNCLE1BQU0sS0FBSyxHQUFHLElBQUEsb0NBQW1CLEVBQUMsU0FBUyxDQUFDLENBQUM7WUFDN0MsTUFBTSxNQUFNLEdBQUcsWUFBWSxDQUFDO2dCQUN4Qix1QkFBdUI7Z0JBQ3ZCLDJCQUEyQjthQUM5QixDQUFDLENBQUM7WUFDSCxNQUFNLFFBQVEsR0FBRyxJQUFJLGdDQUFnQixDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztZQUNyRCxNQUFNLE1BQU0sR0FBRyxJQUFJLHNCQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDM0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsQ0FBQztRQUNoQyxDQUFDO0tBQ0osQ0FBQyxDQUFDO0lBRUgsTUFBTSxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7SUFFckIsTUFBTSxVQUFVLEdBQWlCLE1BQWMsQ0FBQyxVQUFVLENBQUM7SUFDM0QsTUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLE9BQU8sRUFBaUIsQ0FBQztJQUNwRCxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDO0lBRTFCLElBQUksQ0FBQztRQUNELHVCQUF1QjtRQUN2QixNQUFNLFVBQVUsR0FBRyxNQUFNLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDNUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQy9DLE1BQU0sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFbEUsOEJBQThCO1FBQzlCLE1BQU0sVUFBVSxHQUFHLE1BQU0sT0FBTyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM3QyxNQUFNLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDL0MsTUFBTSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVsRSxtQkFBbUI7UUFDbkIsTUFBTSxVQUFVLEdBQUcsTUFBTSxPQUFPLENBQzVCLElBQUksRUFDSixJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ1gsT0FBTyxFQUFFLEtBQUs7WUFDZCxFQUFFLEVBQUUsQ0FBQztZQUNMLE1BQU0sRUFBRSxZQUFZO1lBQ3BCLE1BQU0sRUFBRSxFQUFFLGVBQWUsRUFBRSxZQUFZLEVBQUU7U0FDNUMsQ0FBQyxDQUNMLENBQUM7UUFDRixNQUFNLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDL0MsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBVyxDQUFDO1FBQ2pFLE1BQU0sQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLGdDQUFnQyxDQUFDLENBQUM7UUFFdkQsb0JBQW9CO1FBQ3BCLE1BQU0sYUFBYSxHQUFHLE1BQU0sT0FBTyxDQUMvQixJQUFJLEVBQ0osSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FDbEUsQ0FBQztRQUNGLE1BQU0sQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUVsRCxtQ0FBbUM7UUFDbkMsTUFBTSxZQUFZLEdBQUcsTUFBTSxPQUFPLENBQzlCLElBQUksRUFDSixJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsQ0FBQyxFQUMvRCxTQUFTLENBQ1osQ0FBQztRQUNGLE1BQU0sQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNqRCxNQUFNLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXBFLCtCQUErQjtRQUMvQixNQUFNLHVCQUF1QixHQUFHLE1BQU0sT0FBTyxDQUN6QyxJQUFJLEVBQ0osSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLDJCQUEyQixFQUFFLENBQUMsRUFDdkUsU0FBUyxDQUNaLENBQUM7UUFDRixNQUFNLENBQUMsV0FBVyxDQUFDLHVCQUF1QixDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUM1RCxNQUFNLENBQUMsV0FBVyxDQUFDLHVCQUF1QixDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVyRCxpQ0FBaUM7UUFDakMsTUFBTSxvQkFBb0IsR0FBRyxNQUFNLE9BQU8sQ0FDdEMsSUFBSSxFQUNKLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUMxRixTQUFTLENBQ1osQ0FBQztRQUNGLE1BQU0sQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3pELE1BQU0sQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWxELGdDQUFnQztRQUNoQyxNQUFNLFVBQVUsR0FBRyxNQUFNLE9BQU8sQ0FDNUIsSUFBSSxFQUNKLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxDQUFDLEVBQy9ELFNBQVMsQ0FDWixDQUFDO1FBQ0YsTUFBTSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQy9DLE1BQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNoRCxNQUFNLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztRQUM1QyxNQUFNLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTFDLGlCQUFpQjtRQUNqQixNQUFNLGFBQWEsR0FBRyxNQUFNLE9BQU8sQ0FDL0IsSUFBSSxFQUNKLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLGdCQUFnQixFQUFFLENBQUMsRUFDbkUsU0FBUyxDQUNaLENBQUM7UUFDRixNQUFNLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDbEQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVyRSwrQkFBK0I7UUFDL0IsTUFBTSxXQUFXLEdBQUcsTUFBTSxPQUFPLENBQzdCLElBQUksRUFDSixJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQzNFLFNBQVMsQ0FDWixDQUFDO1FBQ0YsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFbkUsZ0NBQWdDO1FBQ2hDLE1BQU0sZUFBZSxHQUFHLE1BQU0sT0FBTyxDQUNqQyxJQUFJLEVBQ0osSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUNYLE9BQU8sRUFBRSxLQUFLO1lBQ2QsRUFBRSxFQUFFLENBQUM7WUFDTCxNQUFNLEVBQUUsWUFBWTtZQUNwQixNQUFNLEVBQUU7Z0JBQ0osSUFBSSxFQUFFLHdCQUF3QjtnQkFDOUIsU0FBUyxFQUFFO29CQUNQLFNBQVMsRUFBRSxlQUFlO2lCQUM3QjthQUNKO1NBQ0osQ0FBQyxFQUNGLFNBQVMsQ0FDWixDQUFDO1FBQ0YsTUFBTSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3BELE1BQU0sWUFBWSxHQUFHLFNBQVMsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDckQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN0RCxNQUFNLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3pFLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxZQUFZLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssUUFBUSxDQUFDLENBQUM7UUFFaEYsb0JBQW9CO1FBQ3BCLE1BQU0sY0FBYyxHQUFHLE1BQU0sT0FBTyxDQUNoQyxJQUFJLEVBQ0osSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUNYLE9BQU8sRUFBRSxLQUFLO1lBQ2QsRUFBRSxFQUFFLENBQUM7WUFDTCxNQUFNLEVBQUUsbUJBQW1CO1lBQzNCLE1BQU0sRUFBRSxFQUFFLElBQUksRUFBRSx3QkFBd0IsRUFBRTtTQUM3QyxDQUFDLEVBQ0YsU0FBUyxDQUNaLENBQUM7UUFDRixNQUFNLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDbkQsTUFBTSxZQUFZLEdBQUcsU0FBUyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwRCxNQUFNLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLHdCQUF3QixDQUFDLENBQUM7UUFDdkUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFFaEUsa0JBQWtCO1FBQ2xCLE1BQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUNuRSxNQUFNLFdBQVcsR0FBRyxNQUFNLE9BQU8sQ0FDN0IsSUFBSSxFQUNKLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDWCxPQUFPLEVBQUUsS0FBSztZQUNkLEVBQUUsRUFBRSxDQUFDO1lBQ0wsTUFBTSxFQUFFLGlCQUFpQjtZQUN6QixNQUFNLEVBQUUsRUFBRSxPQUFPLEVBQUU7U0FDdEIsQ0FBQyxFQUNGLFNBQVMsQ0FDWixDQUFDO1FBQ0YsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDNUQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsd0JBQXdCLENBQUMsQ0FBQztRQUUxRSxjQUFjO1FBQ2QsTUFBTSxZQUFZLEdBQUcsTUFBTSxhQUFhLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQzFELE1BQU0sQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUVqRCxzQkFBc0I7UUFDdEIsTUFBTSxXQUFXLEdBQUcsTUFBTSxPQUFPLENBQzdCLElBQUksRUFDSixJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsQ0FBQyxFQUNoRSxTQUFTLENBQ1osQ0FBQztRQUNGLE1BQU0sQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUVoRCxPQUFPLENBQUMsR0FBRyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7SUFDdEQsQ0FBQztZQUFTLENBQUM7UUFDUCxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDbEIsQ0FBQztBQUNMLENBQUM7QUFFRCxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtJQUNuQixPQUFPLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7SUFDcEQsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNyQixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3BCLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYXNzZXJ0IGZyb20gJ2Fzc2VydCc7XG5pbXBvcnQgKiBhcyBodHRwIGZyb20gJ2h0dHAnO1xuaW1wb3J0IHsgQWRkcmVzc0luZm8gfSBmcm9tICduZXQnO1xuaW1wb3J0IHsgTUNQU2VydmVyIH0gZnJvbSAnLi4vbWNwLXNlcnZlcic7XG5pbXBvcnQgeyBNQ1BTZXJ2ZXJTZXR0aW5ncyB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IENhcGFiaWxpdHlNYXRyaXggfSBmcm9tICcuLi9uZXh0L21vZGVscyc7XG5pbXBvcnQgeyBjcmVhdGVPZmZpY2lhbFRvb2xzIH0gZnJvbSAnLi4vbmV4dC90b29scy9vZmZpY2lhbC10b29scyc7XG5pbXBvcnQgeyBOZXh0VG9vbFJlZ2lzdHJ5IH0gZnJvbSAnLi4vbmV4dC9wcm90b2NvbC90b29sLXJlZ2lzdHJ5JztcbmltcG9ydCB7IE5leHRNY3BSb3V0ZXIgfSBmcm9tICcuLi9uZXh0L3Byb3RvY29sL3JvdXRlcic7XG5cbmludGVyZmFjZSBIdHRwUmVzdWx0IHtcbiAgICBzdGF0dXNDb2RlOiBudW1iZXI7XG4gICAgaGVhZGVyczogaHR0cC5JbmNvbWluZ0h0dHBIZWFkZXJzO1xuICAgIGJvZHk6IHN0cmluZztcbn1cblxuZnVuY3Rpb24gY3JlYXRlTWF0cml4KGF2YWlsYWJsZUtleXM6IHN0cmluZ1tdKTogQ2FwYWJpbGl0eU1hdHJpeCB7XG4gICAgY29uc3QgYnlLZXk6IENhcGFiaWxpdHlNYXRyaXhbJ2J5S2V5J10gPSB7fTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBhdmFpbGFibGVLZXlzKSB7XG4gICAgICAgIGNvbnN0IGZpcnN0RG90ID0ga2V5LmluZGV4T2YoJy4nKTtcbiAgICAgICAgYnlLZXlba2V5XSA9IHtcbiAgICAgICAgICAgIGtleSxcbiAgICAgICAgICAgIGNoYW5uZWw6IGtleS5zbGljZSgwLCBmaXJzdERvdCksXG4gICAgICAgICAgICBtZXRob2Q6IGtleS5zbGljZShmaXJzdERvdCArIDEpLFxuICAgICAgICAgICAgbGF5ZXI6ICdvZmZpY2lhbCcsXG4gICAgICAgICAgICByZWFkb25seTogdHJ1ZSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBrZXksXG4gICAgICAgICAgICBhdmFpbGFibGU6IHRydWUsXG4gICAgICAgICAgICBjaGVja2VkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgIGRldGFpbDogJ29rJ1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAgIGdlbmVyYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIGJ5S2V5LFxuICAgICAgICBzdW1tYXJ5OiB7XG4gICAgICAgICAgICB0b3RhbDogYXZhaWxhYmxlS2V5cy5sZW5ndGgsXG4gICAgICAgICAgICBhdmFpbGFibGU6IGF2YWlsYWJsZUtleXMubGVuZ3RoLFxuICAgICAgICAgICAgdW5hdmFpbGFibGU6IDAsXG4gICAgICAgICAgICBieUxheWVyOiB7XG4gICAgICAgICAgICAgICAgb2ZmaWNpYWw6IHtcbiAgICAgICAgICAgICAgICAgICAgdG90YWw6IGF2YWlsYWJsZUtleXMubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICBhdmFpbGFibGU6IGF2YWlsYWJsZUtleXMubGVuZ3RoXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBleHRlbmRlZDoge1xuICAgICAgICAgICAgICAgICAgICB0b3RhbDogMCxcbiAgICAgICAgICAgICAgICAgICAgYXZhaWxhYmxlOiAwXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBleHBlcmltZW50YWw6IHtcbiAgICAgICAgICAgICAgICAgICAgdG90YWw6IDAsXG4gICAgICAgICAgICAgICAgICAgIGF2YWlsYWJsZTogMFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG59XG5cbmZ1bmN0aW9uIHBvc3RSYXcocG9ydDogbnVtYmVyLCBib2R5OiBzdHJpbmcsIHNlc3Npb25JZD86IHN0cmluZyk6IFByb21pc2U8SHR0cFJlc3VsdD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKHNlc3Npb25JZCkge1xuICAgICAgICAgICAgaGVhZGVyc1snTUNQLVNlc3Npb24tSWQnXSA9IHNlc3Npb25JZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlcSA9IGh0dHAucmVxdWVzdChcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgICAgICBob3N0OiAnMTI3LjAuMC4xJyxcbiAgICAgICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgICAgIHBhdGg6ICcvbWNwJyxcbiAgICAgICAgICAgICAgICBoZWFkZXJzXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBkYXRhID0gJyc7XG4gICAgICAgICAgICAgICAgcmVzLnNldEVuY29kaW5nKCd1dGY4Jyk7XG4gICAgICAgICAgICAgICAgcmVzLm9uKCdkYXRhJywgKGNodW5rKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGEgKz0gY2h1bms7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmVzLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzQ29kZTogcmVzLnN0YXR1c0NvZGUgfHwgMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHJlcy5oZWFkZXJzLFxuICAgICAgICAgICAgICAgICAgICAgICAgYm9keTogZGF0YVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgICByZXEub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICAgICAgcmVxLndyaXRlKGJvZHkpO1xuICAgICAgICByZXEuZW5kKCk7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIGRlbGV0ZVNlc3Npb24ocG9ydDogbnVtYmVyLCBzZXNzaW9uSWQ/OiBzdHJpbmcpOiBQcm9taXNlPEh0dHBSZXN1bHQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBjb25zdCBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG4gICAgICAgIGlmIChzZXNzaW9uSWQpIHtcbiAgICAgICAgICAgIGhlYWRlcnNbJ01DUC1TZXNzaW9uLUlkJ10gPSBzZXNzaW9uSWQ7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXEgPSBodHRwLnJlcXVlc3QoXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbWV0aG9kOiAnREVMRVRFJyxcbiAgICAgICAgICAgICAgICBob3N0OiAnMTI3LjAuMC4xJyxcbiAgICAgICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgICAgIHBhdGg6ICcvbWNwJyxcbiAgICAgICAgICAgICAgICBoZWFkZXJzXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBkYXRhID0gJyc7XG4gICAgICAgICAgICAgICAgcmVzLnNldEVuY29kaW5nKCd1dGY4Jyk7XG4gICAgICAgICAgICAgICAgcmVzLm9uKCdkYXRhJywgKGNodW5rKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGEgKz0gY2h1bms7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmVzLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzQ29kZTogcmVzLnN0YXR1c0NvZGUgfHwgMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHJlcy5oZWFkZXJzLFxuICAgICAgICAgICAgICAgICAgICAgICAgYm9keTogZGF0YVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgICByZXEub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICAgICAgcmVxLmVuZCgpO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBwYXJzZUpzb24oYm9keTogc3RyaW5nKTogYW55IHtcbiAgICBpZiAoIWJvZHkudHJpbSgpKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gSlNPTi5wYXJzZShib2R5KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbWFpbigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzZXR0aW5nczogTUNQU2VydmVyU2V0dGluZ3MgPSB7XG4gICAgICAgIHBvcnQ6IDAsXG4gICAgICAgIGF1dG9TdGFydDogZmFsc2UsXG4gICAgICAgIGVuYWJsZURlYnVnTG9nOiBmYWxzZSxcbiAgICAgICAgYWxsb3dlZE9yaWdpbnM6IFsnKiddLFxuICAgICAgICBtYXhDb25uZWN0aW9uczogMTBcbiAgICB9O1xuXG4gICAgY29uc3QgcmVxdWVzdGVyID0gYXN5bmMgKGNoYW5uZWw6IHN0cmluZywgbWV0aG9kOiBzdHJpbmcsIC4uLmFyZ3M6IGFueVtdKTogUHJvbWlzZTxhbnk+ID0+IHtcbiAgICAgICAgaWYgKGNoYW5uZWwgPT09ICdhc3NldC1kYicgJiYgbWV0aG9kID09PSAncXVlcnktYXNzZXRzJykge1xuICAgICAgICAgICAgcmV0dXJuIFt7IHV1aWQ6ICdhc3NldC0xJywgdXJsOiAnZGI6Ly9hc3NldHMvYS5wcmVmYWInIH1dO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjaGFubmVsID09PSAnYXNzZXQtZGInICYmIG1ldGhvZCA9PT0gJ3F1ZXJ5LWFzc2V0LWluZm8nKSB7XG4gICAgICAgICAgICBjb25zdCBxdWVyeSA9IGFyZ3NbMF07XG4gICAgICAgICAgICBpZiAocXVlcnkgPT09ICdiYWQ6Ly9taXNzaW5nJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignbW9jayBmYWlsdXJlJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4geyB1dWlkOiAnYXNzZXQtMScsIHVybDogU3RyaW5nKHF1ZXJ5KSB9O1xuICAgICAgICB9XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCByZXF1ZXN0OiAke2NoYW5uZWx9LiR7bWV0aG9kfWApO1xuICAgIH07XG5cbiAgICBjb25zdCBzZXJ2ZXIgPSBuZXcgTUNQU2VydmVyKHNldHRpbmdzLCB7XG4gICAgICAgIHNlc3Npb25JZEdlbmVyYXRvcjogKCkgPT4gJ3Nlc3Npb24tZml4ZWQnLFxuICAgICAgICBuZXh0UnVudGltZUZhY3Rvcnk6IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRvb2xzID0gY3JlYXRlT2ZmaWNpYWxUb29scyhyZXF1ZXN0ZXIpO1xuICAgICAgICAgICAgY29uc3QgbWF0cml4ID0gY3JlYXRlTWF0cml4KFtcbiAgICAgICAgICAgICAgICAnYXNzZXQtZGIucXVlcnktYXNzZXRzJyxcbiAgICAgICAgICAgICAgICAnYXNzZXQtZGIucXVlcnktYXNzZXQtaW5mbydcbiAgICAgICAgICAgIF0pO1xuICAgICAgICAgICAgY29uc3QgcmVnaXN0cnkgPSBuZXcgTmV4dFRvb2xSZWdpc3RyeSh0b29scywgbWF0cml4KTtcbiAgICAgICAgICAgIGNvbnN0IHJvdXRlciA9IG5ldyBOZXh0TWNwUm91dGVyKHJlZ2lzdHJ5KTtcbiAgICAgICAgICAgIHJldHVybiB7IHJlZ2lzdHJ5LCByb3V0ZXIgfTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgYXdhaXQgc2VydmVyLnN0YXJ0KCk7XG5cbiAgICBjb25zdCBodHRwU2VydmVyOiBodHRwLlNlcnZlciA9IChzZXJ2ZXIgYXMgYW55KS5odHRwU2VydmVyO1xuICAgIGNvbnN0IGFkZHJlc3MgPSBodHRwU2VydmVyLmFkZHJlc3MoKSBhcyBBZGRyZXNzSW5mbztcbiAgICBjb25zdCBwb3J0ID0gYWRkcmVzcy5wb3J0O1xuXG4gICAgdHJ5IHtcbiAgICAgICAgLy8gMS4g6Z2e5rOVIEpTT04gPT4gLTMyNzAwXG4gICAgICAgIGNvbnN0IHBhcnNlRXJyb3IgPSBhd2FpdCBwb3N0UmF3KHBvcnQsICd7Jyk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChwYXJzZUVycm9yLnN0YXR1c0NvZGUsIDQwMCk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChwYXJzZUpzb24ocGFyc2VFcnJvci5ib2R5KS5lcnJvci5jb2RlLCAtMzI3MDApO1xuXG4gICAgICAgIC8vIDIuIFBPU1QgYmF0Y2gg5LiN5pSv5oyBID0+IC0zMjYwMFxuICAgICAgICBjb25zdCBlbXB0eUJhdGNoID0gYXdhaXQgcG9zdFJhdyhwb3J0LCAnW10nKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGVtcHR5QmF0Y2guc3RhdHVzQ29kZSwgMjAwKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHBhcnNlSnNvbihlbXB0eUJhdGNoLmJvZHkpLmVycm9yLmNvZGUsIC0zMjYwMCk7XG5cbiAgICAgICAgLy8gaW5pdGlhbGl6ZSDlubbmj5Dlj5bkvJror51cbiAgICAgICAgY29uc3QgaW5pdGlhbGl6ZSA9IGF3YWl0IHBvc3RSYXcoXG4gICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgIGlkOiAxLFxuICAgICAgICAgICAgICAgIG1ldGhvZDogJ2luaXRpYWxpemUnLFxuICAgICAgICAgICAgICAgIHBhcmFtczogeyBwcm90b2NvbFZlcnNpb246ICcyMDI1LTExLTI1JyB9XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwoaW5pdGlhbGl6ZS5zdGF0dXNDb2RlLCAyMDApO1xuICAgICAgICBjb25zdCBzZXNzaW9uSWQgPSBpbml0aWFsaXplLmhlYWRlcnNbJ21jcC1zZXNzaW9uLWlkJ10gYXMgc3RyaW5nO1xuICAgICAgICBhc3NlcnQub2soc2Vzc2lvbklkLCAnaW5pdGlhbGl6ZSDlv4Xpobvov5Tlm54gTUNQLVNlc3Npb24tSWQnKTtcblxuICAgICAgICAvLyDnvLrlpLHkvJror53lpLQgPT4gSFRUUCA0MDBcbiAgICAgICAgY29uc3QgbWlzc2luZ0hlYWRlciA9IGF3YWl0IHBvc3RSYXcoXG4gICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoeyBqc29ucnBjOiAnMi4wJywgaWQ6IDIsIG1ldGhvZDogJ3Rvb2xzL2xpc3QnIH0pXG4gICAgICAgICk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChtaXNzaW5nSGVhZGVyLnN0YXR1c0NvZGUsIDQwMCk7XG5cbiAgICAgICAgLy8g5pyqIHJlYWR5IOWJjeiwg+eUqCB0b29scy9saXN0ID0+IC0zMjYwMFxuICAgICAgICBjb25zdCBub3RSZWFkeUxpc3QgPSBhd2FpdCBwb3N0UmF3KFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHsganNvbnJwYzogJzIuMCcsIGlkOiAzLCBtZXRob2Q6ICd0b29scy9saXN0JyB9KSxcbiAgICAgICAgICAgIHNlc3Npb25JZFxuICAgICAgICApO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwobm90UmVhZHlMaXN0LnN0YXR1c0NvZGUsIDIwMCk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChwYXJzZUpzb24obm90UmVhZHlMaXN0LmJvZHkpLmVycm9yLmNvZGUsIC0zMjYwMCk7XG5cbiAgICAgICAgLy8g5a6M5oiQIG5vdGlmaWNhdGlvbnMvaW5pdGlhbGl6ZWRcbiAgICAgICAgY29uc3QgaW5pdGlhbGl6ZWROb3RpZmljYXRpb24gPSBhd2FpdCBwb3N0UmF3KFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHsganNvbnJwYzogJzIuMCcsIG1ldGhvZDogJ25vdGlmaWNhdGlvbnMvaW5pdGlhbGl6ZWQnIH0pLFxuICAgICAgICAgICAgc2Vzc2lvbklkXG4gICAgICAgICk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChpbml0aWFsaXplZE5vdGlmaWNhdGlvbi5zdGF0dXNDb2RlLCAyMDIpO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwoaW5pdGlhbGl6ZWROb3RpZmljYXRpb24uYm9keSwgJycpO1xuXG4gICAgICAgIC8vIOaZrumAmiBub3RpZmljYXRpb24gPT4gMjAyIOS4lOaXoCBib2R5XG4gICAgICAgIGNvbnN0IHByb2dyZXNzTm90aWZpY2F0aW9uID0gYXdhaXQgcG9zdFJhdyhcbiAgICAgICAgICAgIHBvcnQsXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7IGpzb25ycGM6ICcyLjAnLCBtZXRob2Q6ICdub3RpZmljYXRpb25zL3Byb2dyZXNzJywgcGFyYW1zOiB7IHZhbHVlOiAxIH0gfSksXG4gICAgICAgICAgICBzZXNzaW9uSWRcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHByb2dyZXNzTm90aWZpY2F0aW9uLnN0YXR1c0NvZGUsIDIwMik7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChwcm9ncmVzc05vdGlmaWNhdGlvbi5ib2R5LCAnJyk7XG5cbiAgICAgICAgLy8gdG9vbHMvbGlzdCDov5Tlm54gbmV4dCDlt6XlhbflubbluKYgX21ldGFcbiAgICAgICAgY29uc3QgbGlzdFJlc3VsdCA9IGF3YWl0IHBvc3RSYXcoXG4gICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoeyBqc29ucnBjOiAnMi4wJywgaWQ6IDQsIG1ldGhvZDogJ3Rvb2xzL2xpc3QnIH0pLFxuICAgICAgICAgICAgc2Vzc2lvbklkXG4gICAgICAgICk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChsaXN0UmVzdWx0LnN0YXR1c0NvZGUsIDIwMCk7XG4gICAgICAgIGNvbnN0IGxpc3RCb2R5ID0gcGFyc2VKc29uKGxpc3RSZXN1bHQuYm9keSk7XG4gICAgICAgIGFzc2VydC5vayhBcnJheS5pc0FycmF5KGxpc3RCb2R5LnJlc3VsdC50b29scykpO1xuICAgICAgICBhc3NlcnQub2sobGlzdEJvZHkucmVzdWx0LnRvb2xzLmxlbmd0aCA+IDApO1xuICAgICAgICBhc3NlcnQub2sobGlzdEJvZHkucmVzdWx0LnRvb2xzWzBdLl9tZXRhKTtcblxuICAgICAgICAvLyDmnKrnn6Xmlrnms5UgPT4gLTMyNjAxXG4gICAgICAgIGNvbnN0IHVua25vd25NZXRob2QgPSBhd2FpdCBwb3N0UmF3KFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHsganNvbnJwYzogJzIuMCcsIGlkOiA1LCBtZXRob2Q6ICd1bmtub3duL21ldGhvZCcgfSksXG4gICAgICAgICAgICBzZXNzaW9uSWRcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHVua25vd25NZXRob2Quc3RhdHVzQ29kZSwgMjAwKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHBhcnNlSnNvbih1bmtub3duTWV0aG9kLmJvZHkpLmVycm9yLmNvZGUsIC0zMjYwMSk7XG5cbiAgICAgICAgLy8gdG9vbHMvY2FsbCDnvLrlsJEgbmFtZSA9PiAtMzI2MDJcbiAgICAgICAgY29uc3QgbWlzc2luZ05hbWUgPSBhd2FpdCBwb3N0UmF3KFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHsganNvbnJwYzogJzIuMCcsIGlkOiA2LCBtZXRob2Q6ICd0b29scy9jYWxsJywgcGFyYW1zOiB7fSB9KSxcbiAgICAgICAgICAgIHNlc3Npb25JZFxuICAgICAgICApO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwobWlzc2luZ05hbWUuc3RhdHVzQ29kZSwgMjAwKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHBhcnNlSnNvbihtaXNzaW5nTmFtZS5ib2R5KS5lcnJvci5jb2RlLCAtMzI2MDIpO1xuXG4gICAgICAgIC8vIOS4muWKoeWksei0pSA9PiByZXN1bHQuaXNFcnJvciA9IHRydWVcbiAgICAgICAgY29uc3QgYnVzaW5lc3NGYWlsdXJlID0gYXdhaXQgcG9zdFJhdyhcbiAgICAgICAgICAgIHBvcnQsXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAganNvbnJwYzogJzIuMCcsXG4gICAgICAgICAgICAgICAgaWQ6IDcsXG4gICAgICAgICAgICAgICAgbWV0aG9kOiAndG9vbHMvY2FsbCcsXG4gICAgICAgICAgICAgICAgcGFyYW1zOiB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6ICdhc3NldF9xdWVyeV9hc3NldF9pbmZvJyxcbiAgICAgICAgICAgICAgICAgICAgYXJndW1lbnRzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cmxPclV1aWQ6ICdiYWQ6Ly9taXNzaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBzZXNzaW9uSWRcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGJ1c2luZXNzRmFpbHVyZS5zdGF0dXNDb2RlLCAyMDApO1xuICAgICAgICBjb25zdCBidXNpbmVzc0JvZHkgPSBwYXJzZUpzb24oYnVzaW5lc3NGYWlsdXJlLmJvZHkpO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwoYnVzaW5lc3NCb2R5LnJlc3VsdC5pc0Vycm9yLCB0cnVlKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGJ1c2luZXNzQm9keS5yZXN1bHQuc3RydWN0dXJlZENvbnRlbnQuc3VjY2VzcywgZmFsc2UpO1xuICAgICAgICBhc3NlcnQub2sodHlwZW9mIGJ1c2luZXNzQm9keS5yZXN1bHQuc3RydWN0dXJlZENvbnRlbnQuZXJyb3IuY29kZSA9PT0gJ3N0cmluZycpO1xuXG4gICAgICAgIC8vIGdldF90b29sX21hbmlmZXN0XG4gICAgICAgIGNvbnN0IG1hbmlmZXN0UmVzdWx0ID0gYXdhaXQgcG9zdFJhdyhcbiAgICAgICAgICAgIHBvcnQsXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAganNvbnJwYzogJzIuMCcsXG4gICAgICAgICAgICAgICAgaWQ6IDgsXG4gICAgICAgICAgICAgICAgbWV0aG9kOiAnZ2V0X3Rvb2xfbWFuaWZlc3QnLFxuICAgICAgICAgICAgICAgIHBhcmFtczogeyBuYW1lOiAnYXNzZXRfcXVlcnlfYXNzZXRfaW5mbycgfVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBzZXNzaW9uSWRcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKG1hbmlmZXN0UmVzdWx0LnN0YXR1c0NvZGUsIDIwMCk7XG4gICAgICAgIGNvbnN0IG1hbmlmZXN0Qm9keSA9IHBhcnNlSnNvbihtYW5pZmVzdFJlc3VsdC5ib2R5KTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKG1hbmlmZXN0Qm9keS5yZXN1bHQubmFtZSwgJ2Fzc2V0X3F1ZXJ5X2Fzc2V0X2luZm8nKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKG1hbmlmZXN0Qm9keS5yZXN1bHQuX21ldGEubGF5ZXIsICdvZmZpY2lhbCcpO1xuXG4gICAgICAgIC8vIGdldF90cmFjZV9ieV9pZFxuICAgICAgICBjb25zdCB0cmFjZUlkID0gYnVzaW5lc3NCb2R5LnJlc3VsdC5zdHJ1Y3R1cmVkQ29udGVudC5tZXRhLnRyYWNlSWQ7XG4gICAgICAgIGNvbnN0IHRyYWNlUmVzdWx0ID0gYXdhaXQgcG9zdFJhdyhcbiAgICAgICAgICAgIHBvcnQsXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAganNvbnJwYzogJzIuMCcsXG4gICAgICAgICAgICAgICAgaWQ6IDksXG4gICAgICAgICAgICAgICAgbWV0aG9kOiAnZ2V0X3RyYWNlX2J5X2lkJyxcbiAgICAgICAgICAgICAgICBwYXJhbXM6IHsgdHJhY2VJZCB9XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIHNlc3Npb25JZFxuICAgICAgICApO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodHJhY2VSZXN1bHQuc3RhdHVzQ29kZSwgMjAwKTtcbiAgICAgICAgY29uc3QgdHJhY2VCb2R5ID0gcGFyc2VKc29uKHRyYWNlUmVzdWx0LmJvZHkpO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodHJhY2VCb2R5LnJlc3VsdC50cmFjZS50cmFjZUlkLCB0cmFjZUlkKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHRyYWNlQm9keS5yZXN1bHQudHJhY2UudG9vbCwgJ2Fzc2V0X3F1ZXJ5X2Fzc2V0X2luZm8nKTtcblxuICAgICAgICAvLyBERUxFVEUgL21jcFxuICAgICAgICBjb25zdCBkZWxldGVSZXN1bHQgPSBhd2FpdCBkZWxldGVTZXNzaW9uKHBvcnQsIHNlc3Npb25JZCk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChkZWxldGVSZXN1bHQuc3RhdHVzQ29kZSwgMjA0KTtcblxuICAgICAgICAvLyDliKDpmaTkvJror53lkI7or7fmsYIgPT4gSFRUUCA0MDBcbiAgICAgICAgY29uc3QgYWZ0ZXJEZWxldGUgPSBhd2FpdCBwb3N0UmF3KFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHsganNvbnJwYzogJzIuMCcsIGlkOiAxMCwgbWV0aG9kOiAndG9vbHMvbGlzdCcgfSksXG4gICAgICAgICAgICBzZXNzaW9uSWRcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGFmdGVyRGVsZXRlLnN0YXR1c0NvZGUsIDQwMCk7XG5cbiAgICAgICAgY29uc29sZS5sb2coJ21jcC1wcm90b2NvbC1jb21wbGlhbmNlLXRlc3Q6IFBBU1MnKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgICBzZXJ2ZXIuc3RvcCgpO1xuICAgIH1cbn1cblxubWFpbigpLmNhdGNoKChlcnJvcikgPT4ge1xuICAgIGNvbnNvbGUuZXJyb3IoJ21jcC1wcm90b2NvbC1jb21wbGlhbmNlLXRlc3Q6IEZBSUwnKTtcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICBwcm9jZXNzLmV4aXQoMSk7XG59KTtcbiJdfQ==