"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
const assert = __importStar(require("assert"));
const http = __importStar(require("http"));
const mcp_server_1 = require("../mcp-server");
const official_tools_1 = require("../next/tools/official-tools");
const tool_registry_1 = require("../next/protocol/tool-registry");
const router_1 = require("../next/protocol/router");
function createMatrix(availableKeys) {
    const byKey = {};
    for (const key of availableKeys) {
        const firstDot = key.indexOf('.');
        byKey[key] = {
            key,
            channel: key.slice(0, firstDot),
            method: key.slice(firstDot + 1),
            layer: 'official',
            readonly: true,
            description: key,
            available: true,
            checkedAt: new Date().toISOString(),
            detail: 'ok'
        };
    }
    return {
        generatedAt: new Date().toISOString(),
        byKey,
        summary: {
            total: availableKeys.length,
            available: availableKeys.length,
            unavailable: 0,
            byLayer: {
                official: {
                    total: availableKeys.length,
                    available: availableKeys.length
                },
                extended: {
                    total: 0,
                    available: 0
                },
                experimental: {
                    total: 0,
                    available: 0
                }
            }
        }
    };
}
function postJson(port, payload, sessionId) {
    const body = JSON.stringify(payload);
    return new Promise((resolve, reject) => {
        const headers = {
            'Content-Type': 'application/json'
        };
        if (sessionId) {
            headers['MCP-Session-Id'] = sessionId;
        }
        const req = http.request({
            method: 'POST',
            host: '127.0.0.1',
            port,
            path: '/mcp',
            headers
        }, (res) => {
            let data = '';
            res.setEncoding('utf8');
            res.on('data', (chunk) => {
                data += chunk;
            });
            res.on('end', () => {
                resolve({
                    statusCode: res.statusCode || 0,
                    headers: res.headers,
                    body: data
                });
            });
        });
        req.on('error', reject);
        req.write(body);
        req.end();
    });
}
function parseJson(body) {
    return JSON.parse(body);
}
async function main() {
    const settings = {
        port: 0,
        autoStart: false,
        enableDebugLog: false,
        allowedOrigins: ['*'],
        maxConnections: 10
    };
    const requester = async (channel, method, ..._args) => {
        if (channel === 'asset-db' && method === 'query-assets') {
            return [
                { url: 'db://assets/a.prefab', uuid: 'uuid-a' },
                { url: 'db://assets/b.prefab', uuid: 'uuid-b' }
            ];
        }
        throw new Error(`Unexpected request: ${channel}.${method}`);
    };
    const server = new mcp_server_1.MCPServer(settings, {
        sessionIdGenerator: () => 'session-manifest',
        nextRuntimeFactory: async () => {
            const tools = (0, official_tools_1.createOfficialTools)(requester);
            const matrix = createMatrix(['asset-db.query-assets']);
            const registry = new tool_registry_1.NextToolRegistry(tools, matrix);
            const router = new router_1.NextMcpRouter(registry);
            return { registry, router };
        }
    });
    await server.start();
    const httpServer = server.httpServer;
    const address = httpServer.address();
    const port = address.port;
    try {
        const initialize = await postJson(port, {
            jsonrpc: '2.0',
            id: 1,
            method: 'initialize',
            params: { protocolVersion: '2025-11-25' }
        });
        assert.strictEqual(initialize.statusCode, 200);
        const sessionId = initialize.headers['mcp-session-id'];
        assert.ok(sessionId);
        const initialized = await postJson(port, { jsonrpc: '2.0', method: 'notifications/initialized' }, sessionId);
        assert.strictEqual(initialized.statusCode, 202);
        const toolsList = await postJson(port, { jsonrpc: '2.0', id: 2, method: 'tools/list' }, sessionId);
        assert.strictEqual(toolsList.statusCode, 200);
        const toolsListBody = parseJson(toolsList.body);
        const tools = toolsListBody.result.tools;
        const assetQueryTool = tools.find((item) => item.name === 'asset_query_assets');
        assert.ok(assetQueryTool, 'tools/list 中必须包含 asset_query_assets');
        assert.ok(assetQueryTool._meta, 'tools/list 中的工具必须包含 _meta');
        assert.strictEqual(assetQueryTool._meta.layer, 'official');
        const manifest = await postJson(port, {
            jsonrpc: '2.0',
            id: 3,
            method: 'get_tool_manifest',
            params: { name: 'asset_query_assets' }
        }, sessionId);
        assert.strictEqual(manifest.statusCode, 200);
        const manifestBody = parseJson(manifest.body);
        assert.strictEqual(manifestBody.result.name, 'asset_query_assets');
        assert.strictEqual(manifestBody.result._meta.layer, 'official');
        assert.strictEqual(manifestBody.result._meta.supportsDryRun, false);
        assert.ok(Array.isArray(manifestBody.result.requiredCapabilities));
        assert.ok(manifestBody.result.requiredCapabilities.includes('asset-db.query-assets'));
        const toolCall = await postJson(port, {
            jsonrpc: '2.0',
            id: 4,
            method: 'tools/call',
            params: {
                name: 'asset_query_assets',
                arguments: {
                    pattern: 'db://assets/**/*.prefab'
                }
            }
        }, sessionId);
        assert.strictEqual(toolCall.statusCode, 200);
        const toolCallBody = parseJson(toolCall.body);
        assert.strictEqual(toolCallBody.result.isError, false);
        assert.strictEqual(toolCallBody.result.structuredContent.success, true);
        assert.strictEqual(toolCallBody.result.structuredContent.meta.tool, 'asset_query_assets');
        assert.ok(typeof toolCallBody.result.structuredContent.meta.traceId === 'string');
        assert.strictEqual(toolCallBody.result.structuredContent.data.count, 2);
        const traceQuery = await postJson(port, {
            jsonrpc: '2.0',
            id: 5,
            method: 'get_trace_by_id',
            params: {
                traceId: toolCallBody.result.structuredContent.meta.traceId
            }
        }, sessionId);
        assert.strictEqual(traceQuery.statusCode, 200);
        const traceBody = parseJson(traceQuery.body);
        assert.strictEqual(traceBody.result.trace.tool, 'asset_query_assets');
        console.log('next-manifest-test: PASS');
    }
    finally {
        server.stop();
    }
}
main().catch((error) => {
    console.error('next-manifest-test: FAIL');
    console.error(error);
    process.exit(1);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmV4dC1tYW5pZmVzdC10ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc291cmNlL3Rlc3QvbmV4dC1tYW5pZmVzdC10ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsK0NBQWlDO0FBQ2pDLDJDQUE2QjtBQUU3Qiw4Q0FBMEM7QUFHMUMsaUVBQW1FO0FBQ25FLGtFQUFrRTtBQUNsRSxvREFBd0Q7QUFReEQsU0FBUyxZQUFZLENBQUMsYUFBdUI7SUFDekMsTUFBTSxLQUFLLEdBQThCLEVBQUUsQ0FBQztJQUM1QyxLQUFLLE1BQU0sR0FBRyxJQUFJLGFBQWEsRUFBRSxDQUFDO1FBQzlCLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbEMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHO1lBQ1QsR0FBRztZQUNILE9BQU8sRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxRQUFRLENBQUM7WUFDL0IsTUFBTSxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQztZQUMvQixLQUFLLEVBQUUsVUFBVTtZQUNqQixRQUFRLEVBQUUsSUFBSTtZQUNkLFdBQVcsRUFBRSxHQUFHO1lBQ2hCLFNBQVMsRUFBRSxJQUFJO1lBQ2YsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1lBQ25DLE1BQU0sRUFBRSxJQUFJO1NBQ2YsQ0FBQztJQUNOLENBQUM7SUFFRCxPQUFPO1FBQ0gsV0FBVyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1FBQ3JDLEtBQUs7UUFDTCxPQUFPLEVBQUU7WUFDTCxLQUFLLEVBQUUsYUFBYSxDQUFDLE1BQU07WUFDM0IsU0FBUyxFQUFFLGFBQWEsQ0FBQyxNQUFNO1lBQy9CLFdBQVcsRUFBRSxDQUFDO1lBQ2QsT0FBTyxF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QUMsQ0FBQztRQUV0RSxPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUEwQixDQUFDLENBQUM7SUFDNUMsQ0FBQztZQUFTLENBQUM7UUFDUCxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDbEIsQ0FBQztBQUNMLENBQUM7QUFFRCxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtJQUNuQixPQUFPLENBQUMsS0FBSyxDQUFDLDBCQUEwQixDQUFDLENBQUM7SUFDMUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNyQixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3BCLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYXNzZXJ0IGZyb20gJ2Fzc2VydCc7XG5pbXBvcnQgKiBhcyBodHRwIGZyb20gJ2h0dHAnO1xuaW1wb3J0IHsgQWRkcmVzc0luZm8gfSBmcm9tICduZXQnO1xuaW1wb3J0IHsgTUNQU2VydmVyIH0gZnJvbSAnLi4vbWNwLXNlcnZlcic7XG5pbXBvcnQgeyBNQ1BTZXJ2ZXJTZXR0aW5ncyB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IENhcGFiaWxpdHlNYXRyaXggfSBmcm9tICcuLi9uZXh0L21vZGVscyc7XG5pbXBvcnQgeyBjcmVhdGVPZmZpY2lhbFRvb2xzIH0gZnJvbSAnLi4vbmV4dC90b29scy9vZmZpY2lhbC10b29scyc7XG5pbXBvcnQgeyBOZXh0VG9vbFJlZ2lzdHJ5IH0gZnJvbSAnLi4vbmV4dC9wcm90b2NvbC90b29sLXJlZ2lzdHJ5JztcbmltcG9ydCB7IE5leHRNY3BSb3V0ZXIgfSBmcm9tICcuLi9uZXh0L3Byb3RvY29sL3JvdXRlcic7XG5cbmludGVyZmFjZSBIdHRwUmVzdWx0IHtcbiAgICBzdGF0dXNDb2RlOiBudW1iZXI7XG4gICAgaGVhZGVyczogaHR0cC5JbmNvbWluZ0h0dHBIZWFkZXJzO1xuICAgIGJvZHk6IHN0cmluZztcbn1cblxuZnVuY3Rpb24gY3JlYXRlTWF0cml4KGF2YWlsYWJsZUtleXM6IHN0cmluZ1tdKTogQ2FwYWJpbGl0eU1hdHJpeCB7XG4gICAgY29uc3QgYnlLZXk6IENhcGFiaWxpdHlNYXRyaXhbJ2J5S2V5J10gPSB7fTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBhdmFpbGFibGVLZXlzKSB7XG4gICAgICAgIGNvbnN0IGZpcnN0RG90ID0ga2V5LmluZGV4T2YoJy4nKTtcbiAgICAgICAgYnlLZXlba2V5XSA9IHtcbiAgICAgICAgICAgIGtleSxcbiAgICAgICAgICAgIGNoYW5uZWw6IGtleS5zbGljZSgwLCBmaXJzdERvdCksXG4gICAgICAgICAgICBtZXRob2Q6IGtleS5zbGljZShmaXJzdERvdCArIDEpLFxuICAgICAgICAgICAgbGF5ZXI6ICdvZmZpY2lhbCcsXG4gICAgICAgICAgICByZWFkb25seTogdHJ1ZSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBrZXksXG4gICAgICAgICAgICBhdmFpbGFibGU6IHRydWUsXG4gICAgICAgICAgICBjaGVja2VkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgIGRldGFpbDogJ29rJ1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAgIGdlbmVyYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIGJ5S2V5LFxuICAgICAgICBzdW1tYXJ5OiB7XG4gICAgICAgICAgICB0b3RhbDogYXZhaWxhYmxlS2V5cy5sZW5ndGgsXG4gICAgICAgICAgICBhdmFpbGFibGU6IGF2YWlsYWJsZUtleXMubGVuZ3RoLFxuICAgICAgICAgICAgdW5hdmFpbGFibGU6IDAsXG4gICAgICAgICAgICBieUxheWVyOiB7XG4gICAgICAgICAgICAgICAgb2ZmaWNpYWw6IHtcbiAgICAgICAgICAgICAgICAgICAgdG90YWw6IGF2YWlsYWJsZUtleXMubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICBhdmFpbGFibGU6IGF2YWlsYWJsZUtleXMubGVuZ3RoXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBleHRlbmRlZDoge1xuICAgICAgICAgICAgICAgICAgICB0b3RhbDogMCxcbiAgICAgICAgICAgICAgICAgICAgYXZhaWxhYmxlOiAwXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBleHBlcmltZW50YWw6IHtcbiAgICAgICAgICAgICAgICAgICAgdG90YWw6IDAsXG4gICAgICAgICAgICAgICAgICAgIGF2YWlsYWJsZTogMFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG59XG5cbmZ1bmN0aW9uIHBvc3RKc29uKHBvcnQ6IG51bWJlciwgcGF5bG9hZDogdW5rbm93biwgc2Vzc2lvbklkPzogc3RyaW5nKTogUHJvbWlzZTxIdHRwUmVzdWx0PiB7XG4gICAgY29uc3QgYm9keSA9IEpTT04uc3RyaW5naWZ5KHBheWxvYWQpO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgaGVhZGVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoc2Vzc2lvbklkKSB7XG4gICAgICAgICAgICBoZWFkZXJzWydNQ1AtU2Vzc2lvbi1JZCddID0gc2Vzc2lvbklkO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVxID0gaHR0cC5yZXF1ZXN0KFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAgICAgIGhvc3Q6ICcxMjcuMC4wLjEnLFxuICAgICAgICAgICAgICAgIHBvcnQsXG4gICAgICAgICAgICAgICAgcGF0aDogJy9tY3AnLFxuICAgICAgICAgICAgICAgIGhlYWRlcnNcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAocmVzKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGRhdGEgPSAnJztcbiAgICAgICAgICAgICAgICByZXMuc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcbiAgICAgICAgICAgICAgICByZXMub24oJ2RhdGEnLCAoY2h1bmspID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YSArPSBjaHVuaztcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXMub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXNDb2RlOiByZXMuc3RhdHVzQ29kZSB8fCAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogcmVzLmhlYWRlcnMsXG4gICAgICAgICAgICAgICAgICAgICAgICBib2R5OiBkYXRhXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIHJlcS5vbignZXJyb3InLCByZWplY3QpO1xuICAgICAgICByZXEud3JpdGUoYm9keSk7XG4gICAgICAgIHJlcS5lbmQoKTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gcGFyc2VKc29uKGJvZHk6IHN0cmluZyk6IGFueSB7XG4gICAgcmV0dXJuIEpTT04ucGFyc2UoYm9keSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIG1haW4oKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qgc2V0dGluZ3M6IE1DUFNlcnZlclNldHRpbmdzID0ge1xuICAgICAgICBwb3J0OiAwLFxuICAgICAgICBhdXRvU3RhcnQ6IGZhbHNlLFxuICAgICAgICBlbmFibGVEZWJ1Z0xvZzogZmFsc2UsXG4gICAgICAgIGFsbG93ZWRPcmlnaW5zOiBbJyonXSxcbiAgICAgICAgbWF4Q29ubmVjdGlvbnM6IDEwXG4gICAgfTtcblxuICAgIGNvbnN0IHJlcXVlc3RlciA9IGFzeW5jIChjaGFubmVsOiBzdHJpbmcsIG1ldGhvZDogc3RyaW5nLCAuLi5fYXJnczogYW55W10pOiBQcm9taXNlPGFueT4gPT4ge1xuICAgICAgICBpZiAoY2hhbm5lbCA9PT0gJ2Fzc2V0LWRiJyAmJiBtZXRob2QgPT09ICdxdWVyeS1hc3NldHMnKSB7XG4gICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICAgIHsgdXJsOiAnZGI6Ly9hc3NldHMvYS5wcmVmYWInLCB1dWlkOiAndXVpZC1hJyB9LFxuICAgICAgICAgICAgICAgIHsgdXJsOiAnZGI6Ly9hc3NldHMvYi5wcmVmYWInLCB1dWlkOiAndXVpZC1iJyB9XG4gICAgICAgICAgICBdO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCByZXF1ZXN0OiAke2NoYW5uZWx9LiR7bWV0aG9kfWApO1xuICAgIH07XG5cbiAgICBjb25zdCBzZXJ2ZXIgPSBuZXcgTUNQU2VydmVyKHNldHRpbmdzLCB7XG4gICAgICAgIHNlc3Npb25JZEdlbmVyYXRvcjogKCkgPT4gJ3Nlc3Npb24tbWFuaWZlc3QnLFxuICAgICAgICBuZXh0UnVudGltZUZhY3Rvcnk6IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRvb2xzID0gY3JlYXRlT2ZmaWNpYWxUb29scyhyZXF1ZXN0ZXIpO1xuICAgICAgICAgICAgY29uc3QgbWF0cml4ID0gY3JlYXRlTWF0cml4KFsnYXNzZXQtZGIucXVlcnktYXNzZXRzJ10pO1xuICAgICAgICAgICAgY29uc3QgcmVnaXN0cnkgPSBuZXcgTmV4dFRvb2xSZWdpc3RyeSh0b29scywgbWF0cml4KTtcbiAgICAgICAgICAgIGNvbnN0IHJvdXRlciA9IG5ldyBOZXh0TWNwUm91dGVyKHJlZ2lzdHJ5KTtcbiAgICAgICAgICAgIHJldHVybiB7IHJlZ2lzdHJ5LCByb3V0ZXIgfTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgYXdhaXQgc2VydmVyLnN0YXJ0KCk7XG5cbiAgICBjb25zdCBodHRwU2VydmVyOiBodHRwLlNlcnZlciA9IChzZXJ2ZXIgYXMgYW55KS5odHRwU2VydmVyO1xuICAgIGNvbnN0IGFkZHJlc3MgPSBodHRwU2VydmVyLmFkZHJlc3MoKSBhcyBBZGRyZXNzSW5mbztcbiAgICBjb25zdCBwb3J0ID0gYWRkcmVzcy5wb3J0O1xuXG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgaW5pdGlhbGl6ZSA9IGF3YWl0IHBvc3RKc29uKHBvcnQsIHtcbiAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgaWQ6IDEsXG4gICAgICAgICAgICBtZXRob2Q6ICdpbml0aWFsaXplJyxcbiAgICAgICAgICAgIHBhcmFtczogeyBwcm90b2NvbFZlcnNpb246ICcyMDI1LTExLTI1JyB9XG4gICAgICAgIH0pO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwoaW5pdGlhbGl6ZS5zdGF0dXNDb2RlLCAyMDApO1xuICAgICAgICBjb25zdCBzZXNzaW9uSWQgPSBpbml0aWFsaXplLmhlYWRlcnNbJ21jcC1zZXNzaW9uLWlkJ10gYXMgc3RyaW5nO1xuICAgICAgICBhc3NlcnQub2soc2Vzc2lvbklkKTtcblxuICAgICAgICBjb25zdCBpbml0aWFsaXplZCA9IGF3YWl0IHBvc3RKc29uKFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIHsganNvbnJwYzogJzIuMCcsIG1ldGhvZDogJ25vdGlmaWNhdGlvbnMvaW5pdGlhbGl6ZWQnIH0sXG4gICAgICAgICAgICBzZXNzaW9uSWRcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGluaXRpYWxpemVkLnN0YXR1c0NvZGUsIDIwMik7XG5cbiAgICAgICAgY29uc3QgdG9vbHNMaXN0ID0gYXdhaXQgcG9zdEpzb24oXG4gICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgeyBqc29ucnBjOiAnMi4wJywgaWQ6IDIsIG1ldGhvZDogJ3Rvb2xzL2xpc3QnIH0sXG4gICAgICAgICAgICBzZXNzaW9uSWRcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHRvb2xzTGlzdC5zdGF0dXNDb2RlLCAyMDApO1xuICAgICAgICBjb25zdCB0b29sc0xpc3RCb2R5ID0gcGFyc2VKc29uKHRvb2xzTGlzdC5ib2R5KTtcbiAgICAgICAgY29uc3QgdG9vbHMgPSB0b29sc0xpc3RCb2R5LnJlc3VsdC50b29scyBhcyBBcnJheTxhbnk+O1xuICAgICAgICBjb25zdCBhc3NldFF1ZXJ5VG9vbCA9IHRvb2xzLmZpbmQoKGl0ZW0pID0+IGl0ZW0ubmFtZSA9PT0gJ2Fzc2V0X3F1ZXJ5X2Fzc2V0cycpO1xuICAgICAgICBhc3NlcnQub2soYXNzZXRRdWVyeVRvb2wsICd0b29scy9saXN0IOS4reW/hemhu+WMheWQqyBhc3NldF9xdWVyeV9hc3NldHMnKTtcbiAgICAgICAgYXNzZXJ0Lm9rKGFzc2V0UXVlcnlUb29sLl9tZXRhLCAndG9vbHMvbGlzdCDkuK3nmoTlt6Xlhbflv4XpobvljIXlkKsgX21ldGEnKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGFzc2V0UXVlcnlUb29sLl9tZXRhLmxheWVyLCAnb2ZmaWNpYWwnKTtcblxuICAgICAgICBjb25zdCBtYW5pZmVzdCA9IGF3YWl0IHBvc3RKc29uKFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgICAgICAgICAgICBpZDogMyxcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdnZXRfdG9vbF9tYW5pZmVzdCcsXG4gICAgICAgICAgICAgICAgcGFyYW1zOiB7IG5hbWU6ICdhc3NldF9xdWVyeV9hc3NldHMnIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzZXNzaW9uSWRcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKG1hbmlmZXN0LnN0YXR1c0NvZGUsIDIwMCk7XG4gICAgICAgIGNvbnN0IG1hbmlmZXN0Qm9keSA9IHBhcnNlSnNvbihtYW5pZmVzdC5ib2R5KTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKG1hbmlmZXN0Qm9keS5yZXN1bHQubmFtZSwgJ2Fzc2V0X3F1ZXJ5X2Fzc2V0cycpO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwobWFuaWZlc3RCb2R5LnJlc3VsdC5fbWV0YS5sYXllciwgJ29mZmljaWFsJyk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChtYW5pZmVzdEJvZHkucmVzdWx0Ll9tZXRhLnN1cHBvcnRzRHJ5UnVuLCBmYWxzZSk7XG4gICAgICAgIGFzc2VydC5vayhBcnJheS5pc0FycmF5KG1hbmlmZXN0Qm9keS5yZXN1bHQucmVxdWlyZWRDYXBhYmlsaXRpZXMpKTtcbiAgICAgICAgYXNzZXJ0Lm9rKG1hbmlmZXN0Qm9keS5yZXN1bHQucmVxdWlyZWRDYXBhYmlsaXRpZXMuaW5jbHVkZXMoJ2Fzc2V0LWRiLnF1ZXJ5LWFzc2V0cycpKTtcblxuICAgICAgICBjb25zdCB0b29sQ2FsbCA9IGF3YWl0IHBvc3RKc29uKFxuICAgICAgICAgICAgcG9ydCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgICAgICAgICAgICBpZDogNCxcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICd0b29scy9jYWxsJyxcbiAgICAgICAgICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ2Fzc2V0X3F1ZXJ5X2Fzc2V0cycsXG4gICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50czoge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybjogJ2RiOi8vYXNzZXRzLyoqLyoucHJlZmFiJ1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNlc3Npb25JZFxuICAgICAgICApO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodG9vbENhbGwuc3RhdHVzQ29kZSwgMjAwKTtcbiAgICAgICAgY29uc3QgdG9vbENhbGxCb2R5ID0gcGFyc2VKc29uKHRvb2xDYWxsLmJvZHkpO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodG9vbENhbGxCb2R5LnJlc3VsdC5pc0Vycm9yLCBmYWxzZSk7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbCh0b29sQ2FsbEJvZHkucmVzdWx0LnN0cnVjdHVyZWRDb250ZW50LnN1Y2Nlc3MsIHRydWUpO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodG9vbENhbGxCb2R5LnJlc3VsdC5zdHJ1Y3R1cmVkQ29udGVudC5tZXRhLnRvb2wsICdhc3NldF9xdWVyeV9hc3NldHMnKTtcbiAgICAgICAgYXNzZXJ0Lm9rKHR5cGVvZiB0b29sQ2FsbEJvZHkucmVzdWx0LnN0cnVjdHVyZWRDb250ZW50Lm1ldGEudHJhY2VJZCA9PT0gJ3N0cmluZycpO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodG9vbENhbGxCb2R5LnJlc3VsdC5zdHJ1Y3R1cmVkQ29udGVudC5kYXRhLmNvdW50LCAyKTtcblxuICAgICAgICBjb25zdCB0cmFjZVF1ZXJ5ID0gYXdhaXQgcG9zdEpzb24oXG4gICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgIGlkOiA1LFxuICAgICAgICAgICAgICAgIG1ldGhvZDogJ2dldF90cmFjZV9ieV9pZCcsXG4gICAgICAgICAgICAgICAgcGFyYW1zOiB7XG4gICAgICAgICAgICAgICAgICAgIHRyYWNlSWQ6IHRvb2xDYWxsQm9keS5yZXN1bHQuc3RydWN0dXJlZENvbnRlbnQubWV0YS50cmFjZUlkXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNlc3Npb25JZFxuICAgICAgICApO1xuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodHJhY2VRdWVyeS5zdGF0dXNDb2RlLCAyMDApO1xuICAgICAgICBjb25zdCB0cmFjZUJvZHkgPSBwYXJzZUpzb24odHJhY2VRdWVyeS5ib2R5KTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHRyYWNlQm9keS5yZXN1bHQudHJhY2UudG9vbCwgJ2Fzc2V0X3F1ZXJ5X2Fzc2V0cycpO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKCduZXh0LW1hbmlmZXN0LXRlc3Q6IFBBU1MnKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgICBzZXJ2ZXIuc3RvcCgpO1xuICAgIH1cbn1cblxubWFpbigpLmNhdGNoKChlcnJvcikgPT4ge1xuICAgIGNvbnNvbGUuZXJyb3IoJ25leHQtbWFuaWZlc3QtdGVzdDogRkFJTCcpO1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIHByb2Nlc3MuZXhpdCgxKTtcbn0pO1xuIl19